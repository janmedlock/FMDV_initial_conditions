\documentclass[USenglish]{article}

\usepackage[T1]{fontenc}
\usepackage{textcomp}
\usepackage{babel}
\usepackage[utf8]{inputenc}
\usepackage[babel=true]{microtype}
\usepackage{geometry}
\usepackage{lmodern}
\usepackage{datetime2}
\usepackage{amsmath}
% Allow more than 26 subequations.
\usepackage{alphalph}
\renewcommand{\alph}[1]{\alphalph{\value{#1}}}
% Use Arabic numbers for subequation labels.
\usepackage{etoolbox}
\patchcmd{\subequations}{\alph{equation}}{.\arabic{equation}}{}{}
% Format \paragraph and \subparagraph like \section levels.
\usepackage{titlesec}
\setcounter{secnumdepth}{5}
\setcounter{tocdepth}{5}
\titleformat{\paragraph}{\normalfont\normalsize\bfseries}{\theparagraph}{1em}{}
\titlespacing*{\paragraph}{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}
\titleformat{\subparagraph}{\normalfont\normalsize\bfseries}{\thesubparagraph}{1em}{}
\titlespacing*{\subparagraph}{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}
\usepackage{units}
\usepackage{multirow}
\usepackage{csquotes}
\usepackage[bibstyle=authoryear,citestyle=authoryear-comp]{biblatex}
\usepackage[pdfborderstyle={/S/U/W 1}]{hyperref}

\addbibresource{notes.bib}

\DeclareMathOperator{\Prob}{Prob}
\renewcommand{\vec}[1]{\boldsymbol{\mathrm{#1}}}
\newcommand{\mat}[1]{\mathbf{#1}}
\newcommand{\md}{\mathrm{d}}
\newcommand{\me}{\mathrm{e}}

\allowdisplaybreaks[1]


\title{
  The Crank--Nicolson method for a periodically forced MSEIR
  model with age and time-since-entry structure
}
\author{Jan Medlock}


\begin{document}

\maketitle


\section{Model parameters}

Many of the models' parameters are hazards from waiting times that are
gamma random variables. The infection-related parameters except waning
depend on FMDV serotype (\autoref{infection_parameters}).


\begin{table}
  \centering
  \begin{tabular}{|c|rr|r|rr|rr|}
    \hline
    \multirow{2}{*}{\textbf{serotype}}
    & \multicolumn{2}{|c|}{\textbf{waning}}
    & \multirow{2}{*}{\textbf{transmission}}
    & \multicolumn{2}{|c|}{\textbf{progression}}
    & \multicolumn{2}{|c|}{\textbf{recovery}}
    \\
    & \textbf{mean} & \textbf{shape}
    &
    & \textbf{mean} & \textbf{shape}
    & \textbf{mean} & \textbf{shape}
    \\
    \hline
    SAT1
    & \unit[0.37]{d} & 1.19
    & \unit[2.8]{d$^{-1}$}
    & \unit[0.5]{d} & 1.2
    & \unit[5.7]{d} & 11.8
    \\
    SAT2
    & \unit[0.37]{d} & 1.19
    & \unit[1.6]{d$^{-1}$}
    & \unit[1.3]{d} & 1.6
    & \unit[4.6]{d} & 8.7
    \\
    SAT3
    & \unit[0.37]{d} & 1.19
    & \unit[1.2]{d$^{-1}$}
    & \unit[2.8]{d} & 1.6
    & \unit[4.2]{d} & 11.8
    \\
    \hline
  \end{tabular}
  \caption{The infection-related parameters by serotype. Waning,
    progression, and recovery are based on waiting times with the
    given means and shapes. Waning mean and shape do not vary by
    serotype.}
  \label{infection_parameters}
\end{table}


\subsection{Death}

The death rate is the piecewise-linear function
\begin{equation}
  \begin{split}
    \mu(a)
    =
    \begin{cases}
      - a_{\mathrm{y}} \log 0.66
      & \text{if $a < \unit[1]{y}$},
      \\
      - \log 0.66
      - \left(a_{\mathrm{y}} - 1\right) \log 0.79
      & \text{if $\unit[1]{y} \leq a < \unit[3]{y}$},
      \\
      - \log 0.66
      - 2 \log 0.79
      - \left(a_{\mathrm{y}} - 3\right) \log 0.88
      & \text{if $\unit[3]{y} \leq a < \unit[12]{y}$},
      \\
      - \log 0.66
      - 2 \log 0.79
      - 9 \log 0.88
      - \left(a_{\mathrm{y}} - 12\right) \log 0.66
      & \text{if $a \geq \unit[12]{y}$},
    \end{cases}
  \end{split}
\end{equation}
where $a_{\mathrm{y}} = \frac{a}{\unit[1]{y}}$ is years of age.

For the models without age structure, I used the mean death rate
over the population stable age distribution
(\autoref{appendix_Floquet_theory}),
\begin{equation}
  \mu = \bar{\mu} = \int_0^{+ \infty} \mu(a) \tilde{N}(a) \md a.
\end{equation}


\subsection{Birth}

All of the models use the periodic birth rate
\begin{subequations}
  \label{birth_rate}
  \begin{equation}
    b(t) = \tilde{b} \left[
      1 + \sigma \sqrt{2} \cos\left(2 \pi t / T\right)
    \right],
  \end{equation}
  with period
  \begin{equation}
    T = \unit[1]{y},
  \end{equation}
  and coefficient of variation
  \begin{equation}
    \sigma = 0.613.
  \end{equation}
\end{subequations}
As I show for each model, the mean birth rate $\tilde{b}$ was chosen so
that the total population is periodic in time.


\subsubsection{Maternity}

Menarche in buffaloes occurs at approximately 4 years of
age. Maternity is therefore the piecewise constant function
\begin{equation}
  \nu(a) =
  \begin{cases}
    0 & \text{if $a < \unit[4]{y}$}, \\
    1 & \text{if $a \geq \unit[4]{y}$}.
  \end{cases}
\end{equation}

For the models without age structure, there is no maternity parameter.


\subsection{Waning}

The waning rate is the hazard of a gamma random variable with
mean $\hat{\omega}$ and shape $\omega_{\mathrm{shape}}$,
\begin{equation}
  \omega(z) =
  h_{\Gamma}\left(z;
                 \omega_{\mathrm{shape}},
                 \frac{\hat{\omega}}{\omega_{\mathrm{shape}}}\right),
\end{equation}
where the hazard for the gamma random variable with shape
$\alpha$ and scale $\theta$ is
\begin{subequations}
  \label{gamma_hazard}
  \begin{equation}
    h_{\Gamma}(x; \alpha, \theta) =
    \frac{
      x^{\alpha - 1} \me^{- x / \theta}
    }{
      \theta^{\alpha} \Gamma\left(\alpha, \frac{x}{\theta}\right)
    },
  \end{equation}
  with $\Gamma(\alpha, x)$ the upper incomplete gamma function,
  \begin{equation}
    \Gamma(\alpha, x)
    = \int_x^{+ \infty} t^{s -1} \me^{-t} \md t.
  \end{equation}
\end{subequations}

For the models without time-since-entry structure, I used the mean
waning rate, $\omega = \hat{\omega}$.


\subsection{Transmission}

The transmission rate is the scalar $\beta$.


\subsection{Progression}

The progression rate is the hazard of a gamma random variable with
mean $\hat{\rho}$ and shape $\rho_{\mathrm{shape}}$,
\begin{equation}
  \rho(z) =
  h_{\Gamma}\left(z;
                 \rho_{\mathrm{shape}},
                 \frac{\hat{\rho}}{\rho_{\mathrm{shape}}}\right).
\end{equation}

For the models without time-since-entry structure, I used the mean
progression rate, $\rho = \hat{\rho}$.


\subsection{Recovery}

The recovery rate is the hazard of a gamma random variable with mean
$\hat{\gamma}$ and shape $\gamma_{\mathrm{shape}}$,
\begin{equation}
  \gamma(z) =
  h_{\Gamma}\left(z;
                 \gamma_{\mathrm{shape}},
                 \frac{\hat{\gamma}}{\gamma_{\mathrm{shape}}}\right).
\end{equation}

For the models without time-since-entry structure, I used the mean
recovery rate, $\gamma = \hat{\gamma}$.


\section{Unstructured model}

The model is
\begin{subequations}
  \label{model_unstructured}
  \begin{align}
    \frac{\md}{\md t} M(t) &=
    b(t) R(t) - \omega M(t) - \mu M(t),
    \\
    \frac{\md}{\md t} S(t) &=
    b(t) \left[N(t) - R(t)\right] + \omega M(t) - \lambda(t) S(t)
    - \mu S(t),
    \\
    \frac{\md}{\md t} E(t) &=
    \lambda(t) S(t) - \hat{\rho} E(t) - \mu E(t),
    \\
    \frac{\md}{\md t} I(t) &=
    \rho E(t) - \gamma I(t) - \mu I(t),
    \\
    \frac{\md}{\md t} R(t) &=
    \gamma I(t) - \mu R(t),
  \end{align}
  with force of infection
  \begin{equation}
    \lambda(t) = \beta I(t),
  \end{equation}
  population size
  \begin{equation}
    N(t) = M(t) + S(t) + E(t) + I(t) + R(t),
  \end{equation}
  and periodic birth rate \eqref{birth_rate}.
\end{subequations}


\subsection{Total population}

The total population follows
\begin{equation}
  \label{model_unstructured_total}
  \begin{split}
    \frac{\md}{\md t} N(t)
    &= b(t) N(t) - \mu N(t)
    \\
    &= \left[
      \tilde{b} - \mu
      + \tilde{b} \sigma \sqrt{2} \cos\left(2 \pi t / T\right)
    \right]
    N(t),
  \end{split}
\end{equation}
so that
\begin{equation}
  N(t) = N(0) \exp\left[
    \left(\tilde{b} - \mu\right) t
    + \frac{\tilde{b} \sigma T}{\pi \sqrt{2}}
    \sin\left(2 \pi t / T\right)
  \right].
\end{equation}
I chose $\tilde{b} = \mu$ so that
\begin{equation}
  N(t) = N(0) \exp\left[
    \frac{\mu \sigma T}{\pi \sqrt{2}}
    \sin\left(2 \pi t / T\right)
  \right],
\end{equation}
i.e.~periodic with period $T = \unit[1]{y}$.


\subsection{Numerical method}

\begin{subequations}
  To numerically solve the system \eqref{model_unstructured}, I used
  the Crank--Nicolson method. Given the time step $\Delta t$, let
  $t^{\ell} = t_0 + \ell \Delta t$ for $\ell \in \{0, 1, \ldots, L\}$;
  $X^{\ell} \approx X(t^{\ell})$ for $X \in \{M, S, E, I, R\}$;
  and $b^{\ell - 1 / 2} = b(t^{\ell - 1 / 2})$.
  For each $\ell \geq 1$, the Crank--Nicolson method is
  \label{numerics_unstructured}
  \begin{align}
    \frac{M^{\ell} - M^{\ell - 1}}{\Delta t}
    &=
    b^{\ell - 1 / 2}
    \frac{R^{\ell} + R^{\ell - 1}}{2}
    - (\omega + \mu)
    \frac{M^{\ell} + M^{\ell - 1}}{2},
    \\
    \begin{split}
      \frac{S^{\ell} - S^{\ell - 1}}{\Delta t}
      &=
      b^{\ell - 1 / 2}
      \left(\frac{N^{\ell} + N^{\ell - 1}}{2}
        - \frac{R^{\ell} + R^{\ell - 1}}{2}\right)
      \\ & \quad {}
      + \omega \frac{M^{\ell} + M^{\ell - 1}}{2}
      - \frac{(\lambda^{\ell} + \mu) S^{\ell}
        + (\lambda^{\ell - 1} + \mu) S^{\ell - 1}}{2},
    \end{split}
    \\
    \frac{E^{\ell} - E^{\ell - 1}}{\Delta t}
    &=
    \frac{\lambda^{\ell} S^{\ell} + \lambda^{\ell - 1} S^{\ell- 1}}{2}
    - (\rho + \mu)
    \frac{E^{\ell} + E^{\ell - 1}}{2},
    \\
    \frac{I^{\ell} - I^{\ell - 1}}{\Delta t}
    &=
    \rho \frac{E^{\ell} + E^{\ell - 1}}{2}
    - (\gamma + \mu) \frac{I^{\ell} + I^{\ell - 1}}{2},
    \\
    \frac{R^{\ell} - R^{\ell - 1}}{\Delta t}
    &=
    \gamma \frac{I^{\ell} + I^{\ell - 1}}{2}
    - \mu \frac{R^{\ell} + R^{\ell - 1}}{2},
  \end{align}
  with force of infection
  \begin{equation}
    \lambda^{\ell} = \beta I^{\ell}
  \end{equation}
  and population size
  \begin{equation}
    N^{\ell} = M^{\ell} + S^{\ell} + E^{\ell} + I^{\ell} + R^{\ell}.
  \end{equation}
\end{subequations}


\subsubsection{Linear algebra}

Let
\begin{subequations}
  \begin{align}
    \vec{x}^{\ell} &=
    \begin{bmatrix}
      M^{\ell} \\ S^{\ell} \\ E^{\ell} \\ I^{\ell} \\ R^{\ell}
    \end{bmatrix},
    \\
    \vec{\beta} &=
    \beta
    \begin{bmatrix}
      0 & 0 & 0 & 1 & 0
    \end{bmatrix},
    \\
    % \lambda^{\ell} &=
    % \vec{\beta} \vec{x}^{\ell},
    % \\
    \mat{H}_{\mathrm{new}} &=
    \mat{H}_{\mathrm{cur}} =
    \mat{I}_{5 \times 5},
    \\
    \mat{F}_{\mathrm{new}} &=
    \mat{F}_{\mathrm{cur}} =
    \begin{bmatrix}
      - \omega - \mu & 0 & 0 & 0 & 0 \\
      \omega & - \mu & 0 & 0 & 0 \\
      0 & 0 & - \rho - \mu & 0 & 0 \\
      0 & 0 & \rho & - \gamma - \mu & 0 \\
      0 & 0 & 0 & \gamma & - \mu
    \end{bmatrix},
    \\
    \mat{B} &=
    \begin{bmatrix}
      0 & 0 & 0 & 0 & 1 \\
      1 & 1 & 1 & 1 & 0 \\
      0 & 0 & 0 & 0 & 0 \\
      0 & 0 & 0 & 0 & 0 \\
      0 & 0 & 0 & 0 & 0
    \end{bmatrix},
    \\
    \mat{T}_{\mathrm{new}} &=
    \mat{T}_{\mathrm{cur}} =
    \begin{bmatrix}
      0 & 0 & 0 & 0 & 0 \\
      0 & -1 & 0 & 0 & 0 \\
      0 & 1 & 0 & 0 & 0 \\
      0 & 0 & 0 & 0 & 0 \\
      0 & 0 & 0 & 0 & 0
    \end{bmatrix}.
  \end{align}
\end{subequations}
System \eqref{numerics_unstructured} is then
\begin{subequations}
  \label{step_unstructured}
  \begin{align}
    \mat{A}_q &=
    \begin{cases}
      \mat{H}_{\mathrm{new}} - \frac{\Delta t}{2} \mat{F}_{\mathrm{new}}
      & \text{if $q = \mathrm{new}$},
      \\
      \mat{H}_{\mathrm{cur}} + \frac{\Delta t}{2} \mat{F}_{\mathrm{cur}}
      & \text{if $q = \mathrm{cur}$},
    \end{cases}
    \\
    \left[
      \mat{A}_{\mathrm{new}}
      - \frac{\Delta t}{2} \left(
        b^{\ell - 1 / 2} \mat{B}
        + \vec{\beta} \vec{x}^{\ell} \mat{T}_{\mathrm{new}}
      \right)
    \right]
    \vec{x}^{\ell} &=
    \left[
      \mat{A}_{\mathrm{cur}}
      + \frac{\Delta t}{2} \left(
        b^{\ell - 1 / 2} \mat{B}
        + \vec{\beta} \vec{x}^{\ell} \mat{T}_{\mathrm{cur}}
      \right)
    \right]
    \vec{x}^{\ell - 1}.
  \end{align}
\end{subequations}
For each $\ell \in \{1, 2, \ldots, L\}$, I used a nonlinear
solver to find $\vec{x}^{\ell}$.


\section{Age-structured model}

The model is
\begin{subequations}
  \label{model_age_structured}
  \begin{align}
    M(t, 0)
    &= b(t) \int_0^{+\infty} \nu(a) R(t, a) \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    M(t, a)
    &= - \omega M(t, a) - \mu(a) M(t, a),
    \\
    S(t, 0)
    &= b(t) \int_0^{+\infty} \nu(a) \left[N(t, a) - R(t, a)\right] \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    S(t, a)
    &= \omega M(t, a) - \lambda(t) S(t, a) - \mu(a) S(t, a),
    \\
    E(t, 0)
    &= 0,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    E(t, a)
    &= \lambda(t) S(t, a) - \rho E(t, a) - \mu(a) E(t, a),
    \\
    I(t, 0)
    &= 0,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    I(t, a)
    &= \rho E(t, a) - \gamma I(t, a) - \mu(a) I(t, a),
    \\
    R(t, 0)
    &= 0,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    R(t, a)
    &= \gamma I(t, a) - \mu(a) R(t, a),
  \end{align}
  with force of infection
  \begin{equation}
    \lambda(t) = \beta \int_0^{+\infty} I(t, a) \md a,
  \end{equation}
  population size
  \begin{equation}
    N(t, a) = M(t, a) + S(t, a) + E(t, a) + I(t, a) + R(t, a),
  \end{equation}
  and periodic birth rate \eqref{birth_rate}.
\end{subequations}


\subsection{Total population}

The total population follows the linear PDE
\begin{subequations}
  \label{model_age_structured_total}
  \begin{align}
    N(t, 0)
    &= b(t) \int_0^{+\infty} \nu(a) N(t, a) \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    N(t, a)
    &= - \mu(a) N(t, a).
  \end{align}
\end{subequations}

Because $b(t)$ is periodic with period $T = \unit[1]{y}$, I used
Floquet theory to find the stable age distribution and the asymptotic
population growth rate and then a nonlinear solver to find the value
of the mean birth rate $\tilde{b}$ that gives population growth rate $r
= 0$. See \autoref{appendix_Floquet_theory} for more details.


\subsection{Numerical method}

To numerically solve the system \eqref{model_age_structured}, I used
the Crank--Nicolson method on characteristics and the composite
rectangular rule for the integrals \autocite{milner_1992}.  Given the
time step $\Delta t$, let
$a_j = j \Delta t$ for $j \in \{0, 1, 2, \ldots, J - 1\}$;
$t^{\ell} = t_0 + \ell \Delta t$ for $\ell \in \{0, 1, \ldots, L\}$;
$X_j^{\ell} \approx X(t^{\ell}, a_j)$ for $X \in \{M, S, E, I, R\}$;
$b^{\ell - 1 / 2} = b(t^{\ell - 1 / 2})$; and
$\pi_j = \pi(a_j)$ for $\pi \in \{\mu, \nu\}$.
For each $1 \leq j \leq J - 2$ and each $\ell \geq 1$, the
Crank--Nicolson method on characteristics is
\begin{subequations}
  \label{numerics_age_structured}
  \begin{align}
    \left[1 + \frac{\Delta t}{2} (\omega + \mu_0)\right]
    M_0^{\ell}
    &= b^{\ell - 1 / 2}
    \sum_{j = 0}^{J - 1} \nu_j \frac{R_j^{\ell} + R_j^{\ell - 1}}{2}
    \Delta t,
    \\
    \frac{M_j^{\ell} - M_{j - 1}^{\ell - 1}}{\Delta t} &=
    - \frac{(\omega + \mu_j) M_j^{\ell}
      + (\omega + \mu_{j - 1}) M_{j - 1}^{\ell - 1}}{2},
    \\
    \begin{split}
      \frac{M_{J - 1}^{\ell} - M_{J - 2}^{\ell - 1}}{\Delta t} &=
      - \frac{(\omega + \mu_{J - 1}) M_{J - 1}^{\ell}
        + (\omega + \mu_{J - 2}) M_{J - 2}^{\ell - 1}}{2}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\omega + \mu_{J - 1})
      \right] M_{J - 1}^{\ell - 1},
    \end{split}
    \\
    \begin{split}
      \left[1 + \frac{\Delta t}{2} (\lambda^{\ell} + \mu_0)\right] S_0^{\ell}
      &= b^{\ell - 1 / 2}
      \sum_{j = 0}^{J - 1}
      \nu_j
      \frac{N_j^{\ell} - R_j^{\ell} + N_j^{\ell - 1} - R_j^{\ell - 1}}{2}
      \Delta t
      \\ & \quad {}
      + \frac{\Delta t}{2} \omega M_0^{\ell},
    \end{split}
    \\
    \begin{split}
      \frac{S_j^{\ell} - S_{j - 1}^{\ell - 1}}{\Delta t} &=
      \omega \frac{M_j^{\ell} + M_{j - 1}^{\ell - 1}}{2}
      \\ & \quad {}
      - \frac{(\lambda^{\ell} + \mu_j) S_j^{\ell}
        + (\lambda^{\ell - 1} + \mu_{j - 1}) S_{j - 1}^{\ell - 1}}{2},
    \end{split}
    \\
    \begin{split}
      \frac{S_{J - 1}^{\ell} - S_{J - 2}^{\ell - 1}}{\Delta t} &=
      \omega \frac{M_{J - 1}^{\ell} + M_{J - 2}^{\ell - 1}}{2}
      \\ & \quad {}
      - \frac{(\lambda^{\ell} + \mu_{J - 1}) S_{J - 1}^{\ell}
        + (\lambda^{\ell - 1} + \mu_{J - 2}) S_{J - 2}^{\ell - 1}}
      {2}
      \\ & \quad {}
      + \frac{1}{2} \omega M_{J - 1}^{\ell - 1}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\lambda^{\ell - 1} + \mu_{J - 1})
      \right] S_{J - 1}^{\ell - 1},
    \end{split}
    \\
    \left[1 + \frac{\Delta t}{2} (\rho + \mu_0)\right] E_0^{\ell}
    &= \frac{\Delta t}{2} \lambda^{\ell} S_0^{\ell},
    \\
    \begin{split}
      \frac{E_j^{\ell} - E_{j - 1}^{\ell - 1}}{\Delta t} &=
      \frac{\lambda^{\ell} S_j^{\ell} + \lambda^{\ell - 1} S_{j - 1}^{\ell - 1}}{2}
      \\ & \quad {}
      - \frac{(\rho + \mu_j) E_j^{\ell}
        + (\rho + \mu_{j - 1}) E_{j - 1}^{\ell - 1}}{2},
    \end{split}
    \\
    \begin{split}
      \frac{E_{J - 1}^{\ell} - E_{J - 2}^{\ell - 1}}{\Delta t} &=
      \frac{\lambda^{\ell} S_{J - 1}^{\ell}
        + \lambda^{\ell - 1} S_{J - 2}^{\ell - 1}}{2}
      \\ & \quad {}
      - \frac{(\rho + \mu_{J - 1}) E_{J - 1}^{\ell}
        + (\rho + \mu_{J - 2}) E_{J - 2}^{\ell - 1}}{2}
      \\ & \quad {}
      + \frac{1}{2} \lambda^{\ell - 1} S_{J - 1}^{\ell - 1}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\rho + \mu_{J - 1})
      \right] E_{J - 1}^{\ell - 1},
    \end{split}
    \\
    \left[1 + \frac{\Delta t}{2} (\gamma + \mu_0)\right] I_0^{\ell}
    &= \frac{\Delta t}{2} \rho E_0^{\ell},
    \\
    \frac{I_j^{\ell} - I_{j - 1}^{\ell - 1}}{\Delta t} &=
    \rho \frac{E_j^{\ell} + E_{j - 1}^{\ell - 1}}{2}
    - \frac{(\gamma + \mu_j) I_j^{\ell}
      + (\gamma + \mu_{j - 1}) I_{j - 1}^{\ell - 1}}{2},
    \\
    \begin{split}
      \frac{I_{J - 1}^{\ell} - I_{J - 2}^{\ell - 1}}{\Delta t} &=
      \rho \frac{E_{J - 1}^{\ell} + E_{J - 2}^{\ell - 1}}{2}
      \\ & \quad {}
      - \frac{(\gamma + \mu_{J - 1}) I_{J - 1}^{\ell}
        + (\gamma + \mu_{J - 2}) I_{J - 2}^{\ell - 1}}{2}
      \\ & \quad {}
      + \frac{1}{2} \rho E_{J - 1}^{\ell - 1}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\gamma + \mu_{J - 1})
      \right] I_{J - 1}^{\ell - 1},
    \end{split}
    \\
    \left[1 + \frac{\Delta t}{2} \mu_0\right] R_0^{\ell}
    &= \frac{\Delta t}{2} \gamma I_0^{\ell},
    \\
    \frac{R_j^{\ell} - R_{j - 1}^{\ell - 1}}{\Delta t} &=
    \gamma \frac{I_j^{\ell} + I_{j - 1}^{\ell - 1}}{2}
    - \frac{\mu_j R_j^{\ell} + \mu_{j - 1} R_{j - 1}^{\ell - 1}}{2},
    \\
    \begin{split}
      \frac{R_{J - 1}^{\ell} - R_{J - 2}^{\ell - 1}}{\Delta t} &=
      \gamma \frac{I_{J - 1}^{\ell} + I_{J - 2}^{\ell - 1}}{2}
      - \frac{\mu_{J - 1} R_{J - 1}^{\ell}
        + \mu_{J - 2} R_{J - 2}^{\ell - 1}}{2}
      \\ & \quad {}
      + \frac{1}{2}
      \gamma I_{J - 1}^{\ell - 1}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} \mu_{J - 1}
      \right] R_{J - 1}^{\ell - 1},
    \end{split}
  \end{align}
  with force of infection
  \begin{equation}
    \lambda^{\ell} =
    \beta \sum_{j = 0}^{J - 1} I_j^{\ell} \Delta t
  \end{equation}
  and population size
  \begin{equation}
    N_j^{\ell} =
    M_j^{\ell} + S_j^{\ell} + E_j^{\ell} + I_j^{\ell} + R_j^{\ell}.
  \end{equation}
\end{subequations}

\subsubsection{Linear algebra}

For solvers of age-structured models, define
\begin{subequations}
  \label{definitions_age_structured}
  \begin{align}
    \vec{0}_a &=
    \begin{bmatrix}
      0 & \cdots & 0
    \end{bmatrix}_{1 \times J},
    \\
    \vec{\iota}_a &=
    \Delta t
    \begin{bmatrix}
      1 & \cdots & 1
    \end{bmatrix}_{1 \times J},
    \\
    \vec{\zeta}_a &=
    \frac{1}{\Delta t}
    \begin{bmatrix}
      1 \\ 0 \\ \vdots \\ 0
    \end{bmatrix}_{J \times 1},
    \\
    \vec{\tau}_a &=
    \Delta t
    \begin{bmatrix}
      \nu_0 & \cdots & \nu_{J - 1}
    \end{bmatrix},
    \\
    \mat{0}_{a,a} &= \vec{0}_a^{\mathrm{T}} \vec{0}_a,
    \\
    \mat{I}_a &= \mat{I}_{J \times J},
    \\
    \mat{L}_a &=
    \begin{bmatrix}
      0 & \cdots & \cdots & 0 & 0 \\
      1 & \ddots & & \vdots & \vdots \\
      0 & \ddots & \ddots & \vdots & \vdots \\
      \vdots & \ddots & \ddots & 0 & 0 \\
      0 & \cdots & 0 & 1 & 1
    \end{bmatrix}_{J \times J},
    \\
    \mat{H}_{a, q} &=
    \begin{cases}
      \mat{I}_a & \text{if $q = \mathrm{new}$},
      \\
      \mat{L}_a & \text{if $q = \mathrm{cur}$},
    \end{cases}
    \\
    \mat{F}_{a, q}(\vec{\pi}) &=
    \begin{cases}
      \begin{bmatrix}
        \pi_0 & 0 & \cdots & 0 \\
        0 & \pi_1 & \ddots & \vdots \\
        \vdots & \ddots & \ddots & 0 \\
        0 & \cdots & 0 & \pi_{J - 1}
      \end{bmatrix}
      & \text{if $q = \mathrm{new}$},
      \\
      \mat{L}_{a} \mat{F}_{a, \mathrm{new}}(\vec{\pi})
      & \text{if $q = \mathrm{cur}$},
    \end{cases}
    \\
    \mat{B}_a &= \vec{\zeta}_a \vec{\tau}_a.
  \end{align}
\end{subequations}
For $q \in \{\mathrm{new}, \mathrm{cur}\}$, let
\begin{subequations}
  \begin{align}
    \vec{x}^{\ell} &=
    \begin{bmatrix}
      M_0^{\ell} \\ \vdots \\ M_{J - 1}^{\ell} \\
      S_0^{\ell} \\ \vdots \\ S_{J - 1}^{\ell} \\
      E_0^{\ell} \\ \vdots \\ E_{J - 1}^{\ell} \\
      I_0^{\ell} \\ \vdots \\ I_{J - 1}^{\ell} \\
      R_0^{\ell} \\ \vdots \\ R_{J - 1}^{\ell}
    \end{bmatrix},
    \\
    \vec{\beta} &=
    \beta
    \begin{bmatrix}
      \vec{0}_a & \vec{0}_a & \vec{0}_a & \vec{\iota}_a & \vec{0}_a
    \end{bmatrix},
    \\
    % \lambda^{\ell} &=
    % \vec{\beta} \vec{x}^{\ell},
    % \\
    \mat{H}_{q} &=
    \begin{bmatrix}
      \mat{H}_{a, q} & \mat{0} & \mat{0} & \mat{0} & \mat{0} \\
      \mat{0} & \mat{H}_{a, q} & \mat{0} & \mat{0} & \mat{0} \\
      \mat{0} & \mat{0} & \mat{H}_{a, q} & \mat{0} & \mat{0} \\
      \mat{0} & \mat{0} & \mat{0} & \mat{H}_{a, q} & \mat{0}
      \\
      \mat{0} & \mat{0} & \mat{0} & \mat{0} & \mat{H}_{a, q}
    \end{bmatrix},
    \\
    \mat{F}_q &=
    \begin{bmatrix}
      \mat{F}_{a, q}(- \omega - \vec{\mu}) & \mat{0} & \mat{0}
      & \mat{0} & \mat{0}
      \\
      \mat{F}_{a, q}(\omega) & \mat{F}_{a, q}(- \vec{\mu}) & \mat{0}
      & \mat{0} & \mat{0}
      \\
      \mat{0} & \mat{0} & \mat{F}_{a, q}(- \rho - \vec{\mu}) & \mat{0}
      & \mat{0}
      \\
      \mat{0} & \mat{0} & \mat{F}_{a, q}(\rho)
      & \mat{F}_{a, q}(- \gamma - \vec{\mu}) & \mat{0}
      \\
      \mat{0} & \mat{0} & \mat{0} & \mat{F}_{a, q}(\gamma)
      & \mat{F}_{a, q}(- \vec{\mu})
    \end{bmatrix},
    \\
    \mat{B} &=
    \begin{bmatrix}
      \mat{0} & \mat{0} & \mat{0} & \mat{0} & \mat{B}_a
      \\
      \mat{B}_a & \mat{B}_a & \mat{B}_a & \mat{B}_a & \mat{0}
      \\
      \mat{0}_{a,a} & \mat{0} & \mat{0} & \mat{0} & \mat{0}
      \\
      \mat{0}_{a,a} & \mat{0} & \mat{0} & \mat{0} & \mat{0}
      \\
      \mat{0}_{a,a} & \mat{0} & \mat{0} & \mat{0} & \mat{0}
    \end{bmatrix},
    \\
    \mat{T}_q &=
    \begin{bmatrix}
      \mat{0}_{a,a} & \mat{0} & \mat{0}_{a,a} & \mat{0} & \mat{0}
      \\
      \mat{0} & - \mat{H}_{a, q} & \mat{0} & \mat{0} & \mat{0}
      \\
      \mat{0} & \mat{H}_{a, q} & \mat{0} & \mat{0} & \mat{0}
      \\
      \mat{0} & \mat{0} & \mat{0} & \mat{0}_{a,a} & \mat{0}
      \\
      \mat{0} & \mat{0} & \mat{0} & \mat{0} & \mat{0}_{a,a}
    \end{bmatrix}.
  \end{align}
\end{subequations}
System \eqref{numerics_age_structured} is then
\begin{subequations}
  \label{step_age_structured}
  \begin{align}
    \mat{A}_q &=
    \begin{cases}
      \mat{H}_{\mathrm{new}} - \frac{\Delta t}{2} \mat{F}_{\mathrm{new}}
      & \text{if $q = \mathrm{new}$},
      \\
      \mat{H}_{\mathrm{cur}} + \frac{\Delta t}{2} \mat{F}_{\mathrm{cur}}
      & \text{if $q = \mathrm{cur}$},
    \end{cases}
    \\
    \left[
      \mat{A}_{\mathrm{new}}
      - \frac{\Delta t}{2} \left(
        b^{\ell - 1 / 2} \mat{B}
        + \vec{\beta} \vec{x}^{\ell} \mat{T}_{\mathrm{new}}
      \right)
    \right]
    \vec{x}^{\ell} &=
    \left[
      \mat{A}_{\mathrm{cur}}
      + \frac{\Delta t}{2} \left(
        b^{\ell - 1 / 2} \mat{B}
        + \vec{\beta} \vec{x}^{\ell} \mat{T}_{\mathrm{cur}}
      \right)
    \right]
    \vec{x}^{\ell - 1}.
  \end{align}
\end{subequations}
For each $\ell \in \{1, 2, \ldots, L\}$, I used a nonlinear
solver to find $\vec{x}^{\ell}$.


\section{Time-since-entry-structured model}

The model is
\begin{subequations}
  \label{model_time_since_entry_structured}
  \begin{align}
    m(t, 0) &=
    b(t) R(t),
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial z}\right)
    m(t, z) &=
    - \omega(z) m(t, z) - \mu m(t, z),
    \\
    \begin{split}
      \frac{\md}{\md t} S(t) &=
      b(t) \left[N(t) - R(t)\right]
      + \int_0^{+\infty} \omega(z) m(t, z) \md z
      \\ & \quad {}
      - \lambda(t) S(t) - \mu S(t),
    \end{split}
    \\
    e(t, 0) &=
    \lambda(t) S(t),
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial z}\right)
    e(t, z) &=
    - \rho(z) e(t, z) - \mu e(t, z),
    \\
    i(t, 0) &=
    \int_0^{+\infty} \rho(z) e(t, z) \md z,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial z}\right)
    i(t, z) &=
    - \gamma(z) i(t, z) - \mu i(t, z),
    \\
    \frac{\md}{\md t} R(t) &=
    \int_0^{+\infty} \gamma(z) i(t, z) \md z
    - \mu R(t),
  \end{align}
  with force of infection
  \begin{equation}
    \lambda(t) = \beta \int_0^{+\infty} i(t, z) \md z,
  \end{equation}
  population size
  \begin{equation}
    N(t) =
    S(t) + R(t)
    + \int_0^{+\infty} m(t, z) + e(t, z) + i(t, z) \md z,
  \end{equation}
  and periodic birth rate \eqref{birth_rate}.
\end{subequations}


\subsection{Total population}

The total population follows
\begin{equation}
  \frac{\md}{\md t} N(t)
  = b(t) N(t) - \mu N(t).
\end{equation}
This is the same as model \eqref{model_unstructured_total} for the
total population for the unstructured model: as I did for that model,
I chose $\tilde{b} = \mu$ so that $N(t)$ is periodic.


\subsection{Numerical method}

To numerically solve the system
\eqref{model_time_since_entry_structured}, I used the Crank--Nicolson
method on characteristics and the composite rectangle rule for the
integrals \autocite{milner_1992}.  Given the time step $\Delta t$,
let $z_k = k \Delta t$
for $k \in \{0, 1, 2, \ldots, K - 1\}$;
$t^{\ell} = t_0 + \ell \Delta t$
for $\ell \in \{0, 1, \ldots, L\}$;
$X^{\ell} \approx X(t^{\ell})$
for $X \in \{S, R\}$;
$y_k^{\ell} \approx y(t^{\ell}, z_k)$
for $y \in \{m, e, i\}$;
$b^{\ell - 1 / 2} = b(t^{\ell - 1 / 2})$;
and $\xi_k = \xi(z_k)$
for $\xi \in \{\omega, \rho, \gamma\}$.
For each $1 \leq k \leq K - 2$
and each $\ell \geq 1$,
the Crank--Nicolson method on characteristics is
\begin{subequations}
  \label{numerics_time_since_entry_structured}
  \begin{align}
    \left[1 + \frac{\Delta t}{2} (\omega_0 + \mu)\right] m_0^{\ell}
    &= b^{\ell - 1 / 2} \frac{R^{\ell} + R^{\ell - 1}}{2},
    \\
    \frac{m_k^{\ell} - m_{k - 1}^{\ell - 1}}{\Delta t} &=
    - \frac{(\omega_k + \mu) m_k^{\ell}
      + (\omega_{k - 1} + \mu) m_{k - 1}^{\ell - 1}}{2},
    \\
    \begin{split}
      \frac{m_{K - 1}^{\ell} - m_{K - 2}^{\ell - 1}}{\Delta t} &=
      - \frac{(\omega_{K - 1} + \mu) m_{K - 1}^{\ell}
        + (\omega_{K - 2} + \mu) m_{K - 2}^{\ell - 1}}{2}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\omega_{K - 1} + \mu)
      \right] m_{K - 1}^{\ell - 1},
    \end{split}
    \\
    \begin{split}
      \frac{S^{\ell} - S^{\ell - 1}}{\Delta t} &=
      b^{\ell - 1 / 2}
      \frac{N^{\ell} - R^{\ell} + N^{\ell - 1} - R^{\ell - 1}}{2}
      \\ & \quad {}
      + \sum_{k = 0}^{K - 1} \omega_k
      \frac{m_k^{\ell} + m_k^{\ell - 1}}{2}
      \Delta t
      \\ & \quad {}
      - \frac{(\lambda^{\ell} + \mu) S^{\ell}
        + (\lambda^{\ell - 1} + \mu) S^{\ell - 1}}{2},
    \end{split}
    \\
    \left[1 + \frac{\Delta t}{2} (\rho_0 + \mu)\right] e_0^{\ell}
    &= \frac{\lambda^{\ell} S^{\ell} + \lambda^{\ell - 1} S^{\ell - 1}}{2},
    \\
    \frac{e_k^{\ell} - e_{k - 1}^{\ell - 1}}{\Delta t} &=
    - \frac{(\rho_k + \mu) e_k^{\ell}
      + (\rho_{k - 1} + \mu) e_{k - 1}^{\ell - 1}}{2},
    \\
    \begin{split}
      \frac{e_{K - 1}^{\ell} - e_{K - 2}^{\ell - 1}}{\Delta t} &=
      - \frac{(\rho_{K - 1} + \mu) e_{K - 1}^{\ell}
        + (\rho_{K - 2} + \mu) e_{K - 2}^{\ell - 1}}{2}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\rho_{K - 1} + \mu)
      \right] e_{K - 1}^{\ell - 1},
    \end{split}
    \\
    \left[1 + \frac{\Delta t}{2} (\gamma_0 + \mu)\right] i_0^{\ell}
    &= \sum_{k = 0}^{K - 1} \rho_k
    \frac{e_k^{\ell} + e_k^{\ell - 1}}{2}
    \Delta t,
    \\
    \frac{i_k^{\ell} - i_{k - 1}^{\ell - 1}}{\Delta t} &=
    - \frac{(\gamma_k + \mu) i_k^{\ell}
      + (\gamma_{k - 1} + \mu) i_{k - 1}^{\ell - 1}}{2},
    \\
    \begin{split}
      \frac{i_{K - 1}^{\ell} - i_{K - 2}^{\ell - 1}}{\Delta t} &=
      - \frac{(\gamma_{K - 1} + \mu) i_{K - 1}^{\ell}
        + (\gamma_{K - 2} + \mu) i_{K - 2}^{\ell - 1}}{2}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\gamma_{K - 1} + \mu)
      \right] i_{K - 1}^{\ell - 1},
    \end{split}
    \\
    \frac{R^{\ell} - R^{\ell - 1}}{\Delta t}
    &= \sum_{k = 0}^{K - 1} \gamma_k
    \frac{i_k^{\ell} + i_k^{\ell - 1}}{2}
    \Delta t
    - \mu \frac{R^{\ell} + R^{\ell - 1}}{2},
  \end{align}
  with force of infection
  \begin{equation}
    \lambda^{\ell} =
    \beta \sum_{k = 0}^{K - 1} i_k^{\ell} \Delta t
  \end{equation}
  and population size
  \begin{equation}
    N^{\ell} =
    S^{\ell} + R^{\ell}
    + \sum_{k = 0}^{K - 1} \left(
      m_k^{\ell} + e_k^{\ell} + i_k^{\ell}
    \right) \Delta t.
  \end{equation}
\end{subequations}


\subsubsection{Linear algebra}

For solvers of time-since-entry-structured models, define
\begin{subequations}
  \label{definitions_time_since_entry_structured}
  \begin{align}
    \vec{0}_z &=
    \begin{bmatrix}
      0 & \cdots & 0
    \end{bmatrix}_{1 \times K},
    \\
    \vec{\iota}_z &=
    \Delta t
    \begin{bmatrix}
      1 & \cdots & 1
    \end{bmatrix}_{1 \times K},
    \\
    \vec{\zeta}_z &=
    \frac{1}{\Delta t}
    \begin{bmatrix}
      1 \\ 0 \\ \vdots \\ 0
    \end{bmatrix}_{K \times 1},
    \\
    \vec{\sigma}_z(\vec{\xi}) &=
    \Delta t
    \begin{bmatrix}
      \xi_0 & \cdots & \xi_{K - 1}
    \end{bmatrix},
    \\
    \mat{0}_{z,z} &= \vec{0}_z^{\mathrm{T}} \vec{0}_z,
    \\
    \mat{I}_z &= \mat{I}_{K \times K},
    \\
    \mat{L}_z &=
    \begin{bmatrix}
      0 & \cdots & \cdots & 0 & 0 \\
      1 & \ddots & & \vdots & \vdots \\
      0 & \ddots & \ddots & \vdots & \vdots \\
      \vdots & \ddots & \ddots & 0 & 0 \\
      0 & \cdots & 0 & 1 & 1
    \end{bmatrix}_{K \times K},
    \\
    \mat{H}_{z, q} &=
    \begin{cases}
      \mat{I}_z & \text{if $q = \mathrm{new}$},
      \\
      \mat{L}_z & \text{if $q = \mathrm{cur}$},
    \end{cases}
    \\
    \mat{F}_{z, q}(\vec{\xi}) &=
    \begin{cases}
      \begin{bmatrix}
        \xi_0 & 0 & \cdots & 0 \\
        0 & \xi_1 & \ddots & \vdots \\
        \vdots & \ddots & \ddots & 0 \\
        0 & \cdots & 0 & \xi_{K - 1}
      \end{bmatrix}
      & \text{if $q = \mathrm{new}$},
      \\
      \mat{L}_z \mat{F}_{z, \mathrm{new}}(\vec{\xi})
      & \text{if $q = \mathrm{cur}$}.
    \end{cases}
  \end{align}
\end{subequations}
For $q \in \{\mathrm{new}, \mathrm{cur}\}$, let
\begin{subequations}
  \begin{align}
    \vec{x}^{\ell} &=
    \begin{bmatrix}
      m_0^{\ell} \\ \vdots \\ m_{K - 1}^{\ell} \\
      S^{\ell} \\
      e_0^{\ell} \\ \vdots \\ e_{K - 1}^{\ell} \\
      i_0^{\ell} \\ \vdots \\ i_{K - 1}^{\ell} \\
      R^{\ell}
    \end{bmatrix},
    \\
    \vec{\beta} &=
    \beta
    \begin{bmatrix}
      \vec{0}_z & 0 & \vec{0}_z & \vec{\iota}_z & 0
    \end{bmatrix},
    \\
    % \lambda^{\ell} &=
    % \vec{\beta} \vec{x}^{\ell},
    % \\
    \mat{H}_{q} &=
    \begin{bmatrix}
      \mat{H}_{z, q} & \vec{0} & \mat{0} & \mat{0} & \vec{0} \\
      \vec{0} & 1 & \vec{0} & \vec{0} & 0 \\
      \mat{0} & \vec{0} & \mat{H}_{z, q} & \mat{0} & \vec{0} \\
      \mat{0} & \vec{0} & \mat{0} & \mat{H}_{z, q} & \vec{0}
      \\
      \vec{0} & 0 & \vec{0} & \vec{0} & 1
    \end{bmatrix},
    \\
    \mat{F}_q &=
    \begin{bmatrix}
      \mat{F}_{z, q}(- \vec{\omega} - \mu) & \vec{0} & \mat{0}
      & \mat{0} & \vec{0}
      \\
      \vec{\sigma}_z(\vec{\omega}) & - \mu & \vec{0} & \vec{0} & 0
      \\
      \mat{0} & \vec{0} & \mat{F}_{z, q}(- \vec{\rho} - \mu)
      & \mat{0} & \vec{0}
      \\
      \mat{0} & \vec{0} & \vec{\zeta}_z \vec{\sigma}_z(\vec{\rho})
      & \mat{F}_{z, q}(- \vec{\gamma} - \mu) & \vec{0}
      \\
      \vec{0} & 0 & \vec{0} & \vec{\sigma}_z(\vec{\gamma}) & - \mu
    \end{bmatrix},
    \\
    \mat{B} &=
    \begin{bmatrix}
      \mat{0} & \vec{0} & \mat{0} & \mat{0} & \vec{\zeta}_z
      \\
      \vec{\iota}_z & 1 & \vec{\iota}_z & \vec{\iota}_z & 0
      \\
      \mat{0}_{z,z} & \vec{0} & \mat{0} & \mat{0} & \vec{0}
      \\
      \mat{0}_{z,z} & \vec{0} & \mat{0} & \mat{0} & \vec{0}
      \\
      \vec{0}_z & 0 & \vec{0} & \vec{0} & 0
    \end{bmatrix},
    \\
    \mat{T}_{\mathrm{new}} &=
    \mat{T}_{\mathrm{cur}} =
    \begin{bmatrix}
      \mat{0}_{z,z} & \vec{0} & \mat{0}_{z,z} & \mat{0} & \vec{0}
      \\
      \vec{0} & - 1 & \vec{0} & \vec{0} & 0
      \\
      \mat{0} & \vec{\zeta}_z & \mat{0} & \mat{0} & \vec{0}
      \\
      \mat{0} & \vec{0} & \mat{0} & \mat{0}_{z,z} & \vec{0}
      \\
      \vec{0} & 0 & \vec{0} & \vec{0} & 0
    \end{bmatrix}.
  \end{align}
\end{subequations}
System \eqref{numerics_time_since_entry_structured} is then
\begin{subequations}
  \label{step_time_since_entry_structured}
  \begin{align}
    \mat{A}_q &=
    \begin{cases}
      \mat{H}_{\mathrm{new}} - \frac{\Delta t}{2} \mat{F}_{\mathrm{new}}
      & \text{if $q = \mathrm{new}$},
      \\
      \mat{H}_{\mathrm{cur}} + \frac{\Delta t}{2} \mat{F}_{\mathrm{cur}}
      & \text{if $q = \mathrm{cur}$},
    \end{cases}
    \\
    \left[
      \mat{A}_{\mathrm{new}}
      - \frac{\Delta t}{2} \left(
        b^{\ell - 1 / 2} \mat{B}
        + \vec{\beta} \vec{x}^{\ell} \mat{T}_{\mathrm{new}}
      \right)
    \right]
    \vec{x}^{\ell} &=
    \left[
      \mat{A}_{\mathrm{cur}}
      + \frac{\Delta t}{2} \left(
        b^{\ell - 1 / 2} \mat{B}
        + \vec{\beta} \vec{x}^{\ell} \mat{T}_{\mathrm{cur}}
      \right)
    \right]
    \vec{x}^{\ell - 1}.
  \end{align}
\end{subequations}
For each $\ell \in \{1, 2, \ldots, L\}$, I used a nonlinear
solver to find $\vec{x}^{\ell}$.


\section{Age- and time-since-entry-structured model}

The model is
\begin{subequations}
  \label{model_age_and_time_since_entry_structured}
  \begin{align}
    M(t, 0) &=
    b(t) \int_0^{+\infty} \nu(a) R(t, a) \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    M(t, a) &=
    - \omega(a) M(t, a) - \mu(a) M(t, a),
    \\
    S(t, 0) &=
    b(t) \int_0^{+\infty} \nu(a) \left[N(t, a) - R(t, a)\right] \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    S(t, a) &=
    \omega(a) M(t, a) - \lambda(t) S(t, a) - \mu(a) S(t, a),
    \\
    e(t, 0, 0) &=
    \lambda(t) S(t, 0),
    \\
    e(t, 0, z) &=
    0,
    \\
    e(t, a, 0) &=
    \lambda(t) S(t, a),
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}
      + \frac{\partial}{\partial z}\right)
    e(t, a, z) &=
    - \rho(z) e(t, a, z) - \mu(a) e(t, a, z),
    \\
    i(t, 0, 0) &=
    0,
    \\
    i(t, 0, z) &=
    0,
    \\
    i(t, a, 0) &=
    \int_0^{+\infty} \rho(z) e(t, a, z) \md z,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}
      + \frac{\partial}{\partial z}\right)
    i(t, a, z) &=
    - \gamma(z) i(t, a, z) - \mu(a) i(t, a, z),
    \\
    R(t, 0) &=
    0,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    R(t, a) &=
    \int_0^{+\infty} \gamma(z) i(t, a, z) \md z
    - \mu(a) R(t, a),
  \end{align}
  with force of infection
  \begin{equation}
    \lambda(t) =
    \beta
    \int_0^{+\infty} \int_0^{+\infty}
    i(t, a, z)
    \md a \md z,
  \end{equation}
  population size
  \begin{equation}
    N(t, a) =
    M(t, a) + S(t, a) + R(t, a)
    + \int_0^{+\infty} e(t, a, z) + i(t, a, z) \md z,
  \end{equation}
  and periodic birth rate \eqref{birth_rate}.
\end{subequations}


\subsection{Total population}

The total population follows the linear PDE
\begin{subequations}
  \begin{align}
    N(t, 0) &=
    b(t) \int_0^{+\infty} \nu(a) N(t, a) \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    N(t, a) &=
    - \mu(a) N(t, a).
  \end{align}
\end{subequations}
This is the same as model \eqref{model_age_structured_total} for the
total population for the age-structured model: as I did for that
model, I used Floquet theory and a nonlinear solver to find the value
of the mean birth rate $\tilde{b}$ that gives population growth rate
$r = 0$.  See \autoref{appendix_Floquet_theory} for more details.


\subsection{Numerical method}

To numerically solve the system
\eqref{model_age_and_time_since_entry_structured}, I used the
Crank--Nicolson method on characteristics and the composite rectangle
rule for the integrals \autocite{milner_1992}.  Given the time step
$\Delta t$, let $a_j = j \Delta t$ for
$j \in \{0, 1, 2, \ldots, J - 1\}$;
$z_k = k \Delta t$
for $k \in \{0, 1, 2, \ldots, K - 1\}$;
$t^{\ell} = t_0 + \ell \Delta t$ for
$\ell \in \{0, 1, \ldots, L\}$;
$X_j^{\ell} \approx X(t^{\ell}, a_j)$
for $X \in \{M, S, R\}$;
$y_{j, k}^{\ell} \approx y(t^{\ell}, a_j, z_k)$
for $y \in \{e, i\}$;
$\pi_j = \pi(a_j)$ for $\pi \in \{\mu, \nu, \omega\}$; and
$\xi_k = \xi(z_k)$ for $\xi \in \{\rho, \gamma\}$.
For each $1 \leq j \leq J - 2$, each $1 \leq k \leq K - 2$, and each
$\ell \geq 1$, the Crank--Nicolson method on characteristics is
\begin{subequations}
  \label{numerics_age_and_time_since_entry_structured}
  \begin{align}
    \left[1 + \frac{\Delta t}{2} (\omega_0 + \mu_0)\right] M_0^{\ell}
    &= b^{\ell - 1 / 2}
    \sum_{j = 0}^{J - 1} \nu_j \frac{R_j^{\ell} + R_j^{\ell - 1}}{2}
    \Delta t,
    \\
    \frac{M_j^{\ell} - M_{j - 1}^{\ell - 1}}{\Delta t}
    &=
    - \frac{(\omega_j + \mu_j) M_j^{\ell}
      + (\omega_{j - 1} + \mu_{j - 1}) M_{j - 1}^{\ell - 1}}
    {2},
    \\
    \begin{split}
      \frac{M_{J - 1}^{\ell} - M_{J - 2}^{\ell - 1}}{\Delta t}
      &=
      - \frac{(\omega_{J - 1} + \mu_{J - 1}) M_{J - 1}^{\ell}
        + (\omega_{J - 2} + \mu_{J - 2}) M_{J - 2}^{\ell - 1}}
      {2}
      \\ & \quad {}
      +  \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\omega_{J - 1} + \mu_{J - 1})
      \right] M_{J - 1}^{\ell - 1},
    \end{split}
    \\
    \begin{split}
      \left[1 + \frac{\Delta t}{2} (\lambda^{\ell} + \mu_0)\right] S_0^{\ell}
      &=
      b^{\ell - 1 / 2}
      \sum_{j = 0}^{J - 1} \nu_j
      \frac{N_j^{\ell} - R_j^{\ell} + N_j^{\ell - 1} - R_j^{\ell - 1}}
      {2}
      \Delta t
      \\ & \quad {}
      + \frac{\Delta t}{2} \omega_0 M_0^{\ell},
    \end{split}
    \\
    \begin{split}
      \frac{S_j^{\ell} - S_{j - 1}^{\ell - 1}}{\Delta t}
      &=
      \frac{\omega_j M_j^{\ell}
        + \omega_{j - 1} M_{j - 1}^{\ell - 1}}
      {2}
      \\ & \quad {}
      - \frac{(\lambda^{\ell} + \mu_j) S_j^{\ell}
        + (\lambda^{\ell - 1} + \mu_{j - 1}) S_{j - 1}^{\ell - 1}}
      {2},
    \end{split}
    \\
    \begin{split}
      \frac{S_{J - 1}^{\ell} - S_{J - 2}^{\ell - 1}}{\Delta t}
      &=
      \frac{\omega_{J - 1} M_{J - 1}^{\ell}
        + \omega_{J - 2} M_{J - 2}^{\ell - 1}}
      {2}
      \\ & \quad {}
      - \frac{(\lambda^{\ell} + \mu_{J - 1}) S_{J - 1}^{\ell}
        + (\lambda^{\ell - 1} + \mu_{J - 2}) S_{J - 2}^{\ell - 1}}
      {2}
      \\ & \quad {}
      + \frac{\omega_{J - 1} M_{J - 1}^{\ell - 1}}{2}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\lambda^{\ell - 1} + \mu_{J - 1})
      \right] S_{J - 1}^{\ell - 1},
    \end{split}
    \\
    \left[1 + \frac{\Delta t}{2} (\rho_0 + \mu_0)\right] e_{0, 0}^{\ell}
    &=
    \frac{\lambda^{\ell} S_0^{\ell}}{2},
    \\
    \left[1 + \frac{\Delta t}{2} (\rho_k + \mu_0)\right] e_{0, k}^{\ell}
    &= 0,
    \\
    \left[1 + \frac{\Delta t}{2} (\rho_{K - 1} + \mu_0)\right] e_{0, K - 1}^{\ell}
    &= 0,
    \\
    \left[1 + \frac{\Delta t}{2} (\rho_0 + \mu_j)\right] e_{j, 0}^{\ell}
    &=
    \frac{\lambda^{\ell} S_j^{\ell}
      + \lambda^{\ell - 1} S_{j - 1}^{\ell - 1}}
    {2},
    \\
    \frac{e_{j, k}^{\ell} - e_{j - 1, k - 1}^{\ell - 1}}{\Delta t}
    &= - \frac{(\rho_k + \mu_j) e_{j, k}^{\ell}
      + (\rho_{k - 1} + \mu_{j - 1}) e_{j - 1, k - 1}^{\ell - 1}}
    {2},
    \\
    \begin{split}
      \frac{e_{j, K - 1}^{\ell} - e_{j - 1, K - 2}^{\ell - 1}}{\Delta t}
      &= - \frac{(\rho_{K - 1} + \mu_j) e_{j, K - 1}^{\ell}
        + (\rho_{K - 2} + \mu_{j - 1}) e_{j - 1, K - 2}^{\ell - 1}}
      {2}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\rho_{K - 1} + \mu_{j - 1})
      \right] e_{j - 1, K - 1}^{\ell - 1},
    \end{split}
    \\
    \left[1 + \frac{\Delta t}{2} (\rho_0 + \mu_{J - 1})\right] e_{J - 1, 0}^{\ell}
    &=
    \frac{\lambda^{\ell} S_{J - 1}^{\ell}
      + \lambda^{\ell - 1} S_{J - 2}^{\ell - 1}}
    {2}
    + \frac{\lambda^{\ell - 1} S_{J - 1}^{\ell - 1}}{2},
    \\
    \begin{split}
      \frac{e_{J - 1, k}^{\ell} - e_{J - 2, k - 1}^{\ell - 1}}{\Delta t}
      &= - \frac{(\rho_k + \mu_{J - 1}) e_{J - 1, k}^{\ell}
        + (\rho_{k - 1} + \mu_{J - 2}) e_{J - 2, k - 1}^{\ell - 1}}
      {2}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\rho_{k - 1} + \mu_{J - 1})
      \right] e_{J - 1, k - 1}^{\ell - 1},
    \end{split}
    \\
    \begin{split}
      \frac{e_{J - 1, K - 1}^{\ell} - e_{J - 2, K - 2}^{\ell - 1}}{\Delta t}
      &= - \frac{(\rho_{K - 1} + \mu_{J - 1}) e_{J - 1, K - 1}^{\ell}
        + (\rho_{K - 2} + \mu_{J - 2}) e_{J - 2, K - 2}^{\ell - 1}}
      {2}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\rho_{K - 1} + \mu_{J - 2})
      \right] e_{J - 2, K - 1}^{\ell - 1}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\rho_{K - 2} + \mu_{J - 1})
      \right] e_{J - 1, K - 2}^{\ell - 1}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\rho_{K - 1} + \mu_{J - 1})
      \right] e_{J - 1, K - 1}^{\ell - 1},
    \end{split}
    \\
    \left[1 + \frac{\Delta t}{2} (\gamma_0 + \mu_0)\right] i_{0, 0}^{\ell}
    &= \sum_{k = 0}^{K - 1} \frac{\rho_k e_{0, k}^{\ell}} {2}
    \Delta t,
    \\
    \left[1 + \frac{\Delta t}{2} (\gamma_k + \mu_0)\right] i_{0, k}^{\ell}
    &= 0,
    \\
    \left[1 + \frac{\Delta t}{2} (\gamma_{K - 1} + \mu_0)\right]
    i_{0, K - 1}^{\ell}
    &= 0,
    \\
    \left[1 + \frac{\Delta t}{2} (\gamma_0 + \mu_j)\right] i_{j, 0}^{\ell}
    &= \sum_{k = 0}^{K - 1} \rho_k
    \frac{e_{j, k}^{\ell} + e_{j - 1, k}^{\ell - 1}} {2}
    \Delta t,
    \\
    \frac{i_{j, k}^{\ell} - i_{j - 1, k - 1}^{\ell - 1}}{\Delta t}
    &= - \frac{(\gamma_k + \mu_j) i_{j, k}^{\ell}
      + (\gamma_{k - 1} + \mu_{j - 1}) i_{j - 1, k - 1}^{\ell - 1}}
    {2},
    \\
    \begin{split}
      \frac{i_{j, K - 1}^{\ell} - i_{j - 1, K - 2}^{\ell - 1}}{\Delta t}
      &= - \frac{(\gamma_{K - 1} + \mu_j) i_{j, K - 1}^{\ell}
        + (\gamma_{K - 2} + \mu_{j - 1}) i_{j - 1, K - 2}^{\ell - 1}}
      {2}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\gamma_{K - 1} + \mu_{j - 1})
      \right] i_{j - 1, K - 1}^{\ell - 1},
    \end{split}
    \\
    \begin{split}
      \left[1 + \frac{\Delta t}{2} (\gamma_0 + \mu_{J - 1})\right]
      i_{J - 1, 0}^{\ell}
      &= \sum_{k = 0}^{K - 1} \rho_k
      \frac{e_{J - 1, k}^{\ell} + e_{J - 2, k}^{\ell - 1}} {2}
      \Delta t
      \\ & \quad {}
      + \sum_{k = 0}^{K - 1} \rho_k
      \frac{e_{J - 1, k}^{\ell - 1}} {2}
      \Delta t,
    \end{split}
    \\
    \begin{split}
      \frac{i_{J - 1, k}^{\ell} - i_{J - 2, k - 1}^{\ell - 1}}{\Delta t}
      &= - \frac{(\gamma_k + \mu_{J - 1}) i_{J - 1, k}^{\ell}
        + (\gamma_{k - 1} + \mu_{J - 2}) i_{J - 2, k - 1}^{\ell - 1}}
      {2}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\gamma_{k - 1} + \mu_{J - 1})
      \right] i_{J - 1, k - 1}^{\ell - 1},
    \end{split}
    \\
    \begin{split}
      \frac{i_{J - 1, K - 1}^{\ell} - i_{J - 2, K - 2}^{\ell - 1}}{\Delta t}
      &= - \frac{(\gamma_{K - 1} + \mu_{J - 1}) i_{J - 1, K - 1}^{\ell}
        + (\gamma_{K - 2} + \mu_{J - 2}) i_{J - 2, K - 2}^{\ell - 1}}
      {2}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\gamma_{K - 2} + \mu_{J - 1})
      \right] i_{J - 1, K - 2}^{\ell - 1}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\gamma_{K - 1} + \mu_{J - 2})
      \right] i_{J - 2, K - 1}^{\ell - 1}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\gamma_{K - 1} + \mu_{J - 1})
      \right] i_{J - 1, K - 1}^{\ell - 1},
    \end{split}
    \\
    \left[1 + \frac{\Delta t}{2} \mu_0\right] R_0^{\ell}
    &= \frac{\Delta t}{2} \sum_{k = 0}^{K - 1}
    \gamma_k i_{0, k}^{\ell} \Delta t,
    \\
    \begin{split}
      \frac{R_j^{\ell} - R_{j - 1}^{\ell - 1}}{\Delta t}
      &= \sum_{k = 0}^{K - 1} \gamma_k
      \frac{i_{j, k}^{\ell} + i_{j - 1, k}^{\ell - 1}}
      {2}
      \Delta t
      \\ & \quad {}
      - \frac{\mu_j R_j^{\ell}
        + \mu_{j - 1} R_{j - 1}^{\ell - 1}}
      {2},
    \end{split}
    \\
    \begin{split}
      \frac{R_{J - 1}^{\ell} - R_{J - 2}^{\ell - 1}}{\Delta t}
      &= \sum_{k = 0}^{K - 1} \gamma_k
      \frac{i_{J - 1, k}^{\ell} + i_{J - 2, k}^{\ell - 1}}
      {2}
      \Delta t
      \\ & \quad {}
      - \frac{\mu_{J - 1} R_{J - 1}^{\ell}
        + \mu_{J - 2} R_{J - 2}^{\ell - 1}}
      {2}
      \\ & \quad {}
      + \sum_{k = 0}^{K - 1} \gamma_k
      \frac{i_{J - 1, k}^{\ell - 1}}
      {2}
      \Delta t
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} \mu_{J - 1}
      \right] R_{J - 1}^{\ell - 1},
    \end{split}
  \end{align}
  with force of infection
  \begin{equation}
    \lambda^l =
    \beta \sum_{j = 0}^{J - 1} \sum_{k = 0}^{K - 1} i_{j, k}^{\ell}
    (\Delta t)^2,
  \end{equation}
  and population size
  \begin{equation}
    N_j^{\ell} =
    M_j^{\ell} + S_j^{\ell} + R_j^{\ell}
    + \sum_{k = 0}^{K - 1}
    \left(e_{j, k}^{\ell} + i_{j, k}^{\ell}\right)
    \Delta t.
  \end{equation}
\end{subequations}


\subsubsection{Linear algebra}

Using the definitions for solvers of age-structured models
\eqref{definitions_age_structured} and the definitions for solvers of
time-since-entry-structured models
\eqref{definitions_time_since_entry_structured},
for $q \in \{\mathrm{new}, \mathrm{cur}\}$, let
\begin{subequations}
  \begin{align}
    \vec{x}^{\ell} &=
    \begin{bmatrix}
      M_0^{\ell} \\ \vdots \\ M_{J - 1}^{\ell} \\
      S_0^{\ell} \\ \vdots \\ S_{J - 1}^{\ell} \\
      e_{0, 0}^{\ell} \\ \vdots \\ e_{0, K - 1}^{\ell} \\ \vdots
      \\ e_{J - 1, 0}^{\ell} \\ \vdots \\ e_{J - 1, K - 1}^{\ell} \\
      i_{0, 0}^{\ell} \\ \vdots \\ i_{0, K - 1}^{\ell} \\ \vdots
      \\ i_{J - 1, 0}^{\ell} \\ \vdots \\ i_{J - 1, K - 1}^{\ell} \\
      R_0^{\ell} \\ \vdots \\ R_{J - 1}^{\ell}
    \end{bmatrix},
    \\
    \vec{0}_{az} &=
    \vec{0}_{a} \otimes \vec{0}_z,
    \\
    \vec{\beta} &=
    \beta
    \begin{bmatrix}
      \vec{0}_a
      & \vec{0}_a
      & \vec{0}_{az}
      & \vec{\iota}_a \otimes \vec{\iota}_z
      & \vec{0}_a
    \end{bmatrix},
    \\
    % \lambda^{\ell} &=
    % \vec{\beta} \vec{x}^{\ell},
    % \\
    \\
    \mat{0}_{a,az} &=
    \vec{0}_a^{\mathrm{T}} \vec{0}_{az},
    \\
    \mat{0}_{az,a} &=
    \vec{0}_{az}^{\mathrm{T}} \vec{0}_a,
    \\
    \mat{0}_{az,az} &=
    \vec{0}_{az}^{\mathrm{T}} \vec{0}_{az},
    \\
    \mat{H}_{az,q} &=
    \mat{H}_{a, q} \otimes \mat{H}_{z, q}
    \\
    \mat{H}_q &=
    \begin{bmatrix}
      \mat{H}_{a, q} & \mat{0} & \mat{0} & \mat{0} & \mat{0} \\
      \mat{0} & \mat{H}_{a, q} & \mat{0} & \mat{0} & \mat{0} \\
      \mat{0} & \mat{0} & \mat{H}_{az, q} & \mat{0} & \mat{0} \\
      \mat{0} & \mat{0} & \mat{0} & \mat{H}_{az, q} & \mat{0} \\
      \mat{0} & \mat{0} & \mat{0} & \mat{0} & \mat{H}_{a, q}
    \end{bmatrix},
    \\
    \mat{F}_{az, q}(\vec{\pi}, \vec{\xi}) &=
    \mat{F}_{a, q} (\vec{\pi}) \otimes \mat{H}_{z, q}
    + \mat{H}_{a, q} \otimes \mat{F}_{z, q}(\vec{\xi}),
    \\
    \mat{\Sigma}_{a, q}(\vec{\xi}) &=
    \mat{H}_{a, q} \otimes \vec{\sigma}_z(\vec{\xi}),
    \\
    \mat{\Sigma}_{az, q}(\vec{\xi}) &=
    \mat{\Sigma}_{a, q}(\vec{\xi}) \otimes \vec{\zeta}_z,
    \\
    \mat{F}_q &=
    \begin{bmatrix}
      \mat{F}_{a, q}(- \vec{\omega} - \vec{\mu}) & \mat{0} & \mat{0}
      & \mat{0} & \mat{0}
      \\
      \mat{F}_{a, q}(\vec{\omega}) & \mat{F}_{a, q}(- \vec{\mu})
      & \mat{0} & \mat{0} & \mat{0}
      \\
      \mat{0} & \mat{0} & \mat{F}_{az, q}(- \vec{\mu}, - \vec{\rho})
      & \mat{0} & \mat{0}
      \\
      \mat{0} & \mat{0} & \mat{\Sigma}_{az, q}(\vec{\rho})
      & \mat{F}_{az, q}(- \vec{\mu}, - \vec{\gamma}) & \mat{0}
      \\
      \mat{0} & \mat{0} & \mat{0} & \mat{\Sigma}_{a, q}(\vec{\gamma})
      & \mat{F}_{a, q}(- \vec{\mu})
    \end{bmatrix},
    \\
    \mat{B}_{az} &=
    \mat{B}_a \otimes \vec{\iota}_z
    \\
    \mat{B} &=
    \begin{bmatrix}
      \mat{0} & \mat{0} & \mat{0} & \mat{0} & \mat{B}_a \\
      \mat{B}_a & \mat{B}_a & \mat{B}_{az} & \mat{B}_{az} & \mat{0} \\
      \mat{0}_{az,a} & \mat{0} & \mat{0} & \mat{0} & \mat{0} \\
      \mat{0}_{az,a} & \mat{0} & \mat{0} & \mat{0} & \mat{0} \\
      \mat{0}_{a,a} & \mat{0} & \mat{0} & \mat{0} & \mat{0}
    \end{bmatrix},
    \\
    \mat{T}_{az,q} &=
    \mat{H}_{a, q} \otimes \vec{\zeta}_z,
    \\
    \mat{T}_q &=
    \begin{bmatrix}
      \mat{0}_{a,a} & \mat{0} & \mat{0}_{a,az} & \mat{0} & \mat{0} \\
      \mat{0} & - \mat{H}_{a, q} & \mat{0} & \mat{0} & \mat{0} \\
      \mat{0} & \mat{T}_{az, q} & \mat{0} & \mat{0} & \mat{0} \\
      \mat{0} & \mat{0} & \mat{0} & \mat{0}_{az,az} & \mat{0} \\
      \mat{0} & \mat{0} & \mat{0} & \mat{0} & \mat{0}_{a,a}
    \end{bmatrix},
  \end{align}
\end{subequations}
where $\otimes$ is the Kronecker product.
System \eqref{numerics_age_and_time_since_entry_structured} is then
\begin{subequations}
  \label{step_age_and_time_since_entry_structured}
  \begin{align}
    \mat{A}_q &=
    \begin{cases}
      \mat{H}_{\mathrm{new}} - \frac{\Delta t}{2} \mat{F}_{\mathrm{new}}
      & \text{if $q = \mathrm{new}$},
      \\
      \mat{H}_{\mathrm{cur}} + \frac{\Delta t}{2} \mat{F}_{\mathrm{cur}}
      & \text{if $q = \mathrm{cur}$},
    \end{cases}
    \\
    \left[
      \mat{A}_{\mathrm{new}}
      - \frac{\Delta t}{2} \left(
        b^{\ell - 1 / 2} \mat{B}
        + \vec{\beta} \vec{x}^{\ell} \mat{T}_{\mathrm{new}}
      \right)
    \right]
    \vec{x}^{\ell} &=
    \left[
      \mat{A}_{\mathrm{cur}}
      + \frac{\Delta t}{2} \left(
        b^{\ell - 1 / 2} \mat{B}
        + \vec{\beta} \vec{x}^{\ell} \mat{T}_{\mathrm{cur}}
      \right)
    \right]
    \vec{x}^{\ell - 1}.
  \end{align}
\end{subequations}
For each $\ell \in \{1, 2, \ldots, L\}$, I used a nonlinear
solver to find $\vec{x}^{\ell}$.


\appendix


\section{Age-structured total-population model}
\label{appendix_Floquet_theory}

For the models with age structure, the total population follows the
linear PDE
\begin{subequations}
  \begin{align}
    N(t, 0)
    &= b(t) \int_0^{+\infty} \nu(a) N(t, a) \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    N(t, a)
    &= - \mu(a) N(t, a).
  \end{align}
\end{subequations}
Because $b(t)$ is periodic with period $T = \unit[1]{y}$, I used
Floquet theory \autocite{parker_1992} to find the asymptotic
population growth rate and the stable age distribution. Floquet theory
requires the fundamental solution $\Phi(t, a, a')$ to
\begin{subequations}
  \begin{align}
    \Phi(t, 0, a')
    &= b(t) \int_0^{+\infty} \nu(a) \Phi(t, a, a') \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    \Phi(t, a, a')
    &= - \mu(a) \Phi(t, a, a'),
    \\
    \Phi(t_0, a, a')
    &= \delta(a - a'),
  \end{align}
\end{subequations}
where $\delta(x)$ is the Dirac delta.


\subsection{Numerical method}

To numerically solve the PDE for the fundamental solution, I used the
Crank--Nicolson method on characteristics and the composite rectangle
rule for the birth integral \autocite{milner_1992}.  Given the time
step $\Delta t$, let $a_j = j \Delta t$ and $a'_k = k \Delta t$ for
$j, k \in \{0, 1, 2, \ldots, J - 1\}$;
$t^{\ell} = t_0 + \ell \Delta t$ for
$\ell \in \{0, 1, \ldots, L\}$;
$\Phi_{j, k}^{\ell} \approx \Phi(t^{\ell}, a_j, a'_k)$;
$b^{\ell - 1 / 2} = b(t^{\ell - 1 / 2})$; and
$\pi_j = \pi(a_j)$ for $\pi \in \{\mu, \nu\}$.
For each $j$ and $k$ the initial condition is
\begin{subequations}
  \label{numerics_age_structured_fundamental}
  \begin{equation}
    \Phi_{j, k}^0 =
    \begin{cases}
      1 & \text{if $j = k$}, \\
      0 & \text{otherwise}.
    \end{cases}
  \end{equation}
  For each $1 \leq j \leq J - 2$, each $k$, and each $\ell
  \geq 1$, the Crank--Nicolson method on characteristics is
  \begin{align}
    \left(1 + \frac{\Delta t}{2} \mu_0\right)
    \Phi_{0, k}^{\ell}
    &= b^{\ell - 1 / 2}
    \sum_{j = 0}^{J - 1}
    \nu_j \frac{\Phi_{j, k}^{\ell} + \Phi_{j, k}^{\ell - 1}}{2}
    \Delta t,
    \\
    \frac{\Phi_{j, k}^{\ell} - \Phi_{j - 1, k}^{\ell - 1}}{\Delta t}
    &= - \frac{\mu_j \Phi_{j, k}^{\ell}
      + \mu_{j - 1} \Phi_{j - 1, k}^{\ell - 1}}{2},
    \\
    \begin{split}
      \frac{\Phi_{J - 1, k}^{\ell} - \Phi_{J - 2, k}^{\ell - 1}}{\Delta t}
      &= - \frac{\mu_{J - 1} \Phi_{J - 1, k}^{\ell}
        + \mu_{J - 2} \Phi_{J - 2, k}^{\ell - 1}}{2}
      \\
      & \quad {}
      + \frac{1}{\Delta t} \left(
        1 - \frac{\Delta t}{2} \mu_{J - 1}
      \right) \Phi_{J - 1, k}^{\ell - 1}.
    \end{split}
    \label{age_structured_pop_last}
  \end{align}
\end{subequations}
In equation \eqref{age_structured_pop_last}, the final term prevents
aging out of the last age group.


\subsubsection{Linear algebra}

Using the definitions for solvers of age-structured models
\eqref{definitions_age_structured},
for $q \in \{\mathrm{new}, \mathrm{cur}\}$, let
\begin{subequations}
  \begin{align}
    \mat{\Phi}^{\ell}
    &=
    \begin{bmatrix}
      \Phi_{0, 0}^{\ell} & \cdots & \Phi_{0, K - 1}^{\ell} \\
      \vdots & & \vdots \\
      \Phi_{J - 1, 0}^{\ell} & \cdots & \Phi_{J - 1, K - 1}^{\ell}
    \end{bmatrix},
    \\
    \mat{H}_q &= \mat{H}_{a, q},
    \\
    \mat{F}_q &= \mat{F}_{a, q}(-\vec{\mu}),
    \\
    \mat{B} &= \mat{B}_a.
  \end{align}
\end{subequations}
System \eqref{numerics_age_structured_fundamental} is then
\begin{subequations}
  \begin{align}
    \mat{A}_q &=
    \begin{cases}
      \mat{H}_{\mathrm{new}} - \frac{\Delta t}{2} \mat{F}_{\mathrm{new}}
      & \text{if $q = \mathrm{new}$},
      \\
      \mat{H}_{\mathrm{cur}} + \frac{\Delta t}{2} \mat{F}_{\mathrm{cur}}
      & \text{if $q = \mathrm{cur}$}.
    \end{cases}
    \\
    \left(
      \mat{A}_{\mathrm{new}}
      - \frac{\Delta t}{2} b^{\ell - 1 / 2} \mat{B}
    \right)
    \mat{\Phi}^{\ell} &=
    \left(
      \mat{A}_{\mathrm{cur}}
      + \frac{\Delta t}{2} b^{\ell - 1 / 2} \mat{B}
    \right)
    \mat{\Phi}^{\ell - 1}.
  \end{align}
\end{subequations}
For each $\ell \in \{1, 2, \ldots, L\}$, I used a linear solver
to find $\mat{\Phi}^{\ell}$.

Using this numerical scheme, I solved for the monodromy matrix, the
fundamental solution after one period:
\begin{equation}
  \mat{\Psi} =
  \begin{bmatrix}
    \Psi_{0, 0} & \cdots & \Psi_{0, J - 1} \\
    \vdots & & \vdots \\
    \Psi_{J - 1, 0} & \cdots & \Psi_{J - 1, J - 1}
  \end{bmatrix},
\end{equation}
where
\begin{equation}
  \Psi_{j, k} \approx \Phi(t_0 + T, a_j, a'_k).
\end{equation}
The monodromy matrix projects the population forward by one period,
\begin{equation}
  \vec{n}(t_0 + T) = \mat{\Psi} \vec{n}(t_0),
\end{equation}
where $\vec{n}(t) = [N(t, a_j)]$.
Using the monodromy matrix to repeatedly project the population
forward gives
\begin{equation}
  \vec{n}(t_0 + m T)
  = \mat{\Psi}^m \vec{n}(t_0)
  \to \rho_{\mathrm{dom}}^m \vec{w}_{\mathrm{dom}}
  = \me^{m r T} \vec{w}_{\mathrm{dom}}
\end{equation}
as $m \to +\infty$, where $\rho_{\mathrm{dom}}$ is the dominant eigenvalue,
i.e.~the eigenvalue with largest magnitude, of $\mat{\Psi}$;
the corresponding right eigenvector $\vec{w}_{\mathrm{dom}}$ is the
stable age distribution; and
\begin{equation}
  r = \frac{1}{T} \log \rho_{\mathrm{dom}}
\end{equation}
is the asymptotic population growth rate.

I used a nonlinear solver to find the mean birth rate $\tilde{b}$ that
gives population growth rate $r = 0$. Using this mean birth rate, the
population stable age distribution $\tilde{N}(a)$ is given by the
eigenvector $\vec{w}_{\mathrm{dom}}$:
\begin{equation}
  \tilde{N}(a_j) \approx w_{\mathrm{dom}, j}.
\end{equation}


\section{Jacobian}

The numerical methods for the MSEIR models require solving
\begin{equation}
  \label{step}
  \left[
    \mat{A}_{\mathrm{new}}
    - \frac{\Delta t}{2} \left(
      b^{\ell - 1 / 2} \mat{B}
      + \vec{\beta} \vec{x}^{\ell} \mat{T}_{\mathrm{new}}
    \right)
  \right]
  \vec{x}^{\ell}
  =
  \left[
    \mat{A}_{\mathrm{cur}}
    + \frac{\Delta t}{2} \left(
      b^{\ell - 1 / 2} \mat{B}
      + \vec{\beta} \vec{x}^{\ell} \mat{T}_{\mathrm{cur}}
    \right)
  \right]
  \vec{x}^{\ell - 1}.
\end{equation}
for $\vec{x}^{\ell}$ given $\vec{x}^{\ell - 1}$.
Taking the derivative of this equation with respect to
$\vec{x}^{\ell - 1}$ gives
\begin{multline}
  \left[
    \mat{A}_{\mathrm{new}}
    - \frac{\Delta t}{2}
    \left(
      b^{\ell - 1 / 2} \mat{B}
      + \vec{\beta} \vec{x}^{\ell} \mat{T}_{\mathrm{new}}
      + \mat{T}_{\mathrm{new}} \vec{x}^{\ell} \vec{\beta}
    \right)
  \right]
  \frac{\md \vec{x}^{\ell}}{\md \vec{x}^{\ell - 1}}
  \\
  = \mat{A}_{\mathrm{cur}}
  + \frac{\Delta t}{2}
  \left(
    b^{\ell - 1 / 2} \mat{B}
    + \vec{\beta} \vec{x}^{\ell - 1} \mat{T}_{\mathrm{cur}}
    + \mat{T}_{\mathrm{cur}} \vec{x}^{\ell - 1} \vec{\beta}
  \right),
\end{multline}
which, given $\vec{x}^{\ell}$ and $\vec{x}^{\ell - 1}$,
can be solved for $\frac{\md \vec{x}^{\ell}}{\md \vec{x}^{\ell - 1}}$.
The Jacobian is then
\begin{equation}
  \begin{split}
    \mat{J}\left(t^{\ell - 1}, \vec{x}^{\ell}, \vec{x}^{\ell - 1}\right)
    &= \frac{\md}{\md \vec{x}^{\ell - 1}}
      \left(
      \frac{\vec{x}^{\ell} - \vec{x}^{\ell - 1}}{\Delta t}
      \right)
    \\
    &= \frac{1}{\Delta t} \left(
      \frac{\md \vec{x}^{\ell}}{\md \vec{x}^{\ell - 1}}
      - \mat{I}
      \right).
  \end{split}
\end{equation}


\section{Aggregated models}


\subsection{Unstructured model}


\subsubsection{Aggregating over immune state}

Summing model \eqref{model_unstructured} over immune state gives
\begin{equation}
  \label{model_unstructured_agg_state}
  \frac{\md}{\md t} N(t)
  = b(t) N(t) - \mu N(t).
\end{equation}

Summing numerical method \eqref{numerics_unstructured} over
immune state gives
\begin{equation}
  \label{numerics_unstructured_agg_state}
  \frac{N^{\ell} - N^{\ell - 1}}{\Delta t}
  = b^{\ell - 1 / 2} \frac{N^{\ell} + N^{\ell - 1}}{2}
  - \mu \frac{N^{\ell} + N^{\ell - 1}}{2},
\end{equation}
which is identical to our Crank--Nicolson scheme applied to aggregated
model \eqref{model_unstructured_agg_state}.


\subsection{Age-structured model}


\subsubsection{Aggregating over immune state}

Summing model \eqref{model_age_structured} over immune state gives
\begin{subequations}
  \label{model_age_structured_agg_state}
  \begin{align}
    N(t, 0)
    &= b(t) \int_0^{+\infty} \nu(a) N(t, a) \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    N(t, a)
    &= - \mu(a) N(t, a).
  \end{align}
\end{subequations}

Summing numerical method \eqref{numerics_age_structured} over immune
state gives
\begin{subequations}
  \label{numerics_age_structured_agg_state}
  \begin{align}
    \left[1 + \frac{\Delta t}{2} \mu_0\right] N_0^{\ell}
    &= b^{\ell - 1 / 2}
    \sum_{j = 0}^{J - 1} \nu_j \frac{N_j^{\ell} + N_j^{\ell - 1}}{2} \Delta t,
    \\
    \frac{N_j^{\ell} - N_{j - 1}^{\ell - 1}}{\Delta t}
    &= - \frac{\mu_j N_j^{\ell} + \mu_{j - 1} N_{j - 1}^{\ell - 1}}{2},
    \\
    \begin{split}
      \frac{N_{J - 1}^{\ell} - N_{J - 2}^{\ell - 1}}{\Delta t}
      &= - \frac{\mu_{J - 1} N_{J - 1}^{\ell} + \mu_{J - 2} N_{J - 2}^{\ell - 1}}{2}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} \mu_{J - 1}
      \right] N_{J - 1}^{\ell - 1},
    \end{split}
  \end{align}
\end{subequations}
which is identical to our Crank--Nicolson scheme applied to aggregated
model \eqref{model_age_structured_agg_state}.


\paragraph{Aggregating over age}

Let
\begin{subequations}
  \begin{align}
    \bar{N}(t)
    &= \int_0^{+\infty} N(t, a) \md a,
    \\
    \bar{\mu}_N(t)
    &= \frac{\int_0^{+\infty} \mu(a) N(t, a) \md a}
    {\int_0^{+\infty} N(t, a) \md a},
    \\
    \bar{\nu}_N(t)
    &= \frac{\int_0^{+\infty} \nu(a) N(t, a) \md a}
    {\int_0^{+\infty} N(t, a) \md a}.
  \end{align}
\end{subequations}
Then integrating model \eqref{model_age_structured_agg_state} over age
gives
\begin{equation}
  \label{model_age_structured_agg_state_age}
  \frac{\md}{\md t} \bar{N}(t)
  = b(t) \bar{\nu}_N(t) \bar{N}(t)
  - \bar{\mu}_N(t) \bar{N}(t).
\end{equation}

Let
\begin{subequations}
  \begin{align}
    \bar{N}^{\ell}
    &= \sum_{j = 0}^{J - 1} N_j^{\ell} \Delta t,
    \\
    \bar{\mu}^{\ell}
    &= \frac{\sum_{j = 0}^{J - 1} \mu_j N_j^{\ell} \Delta t}
    {\sum_{j = 0}^{J - 1} N_j^{\ell} \Delta t},
    \\
    \bar{\nu}^{\ell}
    &= \frac{\sum_{j = 0}^{J - 1} \nu_j N_j^{\ell} \Delta t}
    {\sum_{j = 0}^{J - 1} N_j^{\ell} \Delta t}.
  \end{align}
\end{subequations}
Then summing numerical method
\eqref{numerics_age_structured_agg_state} over age gives
\begin{equation}
  \label{numerics_age_structured_agg_state_age}
  \frac{\bar{N}^{\ell} - \bar{N}^{\ell - 1}}{\Delta t}
  = b^{\ell - 1 / 2}
  \frac{\bar{\nu}^{\ell} \bar{N}^{\ell}
    + \bar{\nu}^{\ell - 1} \bar{N}^{\ell - 1}}{2}
  - \frac{\bar{\mu}^{\ell} \bar{N}^{\ell}
    + \bar{\mu}^{\ell - 1} \bar{N}^{\ell - 1}}{2},
\end{equation}
which is identical to our Crank--Nicolson scheme applied to aggregated
model \eqref{model_age_structured_agg_state_age}.


\subsubsection{Aggregating over age}

Let
\begin{subequations}
  \begin{align}
    \bar{M}(t) &= \int_0^{+\infty} M(t, a) \md a,
    \\
    \bar{S}(t) &= \int_0^{+\infty} S(t, a) \md a,
    \\
    \bar{E}(t) &= \int_0^{+\infty} E(t, a) \md a,
    \\
    \bar{I}(t) &= \int_0^{+\infty} I(t, a) \md a,
    \\
    \bar{R}(t) &= \int_0^{+\infty} R(t, a) \md a,
    \\
    \bar{\mu}_X(t)
    &= \frac{\int_0^{+\infty} \mu(a) X(t, a) \md a}
    {\int_0^{+\infty} X(t, a) \md a},
    \\
    \bar{\nu}_X(t)
    &= \frac{\int_0^{+\infty} \nu(a) X(t, a) \md a}
    {\int_0^{+\infty} X(t, a) \md a}.
  \end{align}
\end{subequations}
Then integrating model \eqref{model_age_structured} over age gives
\begin{subequations}
  \label{model_age_structured_agg_age}
  \begin{align}
    \frac{\md}{\md t} \bar{M}(t)
    &= b(t) \bar{\nu}_R(t) \bar{R}(t)
    - \left[\omega + \bar{\mu}_M(t)\right] \bar{M}(t),
    \\
    \frac{\md}{\md t} \bar{S}(t)
    &= b(t) \left[
      \bar{\nu}_N(t) \bar{N}(t)
      - \bar{\nu}_R(t) \bar{R}(t)
    \right]
    + \omega \bar{M}(t)
    - \left[\lambda(t) + \bar{\mu}_S(t)\right] \bar{S}(t),
    \\
    \frac{\md}{\md t} \bar{E}(t)
    &= \lambda(t) \bar{S}(t)
    - \left[\rho + \bar{\mu}_E(t)\right] \bar{E}(t),
    \\
    \frac{\md}{\md t} \bar{I}(t)
    &= \rho \bar{E}(t)
    - \left[\gamma + \bar{\mu}_I(t)\right] \bar{I}(t),
    \\
    \frac{\md}{\md t} \bar{R}(t)
    &= \gamma \bar{I}(t)
    - \bar{\mu}_R(t) \bar{R}(t).
  \end{align}
\end{subequations}

Let
\begin{subequations}
  \begin{align}
    \bar{M}^{\ell}
    &= \sum_{j = 0}^{J - 1} M_j^{\ell} \Delta t,
    \\
    \bar{S}^{\ell}
    &= \sum_{j = 0}^{J - 1} S_j^{\ell} \Delta t,
    \\
    \bar{E}^{\ell}
    &= \sum_{j = 0}^{J - 1} E_j^{\ell} \Delta t,
    \\
    \bar{I}^{\ell}
    &= \sum_{j = 0}^{J - 1} I_j^{\ell} \Delta t,
    \\
    \bar{R}^{\ell}
    &= \sum_{j = 0}^{J - 1} R_j^{\ell} \Delta t,
    \\
    \bar{\mu}_X^{\ell}
    &= \frac{\sum_{j = 0}^{J - 1} \mu_j X_j^{\ell} \Delta t}
      {\sum_{j = 0}^{J - 1} X_j^{\ell} \Delta t},
    \\
    \bar{\nu}_X^{\ell}
    &= \frac{\sum_{j = 0}^{J - 1} \nu_j X_j^{\ell} \Delta t}
    {\sum_{j = 0}^{J - 1} X_j^{\ell} \Delta t}.
  \end{align}
\end{subequations}
Then summing numerical method
\eqref{numerics_age_structured} over age gives
\begin{subequations}
  \label{numerics_age_structured_agg_age}
  \begin{align}
    \begin{split}
      \frac{\bar{M}^{\ell} - \bar{M}^{\ell - 1}}{\Delta t}
      &= - \frac{(\omega + \bar{\mu}_M^{\ell}) \bar{M}^{\ell}
        + (\omega + \bar{\mu}_M^{\ell - 1}) \bar{M}^{\ell - 1}}{2}
      \\ & \quad {}
      + b^{\ell - 1 / 2}
      \frac{\bar{\nu}_R^{\ell} \bar{R}^{\ell}
        + \bar{\nu}_R^{\ell - 1} \bar{R}^{\ell - 1}}{2},
    \end{split}
    \\
    \begin{split}
      \frac{\bar{S}^{\ell} - \bar{S}^{\ell - 1}}{\Delta t}
      &= \omega \frac{\bar{M}^{\ell} + \bar{M}^{\ell - 1}}{2}
      \\ & \quad {}
      - \frac{(\lambda^{\ell} + \bar{\mu}_S^{\ell}) \bar{S}^{\ell}
        + (\lambda^{\ell - 1} + \bar{\mu}_S^{\ell - 1}) \bar{S}^{\ell - 1}}{2}
      \\ & \quad {}
      + b^{\ell - 1 / 2}
      \frac{\bar{\nu}_N^{\ell} \bar{N}^{\ell}
        - \bar{\nu}_R^{\ell} \bar{R}^{\ell}
        + \bar{\nu}_N^{\ell - 1} \bar{N}^{\ell - 1}
        - \bar{\nu}_N^{\ell - 1} \bar{R}^{\ell - 1}}{2},
    \end{split}
    \\
    \frac{\bar{E}^{\ell} - \bar{E}^{\ell - 1}}{\Delta t}
    &= \frac{\lambda^{\ell} \bar{S}^{\ell}
      + \lambda^{\ell - 1} \bar{S}^{\ell - 1}}{2}
    - \frac{(\rho + \bar{\mu}_E^{\ell}) \bar{E}^{\ell}
      + (\rho + \bar{\mu}_E^{\ell - 1}) \bar{E}^{\ell - 1}}{2},
    \\
    \frac{\bar{I}^{\ell} - \bar{I}^{\ell - 1}}{\Delta t}
    &= \rho \frac{\bar{E}^{\ell} + \bar{E}^{\ell - 1}}{2}
    - \frac{(\gamma + \bar{\mu}_I^{\ell}) \bar{I}^{\ell}
      + (\gamma + \bar{\mu}_I^{\ell - 1}) \bar{I}^{\ell - 1}}{2},
    \\
    \frac{\bar{R}^{\ell} - \bar{R}^{\ell - 1}}{\Delta t}
    &= \gamma \frac{\bar{I}^{\ell} + \bar{I}^{\ell - 1}}{2}
    - \frac{\bar{\mu}_R^{\ell} \bar{R}^{\ell}
      + \bar{\mu}_R^{\ell - 1} \bar{R}^{\ell - 1}}{2},
  \end{align}
\end{subequations}
which is identical to our Crank--Nicolson scheme applied to aggregated
model \eqref{model_age_structured_agg_age}.


\paragraph{Aggregating over immune state}

Let
\begin{equation}
  \bar{N}(t)
  = \bar{M}(t) + \bar{S}(t) + \bar{E}(t) + \bar{I}(t) + \bar{R}(t).
\end{equation}
Then summing model \eqref{model_age_structured_agg_age} over immune
state gives
\begin{equation}
  \label{model_age_structured_agg_age_state}
  \frac{\md}{\md t} \bar{N}(t)
  = b(t) \bar{\nu}_N(t) \bar{N}(t)
  - \bar{\mu}_N(t) \bar{N}(t).
\end{equation}


Let
\begin{equation}
  \bar{N}^{\ell}
  = \bar{M}^{\ell} + \bar{S}^{\ell} + \bar{E}^{\ell}
 + \bar{I}^{\ell} + \bar{R}^{\ell}.
\end{equation}
Then summing numerical method
\eqref{numerics_age_structured_agg_age} over immune state gives
\begin{equation}
  \label{numerics_age_structured_agg_age_state}
  \frac{\bar{N}^{\ell} - \bar{N}^{\ell - 1}}{\Delta t}
  = b^{\ell - 1 / 2}
  \frac{\bar{\nu}_N^{\ell} \bar{N}^{\ell}
  + \bar{\nu}_N^{\ell - 1} \bar{N}^{\ell - 1}}{2}
  - \frac{\bar{\mu}_N^{\ell} \bar{N}^{\ell}
  + \bar{\mu}_N^{\ell - 1} \bar{N}^{\ell - 1}}{2},
\end{equation}
which is identical to our Crank--Nicolson scheme applied to aggregated
model \eqref{model_age_structured_agg_age_state}.


\subsection{Time-since-entry-structured model}


\subsubsection{Aggregating over time since entry}

Let
\begin{subequations}
  \begin{align}
    M(t)
    &= \int_0^{+\infty} m(t, z) \md z,
    \\
    E(t)
    &= \int_0^{+\infty} e(t, z) \md z,
    \\
    I(t)
    &= \int_0^{+\infty} i(t, z) \md z,
    \\
    \hat{\omega}(t)
    &= \frac{\int_0^{+\infty} \omega(z) m(t, z) \md z}
      {\int_0^{+\infty} m(t, z) \md z},
    \\
    \hat{\rho}(t)
    &= \frac{\int_0^{+\infty} \rho(z) e(t, z) \md z}
      {\int_0^{+\infty} e(t, z) \md z},
    \\
    \hat{\gamma}(t)
    &= \frac{\int_0^{+\infty} \gamma(z) i(t, z) \md z}
      {\int_0^{+\infty} i(t, z) \md z}.
  \end{align}
\end{subequations}
Then integrating model \eqref{model_time_since_entry_structured} over
time since entry gives
\begin{subequations}
  \label{model_time_since_entry_structured_agg_tse}
  \begin{align}
    \frac{\md}{\md t} M(t)
    &= b(t) R(t)
    - \left[\hat{\omega}(t) + \mu\right] M(t),
    \\
    \frac{\md}{\md t} S(t)
    &= b(t) \left[N(t) - R(t)\right]
    + \hat{\omega}(t) M(t)
    - [\lambda(t) + \mu] S(t),
    \\
    \frac{\md}{\md t} E(t)
    &= \lambda(t) S(t)
    - \left[\hat{\rho}(t) + \mu\right] E(t),
    \\
    \frac{\md}{\md t} I(t)
    &= \hat{\rho}(t) E(t)
    - \left[\hat{\gamma}(t) + \mu\right] I(t),
    \\
    \frac{\md}{\md t} R(t)
    &= \hat{\gamma}(t) I(t)
    - \mu R(t).
  \end{align}
\end{subequations}

Let
\begin{subequations}
  \begin{align}
    M^{\ell}
    &= \sum_{k = 0}^{K - 1} m_k^{\ell} \Delta t,
    \\
    E^{\ell}
    &= \sum_{k = 0}^{K - 1} e_k^{\ell} \Delta t,
    \\
    I^{\ell}
    &= \sum_{k = 0}^{K - 1} i_k^{\ell} \Delta t,
    \\
    \hat{\omega}^{\ell}
    &= \frac{\sum_{k = 0}^{K - 1} \omega_k m_k^{\ell} \Delta t}
      {\sum_{k = 0}^{K - 1} m_k^{\ell} \Delta t},
    \\
    \hat{\rho}^{\ell}
    &= \frac{\sum_{k = 0}^{K - 1} \rho_k e_k^{\ell} \Delta t}
      {\sum_{k = 0}^{K - 1} e_k^{\ell} \Delta t},
    \\
    \hat{\gamma}^{\ell}
    &= \frac{\sum_{k = 0}^{K - 1} \gamma_k i_k^{\ell} \Delta t}
      {\sum_{k = 0}^{K - 1} i_k^{\ell} \Delta t}.
  \end{align}
\end{subequations}
Then summing numerical method
\eqref{numerics_time_since_entry_structured} over time since entry
gives
\begin{subequations}
  \label{numerics_time_since_entry_structured_agg_tse}
  \begin{align}
    \frac{M^{\ell}  - M^{\ell - 1}}{\Delta t}
    &= - \frac{(\hat{\omega}^{\ell} + \mu) M^{\ell}
      + (\hat{\omega}^{\ell - 1} + \mu) M^{\ell - 1}}{2}
      + b^{\ell - 1 / 2} \frac{R^{\ell} + R^{\ell - 1}}{2},
    \\
    \begin{split}
      \frac{S^{\ell} - S^{\ell - 1}}{\Delta t}
      &= b^{\ell - 1 / 2}
      \frac{N^{\ell} - R^{\ell} + N^{\ell - 1} - R^{\ell - 1}}{2}
      + \frac{\hat{\omega}^{\ell} M^{\ell}
        + \hat{\omega}^{\ell - 1} M^{\ell - 1}}{2}
      \\ & \quad {}
      - \frac{(\lambda^{\ell} + \mu) S^{\ell}
        + (\lambda^{\ell - 1} + \mu) S^{\ell - 1}}{2},
    \end{split}
    \\
    \frac{E^{\ell}  - E^{\ell - 1}}{\Delta t}
    &= - \frac{(\hat{\rho}^{\ell} + \mu) E^{\ell}
      + (\hat{\rho}^{\ell - 1} + \mu) E^{\ell - 1}}{2}
      + \frac{\lambda^{\ell} S^{\ell}
      + \lambda^{\ell - 1} S^{\ell - 1}}{2},
    \\
    \frac{I^{\ell}  - I^{\ell - 1}}{\Delta t}
    &= - \frac{(\hat{\gamma}^{\ell} + \mu) I^{\ell}
      + (\hat{\gamma}^{\ell - 1} + \mu) I^{\ell - 1}}{2}
      + \frac{\hat{\rho}^{\ell} E^{\ell}
      + \hat{\rho}^{\ell - 1} E^{\ell - 1}}{2},
    \\
    \frac{R^{\ell} - R^{\ell - 1}}{\Delta t}
    &= \frac{\hat{\gamma}^{\ell} I^{\ell}
      + \hat{\gamma}^{\ell - 1} I^{\ell - 1}}{2}
      - \mu \frac{R^{\ell} + R^{\ell - 1}}{2},
  \end{align}
\end{subequations}
which is identical to our Crank--Nicolson scheme applied to aggregated
model \eqref{model_time_since_entry_structured_agg_tse}.


\paragraph{Aggregating over immune state}

Let
\begin{equation}
  N(t)
  = M(t) + S(t) + E(t) + I(t) + R(t).
\end{equation}
Then summing model \eqref{model_time_since_entry_structured_agg_tse}
over immune state gives
\begin{equation}
  \label{model_time_since_entry_structured_agg_tse_state}
  \frac{\md}{\md t} N(t)
  = b(t) N(t) - \mu N(t).
\end{equation}

Let
\begin{equation}
  N^{\ell}
  = M^{\ell} + S^{\ell} + E^{\ell} + I^{\ell} + R^{\ell}.
\end{equation}
Then summing numerical method
\eqref{numerics_time_since_entry_structured_agg_tse} over immune state
gives
\begin{equation}
  \label{numerics_time_since_entry_structured_agg_tse_state}
  \frac{N^{\ell} - N^{\ell - 1}}{\Delta t}
  = b^{\ell - 1 / 2} \frac{N^{\ell} + N^{\ell - 1}}{2}
  - \mu \frac{N^{\ell} + N^{\ell - 1}}{2},
\end{equation}
which is identical to our Crank--Nicolson scheme applied to aggregated
model \eqref{model_time_since_entry_structured_agg_tse_state}.



\subsection{Age- and time-since-entry-structured model}


\subsubsection{Aggregating over time since entry}

Let
\begin{subequations}
  \begin{align}
    E(t, a)
    &= \int_0^{+\infty} e(t, a, z) \md z,
    \\
    I(t, a)
    &= \int_0^{+\infty} i(t, a, z) \md z,
    \\
    \hat{\rho}(t, a)
    &= \frac{\int_0^{+\infty} \rho(z) e(t, a, z) \md z}
      {\int_0^{+\infty} e(t, a, z) \md z},
    \\
    \hat{\gamma}(t, a)
    &= \frac{\int_0^{+\infty} \gamma(z) i(t, a, z) \md z}
      {\int_0^{+\infty} i(t, a, z) \md z}.
  \end{align}
\end{subequations}
Then integrating model
\eqref{model_age_and_time_since_entry_structured} over time since
entry gives
\begin{subequations}
  \label{model_age_and_time_since_entry_structured_agg_tse}
  \begin{align}
    M(t, 0) &=
    b(t) \int_0^{+\infty} \nu(a) R(t, a) \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    M(t, a) &=
    - \omega(a) M(t, a) - \mu(a) M(t, a),
    \\
    S(t, 0) &=
    b(t) \int_0^{+\infty} \nu(a) \left[N(t, a) - R(t, a)\right] \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    S(t, a) &=
    \omega(a) M(t, a) - \lambda(t) S(t, a) - \mu(a) S(t, a),
    \\
    E(t, 0) &= 0,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    E(t, a)
    &= \lambda(t) S(t, a)
    - \hat{\rho}(t, a) E(t, a) - \mu(a) E(t, a),
    \\
    I(t, 0) &= 0,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    I(t, a)
    &= \hat{\rho}(t, a) E(t, a)
    - \hat{\gamma}(t, a) I(t, a) - \mu(a) I(t, a),
    \\
    R(t, 0) &= 0,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    R(t, a)
    &= \hat{\gamma}(t, a) I(t, a) - \mu(a) R(t, a).
  \end{align}
\end{subequations}

Let
\begin{subequations}
  \begin{align}
    E_j^{\ell}
    &= \sum_{k = 0}^{K - 1} e_{j, k}^{\ell} \Delta t,
    \\
    I_j^{\ell}
    &= \sum_{k = 0}^{K - 1} i_{j, k}^{\ell} \Delta t,
    \\
    \hat{\rho}_j^{\ell}
    &= \frac{\sum_{k = 0}^{K - 1} \rho_k e_{j, k}^{\ell} \Delta t}
      {\sum_{k = 0}^{K - 1} e_{j, k}^{\ell} \Delta t},
    \\
    \hat{\gamma}_j^{\ell}
    &= \frac{\sum_{k = 0}^{K - 1} \gamma_k i_{j, k}^{\ell} \Delta t}
      {\sum_{k = 0}^{K - 1} i_{j, k}^{\ell} \Delta t}.
  \end{align}
\end{subequations}
Then summing numerical method
\eqref{numerics_age_and_time_since_entry_structured} over time since
entry gives
\begin{subequations}
  \label{numerics_age_and_time_since_entry_structured_agg_tse}
  \begin{align}
    \left[1 + \frac{\Delta t}{2} (\omega_0 + \mu_0)\right] M_0^{\ell}
    &= b^{\ell - 1 / 2}
    \sum_{j = 0}^{J - 1} \nu_j \frac{R_j^{\ell} + R_j^{\ell - 1}}{2}
    \Delta t,
    \\
    \frac{M_j^{\ell} - M_{j - 1}^{\ell - 1}}{\Delta t}
    &=
    - \frac{(\omega_j + \mu_j) M_j^{\ell}
      + (\omega_{j - 1} + \mu_{j - 1}) M_{j - 1}^{\ell - 1}}
    {2},
    \\
    \begin{split}
      \frac{M_{J - 1}^{\ell} - M_{J - 2}^{\ell - 1}}{\Delta t}
      &= - \frac{(\omega_{J - 1} + \mu_{J - 1}) M_{J - 1}^{\ell}
        + (\omega_{J - 2} + \mu_{J - 2}) M_{J - 2}^{\ell - 1}}
      {2}
      \\ & \quad {}
      +  \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\omega_{J - 1} + \mu_{J - 1})
      \right] M_{J - 1}^{\ell - 1},
    \end{split}
    \\
    \begin{split}
      \left[1 + \frac{\Delta t}{2} (\lambda^{\ell} + \mu_0)\right] S_0^{\ell}
      &= b^{\ell - 1 / 2}
      \sum_{j = 0}^{J - 1} \nu_j
      \frac{N_j^{\ell} - R_j^{\ell} + N_j^{\ell - 1} - R_j^{\ell - 1}}
      {2}
      \Delta t
      \\ & \quad {}
      + \frac{\Delta t}{2} \omega_0 M_0^{\ell},
    \end{split}
    \\
    \begin{split}
      \frac{S_j^{\ell} - S_{j - 1}^{\ell - 1}}{\Delta t}
      &= \frac{\omega_j M_j^{\ell}
        + \omega_{j - 1} M_{j - 1}^{\ell - 1}}
      {2}
      \\ & \quad {}
      - \frac{(\lambda^{\ell} + \mu_j) S_j^{\ell}
        + (\lambda^{\ell - 1} + \mu_{j - 1}) S_{j - 1}^{\ell - 1}}
      {2},
    \end{split}
    \\
    \begin{split}
      \frac{S_{J - 1}^{\ell} - S_{J - 2}^{\ell - 1}}{\Delta t}
      &= \frac{\omega_{J - 1} M_{J - 1}^{\ell}
        + \omega_{J - 2} M_{J - 2}^{\ell - 1}}
      {2}
      \\ & \quad {}
      - \frac{(\lambda^{\ell} + \mu_{J - 1}) S_{J - 1}^{\ell}
        + (\lambda^{\ell - 1} + \mu_{J - 2}) S_{J - 2}^{\ell - 1}}
      {2}
      \\ & \quad {}
      + \frac{1}{2} \omega_{J - 1} M_{J - 1}^{\ell - 1}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\lambda^{\ell - 1} + \mu_{J - 1})
      \right] S_{J - 1}^{\ell - 1},
    \end{split}
    \\
    \left[1 + \frac{\Delta t}{2} (\hat{\rho}_0^{\ell} + \mu_0)\right]
    E_0^{\ell}
    &= \frac{\Delta t}{2} \lambda^{\ell} S_0^{\ell},
    \\
    \begin{split}
      \frac{E_j^{\ell} - E_{j - 1}^{\ell - 1}}{\Delta t}
      &= \frac{\lambda^{\ell} S_j^{\ell}
        + \lambda^{\ell - 1} S_{j - 1}^{\ell - 1}}
      {2}
      \\ & \quad {}
      - \frac{(\hat{\rho}_j^{\ell} + \mu_j) E_j^{\ell}
        + (\hat{\rho}_{j - 1}^{\ell - 1} + \mu_{j - 1}) E_{j - 1}^{\ell - 1}}
      {2},
    \end{split}
    \\
    \begin{split}
      \frac{E_{J - 1}^{\ell} - E_{J - 2}^{\ell - 1}}{\Delta t}
      &= \frac{\lambda^{\ell} S_{J - 1}^{\ell}
        + \lambda^{\ell - 1} S_{J - 2}^{\ell - 1}}
      {2}
      \\ & \quad {}
      - \frac{(\hat{\rho}_{J - 1}^{\ell} + \mu_{J - 1}) E_{J - 1}^{\ell}
        + (\hat{\rho}_{J - 2}^{\ell - 1} + \mu_{J - 2}) E_{J - 2}^{\ell - 1}}
      {2}
      \\ & \quad {}
      + \frac{\lambda^{\ell - 1} S_{J - 1}^{\ell - 1}}{2}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\hat{\rho}_{J - 1}^{\ell - 1} + \mu_{J - 1})
      \right] E_{J - 1}^{\ell - 1},
    \end{split}
    \\
    \left[1 + \frac{\Delta t}{2} (\hat{\gamma}_0^{\ell} + \mu_0)\right]
    I_0^{\ell}
    &= \frac{\Delta t}{2} \hat{\rho}_0^{\ell} E_0^{\ell},
    \\
    \begin{split}
      \frac{I_j^{\ell} - I_{j - 1}^{\ell - 1}}{\Delta t}
      &= \frac{\hat{\rho}_j^{\ell} E_j^{\ell}
        + \hat{\rho}_{j - 1}^{\ell - 1} E_{j - 1}^{\ell - 1}} {2}
      \\ & \quad {}
      - \frac{(\hat{\gamma}_j^{\ell} + \mu_j) I_j^{\ell}
        + (\hat{\gamma}_{j - 1}^{\ell - 1} + \mu_{j - 1}) I_{j - 1}^{\ell - 1}}
      {2},
    \end{split}
    \\
    \begin{split}
      \frac{I_{J - 1}^{\ell} - I_{J - 2}^{\ell - 1}}{\Delta t}
      &= \frac{\hat{\rho}_{J - 1}^{\ell} E_{J - 1}^{\ell}
        + \hat{\rho}_{J - 2}^{\ell - 1} E_{J - 2}^{\ell - 1}} {2}
      \\ & \quad {}
      - \frac{(\hat{\gamma}_{J - 1}^{\ell} + \mu_{J - 1}) I_{J - 1}^{\ell}
        + (\hat{\gamma}_{J - 2}^{\ell - 1} + \mu_{J - 2}) I_{J - 2}^{\ell - 1}}
      {2}
      \\ & \quad {}
      + \frac{\hat{\rho}_{J - 1}^{\ell - 1} E_{J - 1}^{\ell - 1}} {2}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\hat{\gamma}_{J - 1}^{\ell - 1} + \mu_{J - 1})
      \right] I_{J - 1}^{\ell - 1},
    \end{split}
    \\
    \left[1 + \frac{\Delta t}{2} \mu_0\right] R_0^{\ell}
    &= \frac{\Delta t}{2} \hat{\gamma}_0^{\ell} I_0^{\ell},
    \\
    \frac{R_j^{\ell} - R_{j - 1}^{\ell - 1}}{\Delta t}
    &= \frac{\hat{\gamma}_j^{\ell} I_j^{\ell}
      + \hat{\gamma}_{j - 1}^{\ell - 1} I_{j - 1}^{\ell - 1}}
      {2}
      - \frac{\mu_j R_j^{\ell}
      + \mu_{j - 1} R_{j - 1}^{\ell - 1}}
      {2},
    \\
    \begin{split}
      \frac{R_{J - 1}^{\ell} - R_{J - 2}^{\ell - 1}}{\Delta t}
      &= \frac{\hat{\gamma}_{J - 1}^{\ell} I_{J - 1}^{\ell}
        + \hat{\gamma}_{J - 2}^{\ell - 1} I_{J - 2}^{\ell - 1}}
      {2}
      \\ & \quad {}
      - \frac{\mu_{J - 1} R_{J - 1}^{\ell}
        + \mu_{J - 2} R_{J - 2}^{\ell - 1}}
      {2}
      \\ & \quad {}
      + \frac{\hat{\gamma}_{J - 1}^{\ell - 1} I_{J - 1}^{\ell - 1}}{2}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} \mu_{J - 1}
      \right] R_{J - 1}^{\ell - 1},
    \end{split}
  \end{align}
\end{subequations}
which is identical to our Crank--Nicolson scheme applied to aggregated
model \eqref{model_age_and_time_since_entry_structured_agg_tse}.


\paragraph{Aggregating over immune state}

Let
\begin{equation}
  N(t, a)
  = M(t, a) + S(t, a) + E(t, a) + I(t, a) + R(t, a).
\end{equation}
Then summing model
\eqref{model_age_and_time_since_entry_structured_agg_tse} over immune
state gives
\begin{subequations}
  \label{model_age_and_time_since_entry_structured_agg_tse_state}
  \begin{align}
    N(t, 0)
    &= b(t) \int_0^{+\infty} \nu(a) N(t, a) \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    N(t, a)
    &= - \mu(a) N(t, a).
  \end{align}
\end{subequations}

Let
\begin{equation}
  N_j^{\ell}
  = M_j^{\ell} + S_j^{\ell} + E_j^{\ell} + I_j^{\ell} + R_j^{\ell}.
\end{equation}
Then summing numerical method
\eqref{numerics_age_and_time_since_entry_structured_agg_tse} over
immune state gives
\begin{subequations}
  \label{numerics_age_and_time_since_entry_structured_agg_tse_state}
  \begin{align}
    \left[1 + \frac{\Delta t}{2} \mu_0\right] N_0^{\ell}
    &= b^{\ell - 1 / 2}
    \sum_{j = 0}^{J - 1} \nu_j \frac{N_j^{\ell} + N_j^{\ell - 1}}{2}
    \Delta t,
    \\
    \frac{N_j^{\ell} - N_{j - 1}^{\ell - 1}}{\Delta t}
    &= - \frac{\mu_j N_j^{\ell} + \mu_{j - 1} N_{j - 1}^{\ell - 1}}{2},
    \\
    \begin{split}
      \frac{N_{J - 1}^{\ell} - N_{J - 2}^{\ell - 1}}{\Delta t}
      &= - \frac{\mu_{J - 1} N_{J - 1}^{\ell}
        + \mu_{J - 2} N_{J - 2}^{\ell - 1}}
      {2}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} \mu_{J - 1}
      \right] N_{J - 1}^{\ell - 1},
    \end{split}
  \end{align}
\end{subequations}
which is identical to our Crank--Nicolson scheme applied to aggregated
model \eqref{model_age_and_time_since_entry_structured_agg_tse_state}.


\subparagraph{Aggregating over age}

Let
\begin{subequations}
  \begin{align}
    \bar{N}(t)
    &= \int_0^{+\infty} N(t, a) \md a,
    \\
    \bar{\mu}_N(t)
    &= \frac{\int_0^{+\infty} \mu(a) N(t, a) \md a}
    {\int_0^{+\infty} N(t, a) \md a},
    \\
    \bar{\nu}_N(t)
    &= \frac{\int_0^{+\infty} \nu(a) N(t, a) \md a}
    {\int_0^{+\infty} N(t, a) \md a}.
  \end{align}
\end{subequations}
Then integrating model
\eqref{model_age_and_time_since_entry_structured_agg_tse_state} over
age gives
\begin{equation}
  \label{model_age_and_time_since_entry_structured_agg_tse_state_age}
  \frac{\md}{\md t} \bar{N}(t)
  = b(t) \bar{\nu}_N(t) \bar{N}(t)
  - \bar{\mu}_N(t) \bar{N}(t).
\end{equation}

Let
\begin{subequations}
  \begin{align}
    \bar{N}^{\ell}
    &= \sum_{j = 0}^{J - 1} N_j^{\ell} \Delta t,
    \\
    \bar{\mu}_N^{\ell}
    &= \frac{\sum_{j = 0}^{J - 1} \mu_j N_j^{\ell} \Delta t}
    {\sum_{j = 0}^{J - 1} N_j^{\ell} \Delta t},
    \\
    \bar{\nu}_N^{\ell}
    &= \frac{\sum_{j = 0}^{J - 1} \nu_j N_j^{\ell} \Delta t}
    {\sum_{j = 0}^{J - 1} N_j^{\ell} \Delta t}.
  \end{align}
\end{subequations}
Then summing numerical method
\eqref{numerics_age_and_time_since_entry_structured_agg_tse_state}
over age gives
\begin{equation}
  \label{numerics_age_and_time_since_entry_structured_agg_tse_state_age}
  \frac{\bar{N}^{\ell} - \bar{N}^{\ell - 1}}{\Delta t}
  = b^{\ell - 1 / 2} \frac{\bar{\nu}_N^{\ell} \bar{N}^{\ell}
    + \bar{\nu}_N^{\ell - 1} \bar{N}^{\ell - 1}}{2}
  - \frac{\bar{\mu}_N^{\ell} \bar{N}^{\ell}
    + \bar{\mu}_N^{\ell - 1} \bar{N}^{\ell - 1}}{2},
\end{equation}
which is identical to our Crank--Nicolson scheme applied to aggregated
model
\eqref{model_age_and_time_since_entry_structured_agg_tse_state_age}.


\paragraph{Aggregating over age}

Let
\begin{subequations}
  \begin{align}
    \bar{M}(t) &= \int_0^{+\infty} M(t, a) \md a,
    \\
    \bar{S}(t) &= \int_0^{+\infty} S(t, a) \md a,
    \\
    \bar{E}(t) &= \int_0^{+\infty} E(t, a) \md a,
    \\
    \bar{I}(t) &= \int_0^{+\infty} I(t, a) \md a,
    \\
    \bar{R}(t) &= \int_0^{+\infty} R(t, a) \md a,
    \\
    \bar{\mu}_X(t)
    &= \frac{\int_0^{+\infty} \mu(a) X(t, a) \md a}
    {\int_0^{+\infty} X(t, a) \md a},
    \\
    \bar{\nu}_X(t)
    &= \frac{\int_0^{+\infty} \nu(a) X(t, a) \md a}
    {\int_0^{+\infty} X(t, a) \md a},
    \\
    \bar{\omega}(t)
    &= \frac{\int_0^{+\infty} \omega(a) M(t, a) \md a}
    {\int_0^{+\infty} M(t, a) \md a},
    \\
    \hat{\bar{\rho}}(t)
    &= \frac{\int_0^{+\infty} \hat{\rho}(t, a) E(t, a) \md a}
    {\int_0^{+\infty} E(t, a) \md a},
    \\
    \hat{\bar{\gamma}}(t)
    &= \frac{\int_0^{+\infty} \hat{\gamma}(t, a) I(t, a) \md a}
    {\int_0^{+\infty} I(t, a) \md a}.
  \end{align}
\end{subequations}
Then integrating model
\eqref{model_age_and_time_since_entry_structured_agg_tse} over age
gives
\begin{subequations}
  \label{model_age_and_time_since_entry_structured_agg_tse_age}
  \begin{align}
    \frac{\md}{\md t} \bar{M}(t)
    &= b(t) \bar{\nu}_R(t) \bar{R}(t)
    - \left[\bar{\omega}(t) + \bar{\mu}_M(t)\right]
    \bar{M}(t),
    \\
    \begin{split}
      \frac{\md}{\md t} \bar{S}(t)
      &= b(t) \left[\bar{\nu}_N(t) \bar{N}(t)
        - \bar{\nu}_R(t) \bar{R}(t)\right]
      \\ & \quad {}
      + \bar{\omega}(t) \bar{M}(t)
      - \lambda(t) \bar{S}(t)
      - \bar{\mu}_S(t) \bar{S}(t),
    \end{split}
    \\
    \frac{\md}{\md t} \bar{E}(t)
    &= \lambda(t) \bar{S}(t)
    - \hat{\bar{\rho}}(t) \bar{E}(t)
    - \bar{\mu}_E(t) \bar{E}(t),
    \\
    \frac{\md}{\md t} \bar{I}(t)
    &= \hat{\bar{\rho}}(t) \bar{E}(t)
      - \hat{\bar{\gamma}}(t) \bar{I}(t)
      - \bar{\mu}_I(t) \bar{I}(t),
    \\
    \frac{\md}{\md t} \bar{R}(t)
    &= \hat{\bar{\gamma}}(t) \bar{I}(t)
    - \bar{\mu}_R(t) \bar{R}(t).
  \end{align}
\end{subequations}

Let
\begin{subequations}
  \begin{align}
    \bar{M}^{\ell} &= \sum_{j = 0}^{J - 1} M_j^{\ell} \Delta t,
    \\
    \bar{S}^{\ell} &= \sum_{j = 0}^{J - 1} S_j^{\ell} \Delta t,
    \\
    \bar{E}^{\ell} &= \sum_{j = 0}^{J - 1} E_j^{\ell} \Delta t,
    \\
    \bar{I}^{\ell} &= \sum_{j = 0}^{J - 1} I_j^{\ell} \Delta t,
    \\
    \bar{R}^{\ell} &= \sum_{j = 0}^{J - 1} R_j^{\ell} \Delta t,
    \\
    \bar{\mu}_X^{\ell}
    &= \frac{\sum_{j = 0}^{J - 1} \mu_j X_j^{\ell} \Delta t}
    {\sum_{j = 0}^{J - 1} X_j^{\ell} \Delta t},
    \\
    \bar{\nu}_X^{\ell}
    &= \frac{\sum_{j = 0}^{J - 1} \nu_j X_j^{\ell} \Delta t}
    {\sum_{j = 0}^{J - 1} X_j^{\ell} \Delta t},
    \\
    \bar{\omega}^{\ell}
    &= \frac{\sum_{j = 0}^{J - 1} \omega_j M_j^{\ell} \Delta t}
    {\sum_{j = 0}^{J - 1} M_j^{\ell} \Delta t},
    \\
    \hat{\bar{\rho}}^{\ell}
    &= \frac{\sum_{j = 0}^{J - 1} \hat{\rho}_j^{\ell} E_j^{\ell} \Delta t}
    {\sum_{j = 0}^{J - 1} E_j^{\ell} \Delta t},
    \\
    \hat{\bar{\gamma}}^{\ell}
    &= \frac{\sum_{j = 0}^{J - 1} \hat{\gamma}_j^{\ell} I_j^{\ell} \Delta t}
    {\sum_{j = 0}^{J - 1} I_j^{\ell} \Delta t}.
  \end{align}
\end{subequations}
Then summing numerical method
\eqref{numerics_age_and_time_since_entry_structured_agg_tse} over
age gives
\begin{subequations}
  \label{numerics_age_and_time_since_entry_structured_agg_tse_age}
  \begin{align}
    \begin{split}
      \frac{\bar{M}^{\ell} - \bar{M}^{\ell - 1}}{\Delta t}
      &= b^{\ell - 1 / 2} \frac{\bar{\nu}_R^{\ell} \bar{R}^{\ell}
        + \bar{\nu}_R^{\ell - 1} \bar{R}^{\ell - 1}}{2}
      \\ & \quad {}
      - \frac{(\bar{\omega}^{\ell} + \bar{\mu}_M^{\ell}) \bar{M}^{\ell}
        + (\bar{\omega}^{\ell - 1} + \bar{\mu}_M^{\ell - 1}) \bar{M}^{\ell - 1}}
      {2},
    \end{split}
    \\
    \begin{split}
      \frac{\bar{S}^{\ell} - \bar{S}^{\ell - 1}}{\Delta t}
      &= b^{\ell - 1 / 2}
      \frac{\bar{\nu}_N^{\ell} \bar{N}^{\ell}
        - \bar{\nu}_R^{\ell} \bar{R}^{\ell}
        + \bar{\nu}_N^{\ell - 1} \bar{N}^{\ell - 1}
        - \bar{\nu}_N^{\ell - 1} \bar{R}^{\ell - 1}}{2}
      \\ & \quad {}
      + \frac{\bar{\omega}^{\ell} \bar{M}^{\ell}
        + \bar{\omega}^{\ell - 1} \bar{M}^{\ell - 1}}{2}
      \\ & \quad {}
      - \frac{(\lambda^{\ell} + \bar{\mu}_S^{\ell}) \bar{S}^{\ell}
        + (\lambda^{\ell - 1} + \bar{\mu}_S^{\ell - 1}) \bar{S}^{\ell - 1}}{2},
    \end{split}
    \\
    \frac{\bar{E}^{\ell} - \bar{E}^{\ell - 1}}{\Delta t}
    &= \frac{\lambda^{\ell} \bar{S}^{\ell}
      + \lambda^{\ell - 1} \bar{S}^{\ell - 1}}{2}
      - \frac{(\hat{\bar{\rho}}^{\ell} + \bar{\mu}_E^{\ell}) \bar{E}^{\ell}
      + (\hat{\bar{\rho}}^{\ell - 1} + \bar{\mu}_E^{\ell - 1}) \bar{E}^{\ell - 1}}
    {2},
    \\
    \frac{\bar{I}^{\ell} - \bar{I}^{\ell - 1}}{\Delta t}
    &= \frac{\hat{\bar{\rho}}^{\ell} \bar{E}^{\ell}
      + \hat{\bar{\rho}}^{\ell - 1} \bar{E}^{\ell - 1}} {2}
    - \frac{(\hat{\bar{\gamma}}^{\ell} + \bar{\mu}_I^{\ell}) \bar{I}^{\ell}
      + (\hat{\bar{\gamma}}^{\ell - 1} + \bar{\mu}_I^{\ell - 1})
      \bar{I}^{\ell - 1}}
    {2},
    \\
    \frac{\bar{R}^{\ell} - \bar{R}^{\ell - 1}}{\Delta t}
    &= \frac{\hat{\bar{\gamma}}^{\ell} \bar{I}^{\ell}
      + \hat{\bar{\gamma}}^{\ell - 1} \bar{I}^{\ell - 1}}
    {2}
    - \frac{\bar{\mu}_R^{\ell} \bar{R}^{\ell}
      + \bar{\mu}_R^{\ell - 1} \bar{R}^{\ell - 1}}
    {2},
  \end{align}
\end{subequations}
which is identical to our Crank--Nicolson scheme applied to aggregated
model \eqref{model_age_and_time_since_entry_structured_agg_tse_age}.


\subparagraph{Aggregating over immune state}

Let
\begin{equation}
  \bar{N}(t)
  = \bar{M}(t) + \bar{S}(t) + \bar{E}(t)
  + \bar{I}(t) + \bar{R}(t).
\end{equation}
Then summing model
\eqref{model_age_and_time_since_entry_structured_agg_tse_age} over
immune state gives
\begin{equation}
  \label{model_age_and_time_since_entry_structured_agg_tse_age_state}
  \frac{\md}{\md t} \bar{N}(t)
  = b(t) \bar{\nu}_N(t) \bar{N}(t)
  - \bar{\mu}_N(t) \bar{N}(t).
\end{equation}

Let
\begin{equation}
  \bar{N}^{\ell}
  = \bar{M}^{\ell} + \bar{S}^{\ell} + \bar{E}^{\ell}
  + \bar{I}^{\ell} + \bar{R}^{\ell}.
\end{equation}
Then summing numerical method
\eqref{numerics_age_and_time_since_entry_structured_agg_tse_age} over
immune state gives
\begin{equation}
  \label{numerics_age_and_time_since_entry_structured_agg_tse_age_state}
  \frac{\bar{N}^{\ell} - \bar{N}^{\ell - 1}}{\Delta t}
  = b^{\ell - 1 / 2}
  \frac{\bar{\nu}_N^{\ell} \bar{N}^{\ell}
    + \bar{\nu}_N^{\ell - 1} \bar{N}^{\ell - 1}}{2}
  - \frac{\bar{\mu}_N^{\ell} \bar{N}^{\ell}
    + \bar{\mu}_N^{\ell - 1} \bar{N}^{\ell - 1}}{2},
\end{equation}
which is identical to our Crank--Nicolson scheme applied to aggregated
model
\eqref{model_age_and_time_since_entry_structured_agg_tse_age_state}.


\subsubsection{Aggregating over age}

Let
\begin{subequations}
  \begin{align}
    \bar{M}(t) &= \int_0^{+\infty} M(t, a) \md a,
    \\
    \bar{S}(t) &= \int_0^{+\infty} S(t, a) \md a,
    \\
    \bar{e}(t, z) &= \int_0^{+\infty} e(t, a, z) \md a,
    \\
    \bar{i}(t, z) &= \int_0^{+\infty} i(t, a, z) \md a,
    \\
    \bar{R}(t) &= \int_0^{+\infty} R(t, a) \md a,
    \\
    \bar{\mu}_X(t)
    &= \frac{\int_0^{+\infty} \mu(a) X(t, a) \md a}
    {\int_0^{+\infty} X(t, a) \md a},
    \\
    \bar{\mu}_y(t, z)
    &= \frac{\int_0^{+\infty} \mu(a) y(t, a, z) \md a}
    {\int_0^{+\infty} y(t, a, z) \md a},
    \\
    \bar{\nu}_X(t)
    &= \frac{\int_0^{+\infty} \nu(a) X(t, a) \md a}
    {\int_0^{+\infty} X(t, a) \md a},
    \\
    \bar{\omega}(t)
    &= \frac{\int_0^{+\infty} \omega(a) M(t, a) \md a}
    {\int_0^{+\infty} M(t, a) \md a}.
  \end{align}
\end{subequations}
Then integrating model
\eqref{model_age_and_time_since_entry_structured} over age gives
\begin{subequations}
  \label{model_age_and_time_since_entry_structured_agg_age}
  \begin{align}
    \frac{\md}{\md t} \bar{M}(t)
    &= b(t) \bar{\nu}_R(t) \bar{R}(t)
    - \left[\bar{\omega}(t) + \bar{\mu}_M(t)\right] \bar{M}(t),
    \\
    \begin{split}
      \frac{\md}{\md t} \bar{S}(t)
      &= b(t) \left[
        \bar{\nu}_N(t) \bar{N}(t)
        - \bar{\nu}_R(t) \bar{R}(t)
        \right]
      \\ & \quad {}
      + \bar{\omega}(t) \bar{M}(t)
      - \left[\lambda(t) + \bar{\mu}_S(t)\right] \bar{S}(t),
    \end{split}
    \\
    \bar{e}(t, 0) &=
    \lambda(t) \bar{S}(t),
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial z}\right)
    \bar{e}(t, z) &=
    - \rho(z) \bar{e}(t, z) - \bar{\mu}_e(t, z) \bar{e}(t, z),
    \\
    \bar{i}(t, 0) &=
    \int_0^{+\infty} \rho(z) \bar{e}(t, z) \md z,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial z}\right)
    \bar{i}(t, z) &=
    - \gamma(z) \bar{i}(t, z) - \bar{\mu}_i(t, z) \bar{i}(t, z),
    \\
    \frac{\md}{\md t} \bar{R}(t)
    &= \int_0^{+\infty} \gamma(z) \bar{i}(t, z) \md z
    - \bar{\mu}_R(t) \bar{R}(t).
  \end{align}
\end{subequations}

Let
\begin{subequations}
  \begin{align}
    \bar{M}^{\ell} &= \sum_{j = 0}^{J - 1} M_j^{\ell} \Delta t,
    \\
    \bar{S}^{\ell} &= \sum_{j = 0}^{J - 1} S_j^{\ell} \Delta t,
    \\
    \bar{e}_k^{\ell} &= \sum_{j = 0}^{J - 1} e_{j, k}^{\ell} \Delta t,
    \\
    \bar{i}_k^{\ell} &= \sum_{j = 0}^{J - 1} i_{j, k}^{\ell} \Delta t,
    \\
    \bar{R}^{\ell} &= \sum_{j = 0}^{J - 1} R_j^{\ell} \Delta t,
    \\
    \bar{\mu}_X^{\ell}
    &= \frac{\sum_{j = 0}^{J - 1} \mu_j X_j^{\ell} \Delta t}
    {\sum_{j = 0}^{J - 1} X_j^{\ell} \Delta t},
    \\
    \bar{\mu}_{y, k}^{\ell}
    &= \frac{\sum_{j = 0}^{J - 1} \mu_j y_{j, k}^{\ell} \Delta t}
    {\sum_{j = 0}^{J - 1} y_{j, k}^{\ell} \Delta t},
    \\
    \bar{\nu}_X^{\ell}
    &= \frac{\sum_{j = 0}^{J - 1} \nu_j X_j^{\ell} \Delta t}
    {\sum_{j = 0}^{J - 1} X_j^{\ell} \Delta t},
    \\
    \bar{\omega}^{\ell}
    &= \frac{\sum_{j = 0}^{J - 1} \omega_j M_j^{\ell} \Delta t}
    {\sum_{j = 0}^{J - 1} M_j^{\ell} \Delta t}.
  \end{align}
\end{subequations}
Then summing numerical method
\eqref{numerics_age_and_time_since_entry_structured} over age gives
\begin{subequations}
  \label{numerics_age_and_time_since_entry_structured_agg_age}
  \begin{align}
    \begin{split}
      \frac{\bar{M}^{\ell} - \bar{M}^{\ell - 1}}{\Delta t}
      &=
      b^{\ell - 1 / 2}
      \frac{\bar{\nu}_R^{\ell} \bar{R}^{\ell}
        + \bar{\nu}_R^{\ell - 1} \bar{R}^{\ell - 1}}{2}
      \\ & \quad {}
      - \frac{(\bar{\omega}^{\ell} + \bar{\mu}_M^{\ell}) \bar{M}^{\ell}
        + (\bar{\omega}^{\ell - 1} + \bar{\mu}_M^{\ell - 1}) \bar{M}^{\ell - 1}}
      {2},
    \end{split}
    \\
    \begin{split}
      \frac{\bar{S}^{\ell} - \bar{S}^{\ell - 1}}{\Delta t}
      &= b^{\ell - 1 / 2}
      \frac{\bar{\nu}_N^{\ell} \bar{N}^{\ell}
        - \bar{\nu}_R^{\ell} \bar{R}^{\ell}
        + \bar{\nu}_N^{\ell - 1} \bar{N}^{\ell - 1}
        - \bar{\nu}_N^{\ell - 1} \bar{R}^{\ell - 1}}{2}
      \\ & \quad {}
      + \frac{\bar{\omega}^{\ell} \bar{M}^{\ell}
        + \bar{\omega}^{\ell - 1} \bar{M}^{\ell - 1}}{2}
      \\ & \quad {}
      - \frac{(\lambda^{\ell} + \bar{\mu}_S^{\ell}) \bar{S}^{\ell}
        + (\lambda^{\ell - 1} + \bar{\mu}_S^{\ell - 1}) \bar{S}^{\ell - 1}}{2},
    \end{split}
    \\
    \left[1 + \frac{\Delta t}{2} (\rho_0 + \bar{\mu}_{e, 0}^{\ell})\right]
    \bar{e}_0^{\ell}
      &= \frac{
        \lambda^{\ell} \bar{S}^{\ell}
        + \lambda^{\ell - 1} \bar{S}^{\ell - 1}
      }{2},
    \\
    \frac{\bar{e}_k^{\ell} - \bar{e}_{k - 1}^{\ell - 1}}{\Delta t}
    &= - \frac{
      (\rho_k + \bar{\mu}_{e, k}^{\ell}) \bar{e}_k^{\ell}
      + (\rho_{k - 1} + \bar{\mu}_{e, k - 1}^{\ell - 1})
      \bar{e}_{k - 1}^{\ell - 1}
    }{2},
    \\
    \begin{split}
      \frac{\bar{e}_{K - 1}^{\ell} - \bar{e}_{K - 2}^{\ell - 1}}{\Delta t}
      &= - \frac{
        (\rho_{K - 1} + \bar{\mu}_{e, K - 1}^{\ell})
        \bar{e}_{K - 1}^{\ell}
        + (\rho_{K - 2} + \bar{\mu}_{e, K - 2}^{\ell - 1})
        \bar{e}_{K - 2}^{\ell - 1}
      }{2}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\rho_{K - 1} + \bar{\mu}_{e, K - 1}^{\ell - 1})
      \right] \bar{e}_{K - 1}^{\ell - 1},
    \end{split}
    \\
    \left[1 + \frac{\Delta t}{2} (\gamma_0 + \bar{\mu}_{i, 0}^{\ell})\right]
    \bar{i}_0^{\ell}
    &= \sum_{k = 0}^{K - 1}
    \rho_k \frac{\bar{e}_k^{\ell} + \bar{e}_k^{\ell - 1}}{2} \Delta t,
    \\
    \frac{\bar{i}_k^{\ell} - \bar{i}_{k - 1}^{\ell - 1}}{\Delta t}
    &= - \frac{
      (\gamma_k + \bar{\mu}_{i, k}^{\ell})
      \bar{i}_k^{\ell}
      + (\gamma_{k - 1} + \bar{\mu}_{i, k - 1}^{\ell - 1})
      \bar{i}_{k - 1}^{\ell - 1}
    }{2},
    \\
    \begin{split}
      \frac{\bar{i}_{K - 1}^{\ell} - \bar{i}_{K - 2}^{\ell - 1}}{\Delta t}
      &= - \frac{
        (\gamma_{K - 1} + \bar{\mu}_{i, K - 1}^{\ell})
        \bar{i}_{K - 1}^{\ell}
        + (\gamma_{K - 2} + \bar{\mu}_{i, K - 2}^{\ell - 1})
        \bar{i}_{K - 2}^{\ell - 1}
      }{2}
      \\ & \quad {}
      + \frac{1}{\Delta t} \left[
        1 - \frac{\Delta t}{2} (\gamma_{K - 1} + \bar{\mu}_{i, K - 1}^{\ell - 1})
      \right] \bar{i}_{K - 1}^{\ell - 1},
    \end{split}
    \\
    \frac{\bar{R}^{\ell} - \bar{R}^{\ell - 1}}{\Delta t}
    &= \sum_{k = 0}^{K - 1} \gamma_k
    \frac{\bar{i}_k^{\ell} + \bar{i}_k^{\ell - 1}}{2} \Delta t
    - \frac{
      \bar{\mu}_R^{\ell} \bar{R}^{\ell}
      + \bar{\mu}_R^{\ell - 1} \bar{R}^{\ell - 1}
    }{2},
  \end{align}
\end{subequations}
which is identical to our Crank--Nicolson scheme applied to aggregated
model \eqref{model_age_and_time_since_entry_structured_agg_age}.


\paragraph{Aggregating over time since entry}

Let
\begin{subequations}
  \begin{align}
    \bar{E}(t)
    &= \int_0^{+\infty} \bar{e}(t, z) \md z,
    \\
    \bar{I}(t)
    &= \int_0^{+\infty} \bar{i}(t, z) \md z,
    \\
    \hat{\bar{\mu}}_y(t)
    &= \frac{\int_0^{+\infty} \bar{\mu}_y(t, z) \bar{y}(t, z) \md z}
    {\int_0^{+\infty} \bar{y}(t, z) \md z},
    \\
    \hat{\bar{\rho}}(t)
    &= \frac{\int_0^{+\infty} \rho(z) \bar{e}(t, z) \md z}
    {\int_0^{+\infty} \bar{e}(t, z) \md z},
    \\
    \hat{\bar{\gamma}}(t)
    &= \frac{\int_0^{+\infty} \gamma(z) \bar{i}(t, z) \md z}
    {\int_0^{+\infty} \bar{i}(t, z) \md z}.
  \end{align}
\end{subequations}
Then integrating model
\eqref{model_age_and_time_since_entry_structured_agg_age} over time
since entry gives
\begin{subequations}
  \label{model_age_and_time_since_entry_structured_agg_age_tse}
  \begin{align}
    \frac{\md}{\md t} \bar{M}(t)
    &= b(t) \bar{\nu}_R(t) \bar{R}(t)
    - \left[\bar{\omega}(t) + \bar{\mu}_M(t)\right] \bar{M}(t),
    \\
    \begin{split}
      \frac{\md}{\md t} \bar{S}(t)
      &= b(t) \left[
        \bar{\nu}_N(t) \bar{N}(t)
        - \bar{\nu}_R(t) \bar{R}(t)
        \right]
      \\ & \quad {}
      + \bar{\omega}(t) \bar{M}(t)
      - \left[\lambda(t) + \bar{\mu}_S(t)\right] \bar{S}(t),
    \end{split}
    \\
    \frac{\md}{\md t} \bar{E}(t)
    &= \lambda(t) \bar{S}(t)
    - \hat{\bar{\rho}}(t) \bar{E}(t)
    - \hat{\bar{\mu}}_e(t) \bar{E}(t),
    \\
    \frac{\md}{\md t} \bar{I}(t)
    &= \hat{\bar{\rho}}(t) \bar{E}(t)
    - \hat{\bar{\gamma}}(t) \bar{I}(t)
    - \hat{\bar{\mu}}_i(t) \bar{I}(t),
    \\
    \frac{\md}{\md t} \bar{R}(t)
    &= \hat{\bar{\gamma}}(t) \bar{I}(t)
    - \bar{\mu}_R(t) \bar{R}(t).
  \end{align}
\end{subequations}

Let
\begin{subequations}
  \begin{align}
    \bar{E}^{\ell}
    &= \sum_{k = 0}^{K - 1} \bar{e}_k^{\ell} \Delta t,
    \\
    \bar{I}^{\ell}
    &= \sum_{k = 0}^{K - 1} \bar{i}_k^{\ell} \Delta t,
    \\
    \hat{\bar{\mu}}_y^{\ell}
    &= \frac{
      \sum_{k = 0}^{K - 1} \bar{\mu}_{y, k}^{\ell} \bar{y}_k^{\ell} \Delta t
    }{
      \sum_{k = 0}^{K - 1} \bar{y}_k^{\ell} \Delta t
    },
    \\
    \hat{\bar{\rho}}^{\ell}
    &= \frac{\sum_{k = 0}^{K - 1} \rho_k \bar{e}_k^{\ell} \Delta t}
    {\sum_{k = 0}^{K - 1} \bar{e}_k^{\ell} \Delta t},
    \\
    \hat{\bar{\gamma}}^{\ell}
    &= \frac{\sum_{k = 0}^{K - 1} \gamma_k \bar{i}_k^{\ell} \Delta t}
    {\sum_{k = 0}^{K - 1} \bar{i}_k^{\ell} \Delta t}.
  \end{align}
\end{subequations}
Then summing numerical method
\eqref{numerics_age_and_time_since_entry_structured_agg_age} over
time since entry gives
\begin{subequations}
  \label{numerics_age_and_time_since_entry_structured_agg_age_tse}
  \begin{align}
    \begin{split}
      \frac{\bar{M}^{\ell} - \bar{M}^{\ell - 1}}{\Delta t}
      &=
      b^{\ell - 1 / 2}
      \frac{\bar{\nu}_R^{\ell} \bar{R}^{\ell}
        + \bar{\nu}_R^{\ell - 1} \bar{R}^{\ell - 1}}{2}
      \\ & \quad {}
      - \frac{(\bar{\omega}^{\ell} + \bar{\mu}_M^{\ell}) \bar{M}^{\ell}
        + (\bar{\omega}^{\ell - 1} + \bar{\mu}_M^{\ell - 1}) \bar{M}^{\ell - 1}}
      {2},
    \end{split}
    \\
    \begin{split}
      \frac{\bar{S}^{\ell} - \bar{S}^{\ell - 1}}{\Delta t}
      &= b^{\ell - 1 / 2}
      \frac{\bar{\nu}_N^{\ell} \bar{N}^{\ell}
        - \bar{\nu}_R^{\ell} \bar{R}^{\ell}
        + \bar{\nu}_N^{\ell - 1} \bar{N}^{\ell - 1}
        - \bar{\nu}_N^{\ell - 1} \bar{R}^{\ell - 1}}{2}
      \\ & \quad {}
      + \frac{\bar{\omega}^{\ell} \bar{M}^{\ell}
        + \bar{\omega}^{\ell - 1} \bar{M}^{\ell - 1}}{2}
      \\ & \quad {}
      - \frac{(\lambda^{\ell} + \bar{\mu}_S^{\ell}) \bar{S}^{\ell}
        + (\lambda^{\ell - 1} + \bar{\mu}_S^{\ell - 1}) \bar{S}^{\ell - 1}}{2},
    \end{split}
    \\
    \begin{split}
      \frac{\bar{E}^{\ell} - \bar{E}^{\ell - 1}}{\Delta t}
      &= \frac{
        \lambda^{\ell} \bar{S}^{\ell}
        + \lambda^{\ell - 1} \bar{S}^{\ell - 1}
      }{2}
      \\ & \quad {}
      - \frac{
        (\hat{\bar{\rho}}^{\ell} + \hat{\bar{\mu}}_e^{\ell})
        \bar{E}^{\ell}
        + (\hat{\bar{\rho}}^{\ell - 1} + \hat{\bar{\mu}}_e^{\ell - 1})
        \bar{E}^{\ell - 1}
      }{2}
    \end{split}
    \\
    \begin{split}
      \frac{\bar{I}^{\ell} - \bar{I}^{\ell - 1}}{\Delta t}
      &= \frac{
        \hat{\bar{\rho}}^{\ell} \bar{E}^{\ell}
        + \hat{\bar{\rho}}^{\ell} \bar{E}^{\ell - 1}
      }{2}
      \\ & \quad {}
      - \frac{
        (\hat{\bar{\gamma}}^{\ell} + \hat{\bar{\mu}}_i^{\ell})
        \bar{I}^{\ell}
        + (\hat{\bar{\gamma}}^{\ell - 1} + \hat{\bar{\mu}}_i^{\ell - 1})
        \bar{I}^{\ell - 1}
      }{2},
    \end{split}
    \\
    \frac{\bar{R}^{\ell} - \bar{R}^{\ell - 1}}{\Delta t}
    &= \sum_{k = 0}^{K - 1} \gamma_k
    \frac{\bar{i}_k^{\ell} + \bar{i}_k^{\ell - 1}}{2} \Delta t
    - \frac{
      \bar{\mu}_R^{\ell} \bar{R}^{\ell}
      + \bar{\mu}_R^{\ell - 1} \bar{R}^{\ell - 1}
    }{2},
  \end{align}
\end{subequations}
which is identical to our Crank--Nicolson scheme applied to aggregated
model \eqref{model_age_and_time_since_entry_structured_agg_age_tse}.


\subparagraph{Aggregating over state}

Let
\begin{equation}
  \bar{N}(t)
  = \bar{M}(t) + \bar{S}(t) + \bar{E}(t)
  + \bar{I}(t) + \bar{R}(t).
\end{equation}
Then summing model
\eqref{model_age_and_time_since_entry_structured_agg_age_tse} over
immune state gives
\begin{equation}
  \label{model_age_and_time_since_entry_structured_agg_age_tse_state}
  \frac{\md}{\md t} \bar{N}(t)
  = b(t) \bar{\nu}_N(t) \bar{N}(t)
  - \bar{\mu}_N(t) \bar{N}(t).
\end{equation}

Let
\begin{equation}
  \bar{N}^{\ell}
  = \bar{M}^{\ell} + \bar{S}^{\ell} + \bar{E}^{\ell}
  + \bar{I}^{\ell} + \bar{R}^{\ell}.
\end{equation}
Then summing numerical method
\eqref{numerics_age_and_time_since_entry_structured_agg_age_tse} over
immune state gives
\begin{equation}
  \label{numerics_age_and_time_since_entry_structured_agg_age_tse_state}
  \frac{\bar{N}^{\ell} - \bar{N}^{\ell - 1}}{\Delta t}
  = b^{\ell - 1 / 2}
  \frac{\bar{\nu}_N^{\ell} \bar{N}^{\ell}
    + \bar{\nu}_N^{\ell - 1} \bar{N}^{\ell - 1}}{2}
  - \frac{\bar{\mu}_N^{\ell} \bar{N}^{\ell}
    + \bar{\mu}_N^{\ell - 1} \bar{N}^{\ell - 1}}{2},
\end{equation}
which is identical to our Crank--Nicolson scheme applied to aggregated
model
\eqref{model_age_and_time_since_entry_structured_agg_age_tse_state}.


\printbibliography


\end{document}
