\documentclass{jpmarticle}

\usepackage{units}
\usepackage{csquotes}
\usepackage[style=vancouver]{biblatex}
\addbibresource{notes.bib}

\renewcommand{\vec}[1]{\boldsymbol{\mathrm{#1}}}

% Use arabic numbers for subequations.
\let\subequationsorig\subequations%
\let\endsubequationsorig\endsubequations%
\renewenvironment{subequations}{
  \subequationsorig
  \renewcommand{\theequation}{\theparentequation.\arabic{equation}}
}{
  \endsubequationsorig
}

\allowdisplaybreaks[1]

\title{Crank--Nicolson for some SIR models}
\author{Jan Medlock}

\begin{document}

\maketitle


All of the models will use the periodic birth rate
\begin{equation}
  b(t) = \bar{b} \left[
    1 + \sigma \sqrt{2} \cos\left(2 \pi t / T\right)
  \right],
\end{equation}
with period
\begin{equation}
  T = \unit[1]{y}.
\end{equation}
As we will show for each model, the mean birth rate $\bar{b}$
was chosen so that the total population is periodic in time.


\section{Unstructured model}

The model is
\begin{subequations}
  \label{model_unstructured}
  \begin{align}
    \frac{\md}{\md t} M(t) &=
    b(t) R(t) - \omega M(t) - \mu M(t),
    \\
    \frac{\md}{\md t} S(t) &=
    b(t) \left[N(t) - R(t)\right] + \omega M(t) - \lambda(t) S(t) - \mu S(t),
    \\
    \frac{\md}{\md t} E(t) &=
    \lambda(t) S(t) - \rho E(t) - \mu E(t),
    \\
    \frac{\md}{\md t} I(t) &=
    \rho E(t) - \gamma I(t) - \mu I(t),
    \\
    \frac{\md}{\md t} R(t) &=
    \gamma I(t) - \mu R(t),
  \end{align}
  with force of infection
  \begin{equation}
    \lambda(t) = \beta I(t)
  \end{equation}
  and population size
  \begin{equation}
    N(t) = M(t) + S(t) + E(t) + I(t) + R(t).
  \end{equation}
\end{subequations}


\subsection{Total population}

The total population follows
\begin{equation}
  \begin{split}
    \frac{\md}{\md t} N(t)
    &= b(t) N(t) - \mu N(t)
    \\
    &= \left[
      \bar{b} - \mu
      + \bar{b} \sigma \sqrt{2} \cos\left(2 \pi t / T\right)
    \right]
    N(t),
  \end{split}
\end{equation}
so that
\begin{equation}
  N(t) = N(0) \exp\left[
    \left(\bar{b} - \mu\right) t
    + \frac{\bar{b} \sigma T}{\pi \sqrt{2}}
    \sin\left(2 \pi t / T\right)
  \right].
\end{equation}
We chose $\bar{b} = \mu$ so that
\begin{equation}
  N(t) = N(0) \exp\left[
    \frac{\mu \sigma T}{\pi \sqrt{2}}
    \sin\left(2 \pi t / T\right)
  \right],
\end{equation}
i.e.~periodic with period $T = \unit[1]{y}$.


\subsection{Numerical method}

\begin{subequations}
  To numerically solve the system \eqref{model_unstructured}, we used
  the Crank--Nicolson method on characteristics and the composite
  trapezoid rule for the integrals \autocite{milner_1992}.  Given the
  time step $\Delta t$, let
  $t^{\ell} = t_0 + \ell \Delta t$ for $\ell \in \{0, 1, \ldots, L - 1\}$;
  and $X^{\ell} \approx X(t^{\ell})$ for $X \in \{M, S, E, I, R\}$.
  For each $\ell \geq 1$, the Crank--Nicolson method is
  \begin{align}
    \frac{M^{\ell} - M^{\ell - 1}}{\Delta t}
    &=
    b(t^{\ell - 1 / 2})
    \frac{R^{\ell} + R^{\ell - 1}}{2}
    - (\omega + \mu)
    \frac{M^{\ell} + M^{\ell - 1}}{2},
    \\
    \begin{split}
      \frac{S^{\ell} - S^{\ell - 1}}{\Delta t}
      &=
      b(t^{\ell - 1 / 2})
      \left(\frac{N^{\ell} + N^{\ell - 1}}{2}
        - \frac{R^{\ell} + R^{\ell - 1}}{2}\right)
      \\ & \quad {}
      + \omega \frac{M^{\ell} + M^{\ell - 1}}{2}
      - \frac{(\lambda^{\ell} + \mu) S^{\ell}
        + (\lambda^{\ell - 1} + \mu) S^{\ell - 1}}{2},
    \end{split}
    \\
    \frac{E^{\ell} - E^{\ell - 1}}{\Delta t}
    &=
    \frac{\lambda^{\ell} S^{\ell} + \lambda^{\ell - 1} S^{\ell- 1}}{2}
    - (\rho + \mu)
    \frac{E^{\ell} + E^{\ell - 1}}{2},
    \\
    \frac{I^{\ell} - I^{\ell - 1}}{\Delta t}
    &=
    \rho \frac{E^{\ell} + E^{\ell - 1}}{2}
    - (\gamma + \mu) \frac{I^{\ell} + I^{\ell - 1}}{2},
    \\
    \frac{R^{\ell} - R^{\ell - 1}}{\Delta t}
    &=
    \gamma \frac{I^{\ell} + I^{\ell - 1}}{2}
    - \mu \frac{R^{\ell} + R^{\ell - 1}}{2},
  \end{align}
  with force of infection
  \begin{equation}
    \lambda^{\ell} = \beta I^{\ell}
  \end{equation}
  and population size
  \begin{equation}
    N^{\ell} = M^{\ell} + S^{\ell} + E^{\ell} + I^{\ell} + R^{\ell}.
  \end{equation}
\end{subequations}

Let
\begin{subequations}
  \begin{align}
    \vec{x}^{\ell} &=
    \begin{bmatrix}
      M^{\ell} \\ S^{\ell} \\ E^{\ell} \\ I^{\ell} \\ R^{\ell}
    \end{bmatrix},
    \\
    \vec{\beta} &=
    \beta
    \begin{bmatrix}
      0 & 0 & 0 & 1 & 0
    \end{bmatrix},
    \\
    \lambda^{\ell} &=
    \vec{\beta} \vec{x}^{\ell},
    \\
    c_{MM} &= - \frac{\Delta t}{2} (\omega + \mu),
    \\
    c_{SM} &= \frac{\Delta t}{2} \omega,
    \\
    c_{SS} &= - \frac{\Delta t}{2} \mu,
    \\
    c_{EE} &= - \frac{\Delta t}{2} (\rho + \mu),
    \\
    c_{IE} &= \frac{\Delta t}{2} \rho,
    \\
    c_{II} &= - \frac{\Delta t}{2} (\gamma + \mu),
    \\
    c_{RI} &= \frac{\Delta t}{2} \gamma,
    \\
    c_{II} &= - \frac{\Delta t}{2} \mu,
    \\
    \mat{C} &=
    \begin{bmatrix}
      c_{MM} & 0 & 0 & 0 & 0
      \\
      c_{SM} & c_{SS} & 0 & 0 & 0
      \\
      0 & 0 & c_{EE} & 0 & 0 \\
      0 & 0 & c_{IE} & c_{II} & 0
      \\
      0 & 0 & 0 & c_{RI} & c_{RR}
    \end{bmatrix},
    \\
    \mat{P} &= \mat{I} - \mat{C},
    \\
    \mat{Q} &= \mat{I} + \mat{C},
    \\
    b_{MR} &= b_{SM} = b_{SS} = b_{SE} = b_{SI}
    = \frac{\Delta t}{2},
    \\
    \mat{B} &=
    \begin{bmatrix}
      0 & 0 & 0 & 0 & b_{MR}
      \\
      b_{SM} & b_{SS} & b_{SE} & b_{SI} & 0
      \\
      0 & 0 & 0 & 0 & 0
      \\
      0 & 0 & 0 & 0 & 0
      \\
      0 & 0 & 0 & 0 & 0
    \end{bmatrix},
    \\
    t_{SS} &= - \frac{\Delta t}{2},
    \\
    t_{ES} &= \frac{\Delta t}{2},
    \\
    \mat{T} &=
    \begin{bmatrix}
      0 & 0 & 0 & 0 & 0
      \\
      0 & t_{SS} & 0 & 0 & 0
      \\
      0 & t_{ES} & 0 & 0 & 0
      \\
      0 & 0 & 0 & 0 & 0
      \\
      0 & 0 & 0 & 0 & 0
    \end{bmatrix},
    \\
    \mat{P}^{\ell} &=
    \mat{P} - b(t^{\ell - 1 / 2}) \mat{B},
    \\
    \vec{d}^{\ell - 1} &=
    \left[
      \mat{Q}
      + b(t^{\ell - 1 / 2}) \mat{B}
      + \vec{\beta} \vec{x}^{\ell - 1} \mat{T}
    \right] \vec{x}^{\ell - 1}.
  \end{align}
\end{subequations}
Then, for each $\ell \in \{1, 2, \ldots, L - 1\}$,
we use a nonlinear solver to find $\vec{x}^{\ell}$ that satisfies
\begin{equation}
  \left[
    \mat{P}^{\ell}
    - \vec{\beta} \vec{x}^{\ell} \mat{T}
  \right] \vec{x}^{\ell}
  - \vec{d}^{\ell - 1}
  = \vec{0}.
\end{equation}


\section{Time-since-entry-structured model}

The model is
\begin{subequations}
  \label{model_time_since_entry_structured}
  \begin{align}
    m(t, 0) &=
    b(t) R(t),
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial z}\right)
    m(t, z) &=
    - \omega(z) m(t, z) - \mu m(t, z),
    \\
    \begin{split}
      \frac{\md}{\md t} S(t) &=
      b(t) \left[N(t) - R(t)\right]
      + \int_0^{+\infty} \omega(z) m(t, z) \md z
      \\ & \quad {}
      - \lambda(t) S(t) - \mu S(t),
    \end{split}
    \\
    e(t, 0) &=
    \lambda(t) S(t),
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial z}\right)
    e(t, z) &=
    - \rho(z) e(t, z) - \mu e(t, z),
    \\
    i(t, 0) &=
    \int_0^{+\infty} \rho(z) e(t, z) \md z,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial z}\right)
    i(t, z) &=
    - \gamma(z) i(t, z) - \mu i(t, z),
    \\
    \frac{\md}{\md t} R(t) &=
    \int_0^{+\infty} \gamma(z) i(t, z) \md z
    - \mu R(t),
  \end{align}
  with force of infection
  \begin{equation}
    \lambda(t) = \beta \int_0^{+\infty} i(t, z) \md z
  \end{equation}
  and population size
  \begin{equation}
    N(t) =
    S(t) + R(t)
    + \int_0^{+\infty} m(t, z) + e(t, z) + i(t, z) \md z.
  \end{equation}
\end{subequations}


\subsection{Total population}

As before, the total population follows
\begin{equation}
  \begin{split}
    \frac{\md}{\md t} N(t)
    &= \frac{\md}{\md t} S(t)
    + \frac{\md}{\md t} R(t)
    + \frac{\md}{\md t} \int_0^{+\infty} m(t, z) + e(t, z) + i(t, z) \md z
    \\
    &= \frac{\md}{\md t} S(t)
    + \frac{\md}{\md t} R(t)
    + \int_0^{+\infty} \frac{\partial}{\partial t} m(t, z)
    + \frac{\partial}{\partial t} e(t, z)
    + \frac{\partial}{\partial t} i(t, z) \md z
    \\
    &=
    b(t) \left[N(t) - R(t)\right]
    + \int_0^{+\infty} \omega(z) m(t, z) \md z
    - \lambda(t) S(t) - \mu S(t)
    \\ & \quad {}
    + \int_0^{+\infty} \gamma(z) i(t, z) \md z
    - \mu R(t)
    \\ & \quad {}
    - \int_0^{+\infty}
    \frac{\partial}{\partial z} m(t, z)
    + \omega(z) m(t, z)
    + \mu m(t, z)
    \md z
    \\ & \quad {}
    - \int_0^{+\infty}
    \frac{\partial}{\partial z} e(t, z)
    + \rho(z) e(t, z)
    + \mu e(t, z)
    \md z
    \\ & \quad {}
    - \int_0^{+\infty}
    \frac{\partial}{\partial z} i(t, z)
    + \gamma(z) i(t, z)
    + \mu i(t, z)
    \md z
    \\
    &=
    b(t) \left[N(t) - R(t)\right]
    \\ & \quad {}
    - \mu \left[
      S(t) + R(t)
      + \int_0^{+\infty}
      m(t, z) + e(t, z) + i(t, z)
      \md z
    \right]
    \\ & \quad {}
    - \lambda(t) S(t)
    - \int_0^{+\infty}
    \rho(z) e(t, z)
    \md z
    \\ & \quad {}
    - m(t, +\infty) - e(t, +\infty) - i(t, +\infty)
    + m(t, 0) + e(t, 0) + i(t, 0)
    \\
    &=
    b(t) \left[N(t) - R(t)\right]
    - \mu N(t)
    \\ & \quad {}
    - \lambda(t) S(t)
    - \int_0^{+\infty}
    \rho(z) e(t, z)
    \md z
    \\ & \quad {}
    + b(t) R(t)
    + \lambda(t) S(t)
    + \int_0^{+\infty} \rho(z) e(t, z) \md z
    \\
    &= b(t) N(t) - \mu N(t)
    \\
    &= \left[
      \bar{b} - \mu
      + \bar{b} \sigma \sqrt{2} \cos\left(2 \pi t / T\right)
    \right] N(t).
  \end{split}
\end{equation}
This is the same ODE for total population as in the unstructured
model: as we did for that model, we chose $\bar{b} = \mu$ so that
$N(t)$ is periodic.


\subsection{Numerical method}

To numerically solve the system
\eqref{model_time_since_entry_structured}, we used the Crank--Nicolson
method on characteristics and the composite trapezoid rule for the
integrals \autocite{milner_1992}.  Given the time step $\Delta t$,
let $z_k = k \Delta t$
for $k \in \{0, 1, 2, \ldots, K - 1\}$;
$t^{\ell} = t_0 + \ell \Delta t$
for $\ell \in \{0, 1, \ldots, L - 1\}$;
$X^{\ell} \approx X(t^{\ell})$
for $X \in \{S, R\}$;
and $y_k^{\ell} \approx y(t^{\ell}, z_k)$
for $y \in \{m, e, i\}$.
For each $k$ and each $\ell \geq 1$, the Crank--Nicolson method on
characteristics is
\begin{subequations}
  \begin{align}
    m_0^{\ell} &=
    b(t^{\ell - 1 / 2}) \frac{R^{\ell} + R^{\ell - 1}}{2},
    \\
    \frac{m_k^{\ell} - m_{k - 1}^{\ell - 1}}{\Delta t} &=
    - \frac{\omega(z_k) m_k^{\ell} + \omega(z_{k - 1}) m_{k - 1}^{\ell - 1}}{2}
    - \mu \frac{m_k^{\ell} + m_{k - 1}^{\ell - 1}}{2},
    \\
    \begin{split}
      \frac{S^{\ell} - S^{\ell - 1}}{\Delta t} &=
      b(t^{\ell - 1 / 2}) \left(\frac{N^{\ell} + N^{\ell - 1}}{2}
        - \frac{R^{\ell} + R^{\ell - 1}}{2}\right)
      \\ & \quad {}
      + \frac{1}{2} \sum_{k = 1}^{K - 1}
      \frac{\omega(z_k) m_k^{\ell} + \omega(z_{k - 1}) m_{k - 1}^{\ell}}{2}
      \Delta t
      \\ & \quad {}
      + \frac{1}{2} \sum_{k = 1}^{K - 1}
      \frac{\omega(z_k) m_k^{\ell - 1} + \omega(z_{k - 1}) m_{k - 1}^{\ell - 1}}{2}
      \Delta t
      \\ & \quad {}
      - \frac{\lambda^{\ell} S^{\ell} + \lambda^{\ell - 1} S^{\ell - 1}}{2}
      - \mu \frac{S^{\ell} + S^{\ell - 1}}{2},
    \end{split}
    \\
    e_0^{\ell} &=
    \frac{\lambda^{\ell} S^{\ell} + \lambda^{\ell - 1} S^{\ell - 1}}{2},
    \\
    \frac{e_k^{\ell} - e_{k - 1}^{\ell - 1}}{\Delta t} &=
    - \frac{\rho(z_k) e_k^{\ell} + \rho(z_{k - 1}) e_{k - 1}^{\ell - 1}}{2}
    - \mu \frac{e_k^{\ell} + e_{k - 1}^{\ell - 1}}{2},
    \\
    \begin{split}
      i_0^{\ell} &=
      \frac{1}{2} \sum_{k = 1}^{K - 1}
      \frac{\rho(z_k) e_k^{\ell} + \rho(z_{k - 1}) e_{k - 1}^{\ell}}{2}
      \Delta t
      \\ & \quad {}
      + \frac{1}{2} \sum_{k = 1}^{K - 1}
      \frac{\rho(z_k) e_k^{\ell - 1} + \rho(z_{k - 1}) e_{k - 1}^{\ell - 1}}{2}
      \Delta t,
    \end{split}
    \\
    \frac{i_k^{\ell} - i_{k - 1}^{\ell - 1}}{\Delta t} &=
    - \frac{\gamma(z_k) i_k^{\ell} + \gamma(z_{k - 1}) i_{k - 1}^{\ell - 1}}{2}
    - \mu \frac{i_k^{\ell} + i_{k - 1}^{\ell - 1}}{2},
    \\
    \begin{split}
      \frac{R^{\ell} - R^{\ell - 1}}{\Delta t} &=
      \frac{1}{2} \sum_{k = 1}^{K - 1}
      \frac{\gamma(z_k) i_k^{\ell} + \gamma(z_{k - 1}) i_{k - 1}^{\ell}}{2}
      \Delta t
      \\ & \quad {}
      + \frac{1}{2} \sum_{k = 1}^{K - 1}
      \frac{\gamma(z_k) i_k^{\ell - 1} + \gamma(z_{k - 1}) i_{k - 1}^{\ell - 1}}{2}
      \Delta t,
      \\ & \quad {}
      - \mu \frac{R^{\ell} + R^{\ell - 1}}{2},
    \end{split}
  \end{align}
  with force of infection
  \begin{equation}
    \lambda^{\ell} =
    \beta \sum_{k = 1}^{K - 1}
    \frac{i_k^{\ell} + i_{k - 1}^{\ell}}{2}
    \Delta t
  \end{equation}
  and population size
  \begin{equation}
    N^{\ell} =
    S^{\ell} + R^{\ell}
    + \sum_{k = 1}^{K - 1}
    \frac{m_k^{\ell} + e_k^{\ell} + i_k^{\ell} + m_{k - 1}^{\ell}
      + e_{k - 1}^{\ell} + i_{k - 1}^{\ell}}
    {2}
    \Delta t.
  \end{equation}
\end{subequations}

Let
\begin{subequations}
  \begin{align}
    \vec{x}^{\ell} &=
    \begin{bmatrix}
      m_0^{\ell} \\ \vdots \\ m_{K - 1}^{\ell} \\
      S^{\ell} \\
      e_0^{\ell} \\ \vdots \\ e_{K - 1}^{\ell} \\
      i_0^{\ell} \\ \vdots \\ i_{K - 1}^{\ell} \\
      R^{\ell}
    \end{bmatrix},
    \\
    \vec{v} &=
    \Delta t
    \begin{bmatrix}
      \frac{1}{2} & 1 & \cdots & 1 & \frac{1}{2}
    \end{bmatrix},
    \\
    \vec{\beta} &=
    \beta
    \begin{bmatrix}
      \vec{0} & 0 & \vec{0} & \vec{v} & 0
    \end{bmatrix}
    \\
    \lambda^{\ell} &=
    \vec{\beta} \vec{x}^{\ell},
    \\
    \vec{\omega} &=
    \begin{bmatrix}
      \omega(z_0) & \cdots & \omega(z_{K - 1})
    \end{bmatrix},
    \\
    \vec{\gamma} &=
    \begin{bmatrix}
      \gamma(z_0) & \cdots & \gamma(z_{K - 1})
    \end{bmatrix},
    \\
    \vec{\rho} &=
    \begin{bmatrix}
      \rho(z_0) & \cdots & \rho(z_{K - 1})
    \end{bmatrix},
    \\
    \mat{P}_{mm} &=
    \begin{bmatrix}
      1 & 0 & \cdots & 0
      \\
      0 & 1 + \frac{\Delta t}{2} \left[\omega(z_1) + \mu\right] &
      \ddots & \vdots
      \\
      \vdots & \ddots & \ddots & 0
      \\
      0 & \cdots & 0 &
      1 + \frac{\Delta t}{2} \left[\omega(z_{K - 1}) + \mu\right]
    \end{bmatrix},
    \\
    \mat{Q}_{mm} &=
    \begin{bmatrix}
      0 & \cdots & \cdots & \cdots & 0
      \\
      1 - \frac{\Delta t}{2} \left[\omega(z_0) + \mu\right] & \ddots &
      & & \vdots
      \\
      0 & \ddots & \ddots & & \vdots
      \\
      \vdots & \ddots & \ddots & \ddots & \vdots
      \\
      0 & \cdots & 0 &
      1 - \frac{\Delta t}{2} \left[\omega(z_{K - 2}) + \mu\right] & 0
    \end{bmatrix},
    \\
    \vec{c}_{Sm} &=
    \frac{\Delta t}{2} \vec{v} \circ \vec{\omega},
    \\
    c_{SS} &= - \frac{\Delta t}{2} \mu,
    \\
    \mat{P}_{ee} &=
    \begin{bmatrix}
      1 & 0 & \cdots & 0
      \\
      0 & 1 + \frac{\Delta t}{2} \left[\rho(z_1) + \mu\right] &
      \ddots & \vdots
      \\
      \vdots & \ddots & \ddots & 0
      \\
      0 & \cdots & 0 &
      1 + \frac{\Delta t}{2} \left[\rho(z_{K - 1}) + \mu\right]
    \end{bmatrix},
    \\
    \mat{Q}_{ee} &=
    \begin{bmatrix}
      0 & \cdots & \cdots & \cdots & 0
      \\
      1 - \frac{\Delta t}{2} \left[\rho(z_0) + \mu\right] & \ddots &
      & & \vdots
      \\
      0 & \ddots & \ddots & & \vdots
      \\
      \vdots & \ddots & \ddots & \ddots & \vdots
      \\
      0 & \cdots & 0 &
      1 - \frac{\Delta t}{2} \left[\rho(z_{K - 2}) + \mu\right] & 0
    \end{bmatrix},
    \\
    \mat{C}_{ie} &=
    \frac{1}{2}
    \begin{bmatrix}
      \vec{v} \circ \vec{\rho}
      \\
      \vec{0}
      \\
      \vdots
      \\
      \vec{0}
    \end{bmatrix},
    \\
    \mat{P}_{ii} &=
    \begin{bmatrix}
      1 & 0 & \cdots & 0
      \\
      0 & 1 + \frac{\Delta t}{2} \left[\gamma(z_1) + \mu\right] &
      \ddots & \vdots
      \\
      \vdots & \ddots & \ddots & 0
      \\
      0 & \cdots & 0 &
      1 + \frac{\Delta t}{2} \left[\gamma(z_{K - 1}) + \mu\right]
    \end{bmatrix},
    \\
    \mat{Q}_{ii} &=
    \begin{bmatrix}
      0 & \cdots & \cdots & \cdots & 0
      \\
      1 - \frac{\Delta t}{2} \left[\gamma(z_0) + \mu\right] & \ddots &
      & & \vdots
      \\
      0 & \ddots & \ddots & & \vdots
      \\
      \vdots & \ddots & \ddots & \ddots & \vdots
      \\
      0 & \cdots & 0 &
      1 - \frac{\Delta t}{2} \left[\gamma(z_{K - 2}) + \mu\right] & 0
    \end{bmatrix},
    \\
    \vec{c}_{Ri} &=
    \frac{\Delta t}{2} \vec{v} \circ \vec{\gamma},
    \\
    c_{RR} &=
    - \frac{\Delta t}{2} \mu.
    \\
    \mat{P} &=
    \begin{bmatrix}
      \mat{P}_{mm} & \vec{0} & \mat{0} & \mat{0} & \vec{0}
      \\
      - \vec{c}_{Sm} & 1 - c_{SS} & \vec{0} & \vec{0} & 0
      \\
      \mat{0} & \vec{0} & \mat{P}_{ee} & \mat{0} & \vec{0}
      \\
      \mat{0} & \vec{0} & - \mat{C}_{ie} & \mat{P}_{ii} & \vec{0}
      \\
      \vec{0} & 0 & \vec{0} & - \vec{c}_{Ri} & 1 - c_{RR}
    \end{bmatrix},
    \\
    \mat{Q} &=
    \begin{bmatrix}
      \mat{Q}_{mm} & \vec{0} & \mat{0} & \mat{0} & \vec{0}
      \\
      \vec{c}_{Sm} & 1 + c_{SS} & \vec{0} & \vec{0} & 0
      \\
      \mat{0} & \vec{0} & \mat{Q}_{ee} & \mat{0} & \vec{0}
      \\
      \mat{0} & \vec{0} & \mat{C}_{ie} & \mat{Q}_{ii} & \vec{0}
      \\
      \vec{0} & 0 & \vec{0} & \vec{c}_{Ri} & 1 + c_{RR}
    \end{bmatrix},
    \\
    \vec{b}_{mR} &=
    \frac{1}{2}
    \begin{bmatrix}
      1 \\ 0 \\ \vdots \\ 0
    \end{bmatrix},
    \\
    \vec{b}_{Sm} &=
    \vec{b}_{Se} =
    \vec{b}_{Si} =
    \frac{\Delta t}{2} \vec{v},
    \\
    b_{SS} &=
    \frac{\Delta t}{2},
    \\
    \mat{B} &=
    \begin{bmatrix}
      \mat{0} & \vec{0} & \mat{0} & \mat{0} & \vec{b}_{mR}
      \\
      \vec{b}_{Sm} & b_{SS} & \vec{b}_{Se} & \vec{b}_{Si} & 0
      \\
      \mat{0} & \vec{0} & \mat{0} & \mat{0} & \vec{0}
      \\
      \mat{0} & \vec{0} & \mat{0} & \mat{0} & \vec{0}
      \\
      \vec{0} & 0 & \vec{0} & \vec{0} & 0
    \end{bmatrix},
    \\
    t_{SS} &=
    - \frac{\Delta t}{2},
    \\
    \vec{t}_{eS} &=
    \frac{1}{2}
    \begin{bmatrix}
      1 \\ 0 \\ \vdots \\ 0
    \end{bmatrix},
    \\
    \mat{T} &=
    \begin{bmatrix}
      \mat{0} & \vec{0} & \mat{0} & \mat{0} & \vec{0}
      \\
      \vec{0} & t_{SS} & \vec{0} & \vec{0} & 0
      \\
      \mat{0} & \vec{t}_{eS} & \mat{0} & \mat{0} & \vec{0}
      \\
      \mat{0} & \vec{0} & \mat{0} & \mat{0} & \vec{0}
      \\
      \vec{0} & 0 & \vec{0} & \vec{0} & 0
    \end{bmatrix},
    \\
    \mat{P}^{\ell} &=
    \mat{P} - b(t^{\ell - 1 / 2}) \mat{B},
    \\
    \vec{d}^{\ell - 1} &=
    \left[
      \mat{Q}
      + b(t^{\ell - 1 / 2}) \mat{B}
      + \vec{\beta} \vec{x}^{\ell - 1} \mat{T}
    \right] \vec{x}^{\ell - 1}.
  \end{align}
\end{subequations}
Then, for each $\ell \in \{1, 2, \ldots, L - 1\}$,
we use a nonlinear solver to find $\vec{x}^{\ell}$ that satisfies
\begin{equation}
  \left[
    \mat{P}^{\ell}
    - \vec{\beta} \vec{x}^{\ell} \mat{T}
  \right] \vec{x}^{\ell}
  - \vec{d}^{\ell - 1}
  = \vec{0}.
\end{equation}


\section{Age-structured model}

The model is
\begin{subequations}
  \label{model_age_structured}
  \begin{align}
    M(t, 0)
    &= b(t) \int_0^{+\infty} \nu(a) R(t, a) \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    M(t, a)
    &= - \omega M(t, a) - \mu(a) M(t, a),
    \\
    S(t, 0)
    &= b(t) \int_0^{+\infty} \nu(a) \left[N(t, a) - R(t, a)\right] \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    S(t, a)
    &= \omega M(t, a) - \lambda(t) S(t, a) - \mu(a) S(t, a),
    \\
    E(t, 0)
    &= 0,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    E(t, a)
    &= \lambda(t) S(t, a) - \rho E(t, a) - \mu(a) E(t, a),
    \\
    I(t, 0)
    &= 0,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    I(t, a)
    &= \rho E(t, a) - \gamma I(t, a) - \mu(a) I(t, a),
    \\
    R(t, 0)
    &= 0,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    R(t, a)
    &= \gamma I(t, a) - \mu(a) R(t, a),
  \end{align}
  with force of infection
  \begin{equation}
    \lambda(t) = \beta \int_0^{+\infty} I(t, a) \md a
  \end{equation}
  and population size
  \begin{equation}
    N(t, a) = M(t, a) + S(t, a) + E(t, a) + I(t, a) + R(t, a).
  \end{equation}
\end{subequations}


\subsection{Total population}

The total population follows the linear PDE
\begin{subequations}
  \begin{align}
    N(t, 0)
    &= b(t) \int_0^{+\infty} \nu(a) N(t, a) \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    N(t, a)
    &= - \mu(a) N(t, a).
  \end{align}
\end{subequations}

Because $b(t)$ is periodic with period $T = \unit[1]{y}$, we used
Floquet theory \autocite{parker_1992} to find the stable age
distribution and the asymptotic population growth rate. Floquet theory
requires the fundamental solution $\Phi(t, a, a')$ to
\begin{subequations}
  \begin{align}
    \Phi(t, 0, a')
    &= b(t) \int_0^{+\infty} \nu(a) \Phi(t, a, a') \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    \Phi(t, a, a')
    &= - \mu(a) \Phi(t, a, a'),
    \\
    \Phi(t_0, a, a')
    &= \delta(a - a'),
  \end{align}
\end{subequations}
where $\delta(x)$ is the Dirac delta.

To numerically solve the PDE for the fundamental solution, we used the
Crank--Nicolson method on characteristics and the composite trapezoid
rule for the birth integral \autocite{milner_1992}.  Given the time
step $\Delta t$, let $a_j = j \Delta t$ and $a'_k = k \Delta t$ for
$j, k \in \{0, 1, 2, \ldots, J - 1\}$;
$t^{\ell} = t_0 + \ell \Delta t$ for
$\ell \in \{0, 1, \ldots, L - 1\}$;
and $\Phi_{j, k}^{\ell} \approx \Phi(t^{\ell}, a_j, a'_k)$.
For each $j$ and $k$ the initial condition is
\begin{subequations}
  \begin{equation}
    \Phi_{j, k}^0 =
    \begin{cases}
      1 & \text{if $j = k$}, \\
      0 & \text{otherwise}.
    \end{cases}
  \end{equation}
  For each $1 \leq j \leq J - 2$, each $k$, and each $\ell
  \geq 1$, the Crank--Nicolson method on characteristics is
  \begin{align}
    \begin{split}
      \Phi_{0, k}^{\ell}
      &= b(t^{\ell - 1 / 2})
      \frac{1}{2}
      \Bigg[\sum_{j = 1}^{J - 1}
      \frac{\nu(a_j) \Phi_{j, k}^{\ell}
        + \nu(a_{j - 1}) \Phi_{j - 1, k}^{\ell}}
      {2}
      \Delta t
      \\ & \quad\quad\quad\quad\quad\quad {}
      + \sum_{j = 1}^{J - 1}
      \frac{\nu(a_j) \Phi_{j, k}^{\ell - 1}
        + \nu(a_{j - 1}) \Phi_{j - 1, k}^{\ell - 1}}
      {2}
      \Delta t
      \Bigg],
    \end{split}
    \\
    \frac{\Phi_{j, k}^{\ell} - \Phi_{j - 1, k}^{\ell - 1}}{\Delta t}
    &= - \frac{\mu(a_j) \Phi_{j, k}^{\ell}
      + \mu(a_{j - 1}) \Phi_{j - 1, k}^{\ell - 1}}{2},
    \\
    \begin{split}
      \frac{\Phi_{J - 1, k}^{\ell} - \Phi_{J - 2, k}^{\ell - 1}}{\Delta t}
      &= - \frac{\mu(a_{J - 1}) \Phi_{J - 1, k}^{\ell}
        + \mu(a_{J - 2}) \Phi_{J - 2, k}^{\ell - 1}}{2}
      \\
      & \quad {}
      + \frac{1}{\Delta t}
      \left[1 - \frac{\Delta t}{2} \mu(a_{J - 1})\right]
      \Phi_{J - 1, k}^{\ell - 1}.
    \end{split}
    \label{age_structured_pop_last}
  \end{align}
\end{subequations}
In equation \eqref{age_structured_pop_last}, the final term prevents
aging out of the last age group.

Let
\begin{subequations}
  \begin{align}
    \mat{\Phi}^{\ell}
    &= \left[\Phi_{j, k}^{\ell}\right],
    \\
    \vec{v} &=
    \Delta t
    \begin{bmatrix}
      \frac{1}{2} & 1 & \cdots & 1 & \frac{1}{2}
    \end{bmatrix},
    \\
    \vec{\nu} &=
    \begin{bmatrix}
      \nu(a_0) & \cdots & \nu(a_{J - 1})
    \end{bmatrix},
    \\
    \mat{P} &=
    \begin{bmatrix}
      1 & 0 & \cdots & 0
      \\
      0 & 1 + \frac{\Delta t}{2} \mu(a_1) &
      \ddots & \vdots
      \\
      \vdots & \ddots & \ddots & 0
      \\
      0 & \cdots & 0 &
      1 + \frac{\Delta t}{2} \mu(a_{J - 1})
    \end{bmatrix},
    \\
    \mat{Q} &=
    \begin{bmatrix}
      0 & \cdots & \cdots & 0 & 0
      \\
      1 - \frac{\Delta t}{2} \mu(a_0) & \ddots &
      & \vdots & \vdots
      \\
      0 & \ddots & \ddots & \vdots & \vdots
      \\
      \vdots & \ddots & \ddots & 0 & 0
      \\
      0 & \cdots & 0
      & 1 - \frac{\Delta t}{2} \mu(a_{J - 2})
      & 1 - \frac{\Delta t}{2} \mu(a_{J - 1})
    \end{bmatrix},
    \\
    \mat{C}
    &= \mat{P}^{-1} \mat{Q}
    =
    \begin{bmatrix}
      0 & \cdots & \cdots & 0 & 0
      \\
      \frac{1 - \frac{\Delta t}{2} \mu(a_0)}
      {1 + \frac{\Delta t}{2} \mu(a_1)}
      & \ddots & & \vdots & \vdots
      \\
      0 & \ddots & \ddots & \vdots & \vdots
      \\
      \vdots & \ddots & \ddots & 0 & 0
      \\
      0 & \cdots & 0 &
      \frac{1 - \frac{\Delta t}{2} \mu(a_{J - 2})}
      {1 + \frac{\Delta t}{2} \mu(a_{J - 1})}
      & \frac{1 - \frac{\Delta t}{2} \mu(a_{J - 1})}
      {1 + \frac{\Delta t}{2} \mu(a_{J - 1})}
    \end{bmatrix},
    \\
    \mat{B} &=
    \frac{1}{2}
    \begin{bmatrix}
      \vec{v} \circ \vec{\nu} \\ \vec{0} \\ \vdots \\ \vec{0}
    \end{bmatrix}
    (\mat{I} + \mat{C}).
  \end{align}
\end{subequations}
Then, for each $\ell \in \{1, 2, \ldots, L - 1\}$,
\begin{equation}
  \begin{split}
    \mat{\Phi}^{\ell}
    &=
    \left[
      \mat{C}
      + b(t^{\ell - 1 / 2}) \mat{B}
    \right]
    \mat{\Phi}^{\ell - 1}.
  \end{split}
\end{equation}
\textbf{TODO: Simplify this as in the code by separating the C–N step
  $\mat{\hat{\Phi}}^{\ell} = \mat{C} \mat{\Phi}^{\ell - 1}$
  and the birth step
  $\vec{\Phi}_0^{\ell} = b(t^{\ell - 1 / 2}) (\vec{v} \circ \vec{\nu})
  \frac{\mat{\hat{\Phi}}^{\ell} + \mat{\Phi}^{\ell - 1}}{2}$.}

Using this numerical scheme, we solved for the monodromy matrix, the
fundamental solution after one period:
\begin{equation}
  \mat{\Psi} = [\Psi_{j, k}] \approx [\Phi(t_0 + T, a_j, a'_k)].
\end{equation}
The monodromy matrix projects the population forward at by one period,
\begin{equation}
  \vec{n}(t_0 + T) = \mat{\Psi} \vec{n}(t_0),
\end{equation}
where $\vec{n}(t) = [N(t, a_j)]$.
Using the monodromy matrix to repeatedly project the population
forward gives
\begin{equation}
  \vec{n}(t_0 + m T)
  = \mat{\Psi}^m \vec{n}(t_0)
  \to \rho_0^m \vec{w}_0
  = \me^{r m T} \vec{w}_0
\end{equation}
as $m \to +\infty$, where $\rho_0$ is the dominant eigenvalue,
i.e.~the eigenvalue with largest magnitude, of $\mat{\Psi}$;
the corresponding right eigenvector $\vec{w}_0$ is the stable age
distribution; and
\begin{equation}
  r = \frac{1}{T} \log \rho_0
\end{equation}
is the asymptotic population growth rate.

We used a nonlinear solver to search for the mean birth rate $\bar{b}$
that gives population growth rate $r = 0$.


\subsection{Numerical method}

To numerically solve the system \eqref{model_age_structured}, we used
the Crank--Nicolson method on characteristics and the composite
trapezoid rule for the integrals \autocite{milner_1992}.  Given the
time step $\Delta t$, let
$a_j = j \Delta t$ for $j \in \{0, 1, 2, \ldots, J - 1\}$;
$t^{\ell} = t_0 + \ell \Delta t$ for $\ell \in \{0, 1, \ldots, L - 1\}$; and
$X_j^{\ell} \approx X(t^{\ell}, a_j)$ for $X \in \{M, S, E, I, R\}$.
For each $j$ and each $\ell \geq 1$, the Crank--Nicolson method on
characteristics is
\begin{subequations}
  \begin{align}
    \begin{split}
      M_0^{\ell} &=
      b(t^{\ell - 1 / 2})
      \frac{1}{2}
      \Bigg[
      \sum_{j = 1}^{J - 1}
      \frac{\nu(a_j) R_j^{\ell} + \nu(a_{j - 1}) R_{j - 1}^{\ell}}{2}
      \Delta t
      \\ & \quad\quad\quad\quad\quad\quad\quad {}
      + \sum_{j = 1}^{J - 1}
      \frac{\nu(a_j) R_j^{\ell - 1} + \nu(a_{j - 1}) R_{j - 1}^{\ell - 1}}{2}
      \Delta t
      \Bigg],
    \end{split}
    \\
    \frac{M_j^{\ell} - M_{j - 1}^{\ell - 1}}{\Delta t} &=
    - \omega \frac{M_j^{\ell} + M_{j - 1}^{\ell - 1}}{2}
    - \frac{\mu(a_j) M_j^{\ell} + \mu(a_{j - 1}) M_{j - 1}^{\ell - 1}}{2},
    \\
    \begin{split}
      S_0^{\ell} &=
      b(t^{\ell - 1 / 2})
      \frac{1}{2}
      \Bigg[
      \sum_{j = 1}^{J - 1}
      \frac{\nu(a_j) (N_j^{\ell} - R_j^{\ell})
        + \nu(a_{j - 1}) (N_{j - 1}^{\ell} - R_{j - 1}^{\ell})}
      {2}
      \Delta t
      \\ & \quad\quad\quad\quad\quad\quad\quad {}
      + \sum_{j = 1}^{J - 1}
      \frac{\nu(a_j) (N_j^{\ell - 1} - R_j^{\ell - 1})
        + \nu(a_{j - 1}) (N_{j - 1}^{\ell - 1} - R_{j - 1}^{\ell - 1})}
      {2}
      \Delta t
      \Bigg],
    \end{split}
    \\
    \begin{split}
      \frac{S_j^{\ell} - S_j^{\ell - 1}}{\Delta t} &=
      \omega \frac{M_j^{\ell} + M_{j - 1}^{\ell - 1}}{2}
      - \frac{\lambda^{\ell} S_j^{\ell} + \lambda^{\ell - 1} S_{j - 1}^{\ell - 1}}{2}
      \\ & \quad {}
      - \frac{\mu(a_j) S_j^{\ell} + \mu(a_{j - 1}) S_{j - 1}^{\ell - 1}}{2},
    \end{split}
    \\
    E_0^{\ell} &= 0,
    \\
    \begin{split}
      \frac{E_j^{\ell} - E_{j - 1}^{\ell - 1}}{\Delta t} &=
      \frac{\lambda^{\ell} S_j^{\ell} + \lambda^{\ell - 1} S_{j - 1}^{\ell - 1}}{2}
      - \rho \frac{E_j^{\ell} + E_{j - 1}^{\ell - 1}}{2}
      \\ & \quad {}
      - \frac{\mu(a_j) E_j^{\ell} + \mu(a_{j - 1}) E_{j - 1}^{\ell - 1}}{2},
    \end{split}
    \\
    I_0^{\ell} &= 0,
    \\
    \frac{I_j^{\ell} - I_{j - 1}^{\ell - 1}}{\Delta t} &=
    \rho \frac{E_j^{\ell} + E_{j - 1}^{\ell}}{2}
    - \gamma \frac{I_j^{\ell} + I_{j - 1}^{\ell - 1}}{2}
    - \frac{\mu(a_j) I_j^{\ell} + \mu(a_{j - 1}) I_{j - 1}^{\ell - 1}}{2},
    \\
    R_0^{\ell} &= 0,
    \\
    \frac{R_j^{\ell} - R_j^{\ell - 1}}{\Delta t} &=
    \gamma \frac{I_j^{\ell} + I_{j - 1}^{\ell}}{2}
    - \frac{\mu(a_j) R_j^{\ell} + \mu(a_{j - 1}) R_{j - 1}^{\ell - 1}}{2},
  \end{align}
  with force of infection
  \begin{equation}
    \lambda^{\ell} =
    \beta \sum_{j = 1}^{J - 1}
    \frac{I_j^{\ell} + I_{j - 1}^{\ell}}{2}
    \Delta t
  \end{equation}
  and population size
  \begin{equation}
    N_j^{\ell} =
    M_j^{\ell} + S_j^{\ell} + E_j^{\ell} + I_j^{\ell} + R_j^{\ell}.
  \end{equation}
\end{subequations}

Let
\begin{subequations}
  \begin{align}
    \vec{x}^{\ell} &=
    \begin{bmatrix}
      M_0^{\ell} \\ \vdots \\ M_{J - 1}^{\ell} \\
      S_0^{\ell} \\ \vdots \\ S_{J - 1}^{\ell} \\
      E_0^{\ell} \\ \vdots \\ E_{J - 1}^{\ell} \\
      I_0^{\ell} \\ \vdots \\ I_{J - 1}^{\ell} \\
      R_0^{\ell} \\ \vdots \\ R_{J - 1}^{\ell}
    \end{bmatrix},
    \\
    \vec{v} &=
    \Delta t
    \begin{bmatrix}
      \frac{1}{2} & 1 & \cdots & 1 & \frac{1}{2}
    \end{bmatrix},
    \\
    \vec{\beta} &=
    \beta
    \begin{bmatrix}
      \vec{0} & \vec{0} & \vec{0} & \vec{v} & \vec{0}
    \end{bmatrix}
    \\
    \lambda^{\ell} &=
    \vec{\beta} \vec{x}^{\ell},
    \\
    \vec{\nu} &=
    \begin{bmatrix}
      \nu(a_0) & \cdots & \nu(a_{J - 1})
    \end{bmatrix},
    \\
    \mat{P}_{MM} &=
    \begin{bmatrix}
      1 & 0 & \cdots & 0
      \\
      0 & 1 + \frac{\Delta t}{2} \left[\omega + \mu(a_1)\right] &
      \ddots & \vdots
      \\
      \vdots & \ddots & \ddots & 0
      \\
      0 & \cdots & 0 &
      1 + \frac{\Delta t}{2} \left[\omega + \mu(a_{J - 1})\right]
    \end{bmatrix},
    \\
    \mat{Q}_{MM} &=
    \begin{bmatrix}
      0 & \cdots & \cdots & \cdots & 0
      \\
      1 - \frac{\Delta t}{2} \left[\omega + \mu(a_0)\right] & \ddots &
      & & \vdots
      \\
      0 & \ddots & \ddots & & \vdots
      \\
      \vdots & \ddots & \ddots & \ddots & \vdots
      \\
      0 & \cdots & 0 &
      1 - \frac{\Delta t}{2} \left[\omega + \mu(a_{J - 2})\right] & 0
    \end{bmatrix},
    \\
    \mat{C}_{SM} &=
    \frac{\Delta t}{2} \omega \mat{I},
    \\
    \mat{P}_{SS} &=
    \begin{bmatrix}
      1 & 0 & \cdots & 0
      \\
      0 & 1 + \frac{\Delta t}{2} \mu(a_1) &
      \ddots & \vdots
      \\
      \vdots & \ddots & \ddots & 0
      \\
      0 & \cdots & 0 &
      1 + \frac{\Delta t}{2} \mu(a_{J - 1})
    \end{bmatrix},
    \\
    \mat{Q}_{SS} &=
    \begin{bmatrix}
      0 & \cdots & \cdots & \cdots & 0
      \\
      1 - \frac{\Delta t}{2} \mu(a_0) & \ddots &
      & & \vdots
      \\
      0 & \ddots & \ddots & & \vdots
      \\
      \vdots & \ddots & \ddots & \ddots & \vdots
      \\
      0 & \cdots & 0 &
      1 - \frac{\Delta t}{2} \mu(a_{J - 2}) & 0
    \end{bmatrix},
    \\
    \mat{P}_{EE} &=
    \begin{bmatrix}
      1 & 0 & \cdots & 0
      \\
      0 & 1 + \frac{\Delta t}{2} \left[\rho + \mu(a_1)\right] &
      \ddots & \vdots
      \\
      \vdots & \ddots & \ddots & 0
      \\
      0 & \cdots & 0 &
      1 + \frac{\Delta t}{2} \left[\rho + \mu(a_{J - 1})\right]
    \end{bmatrix},
    \\
    \mat{Q}_{EE} &=
    \begin{bmatrix}
      0 & \cdots & \cdots & \cdots & 0
      \\
      1 - \frac{\Delta t}{2} \left[\rho + \mu(a_0)\right] & \ddots &
      & & \vdots
      \\
      0 & \ddots & \ddots & & \vdots
      \\
      \vdots & \ddots & \ddots & \ddots & \vdots
      \\
      0 & \cdots & 0 &
      1 - \frac{\Delta t}{2} \left[\rho + \mu(a_{J - 2})\right] & 0
    \end{bmatrix},
    \\
    \mat{C}_{IE} &=
    \frac{\Delta t}{2} \rho \mat{I},
    \\
    \mat{P}_{II} &=
    \begin{bmatrix}
      1 & 0 & \cdots & 0
      \\
      0 & 1 + \frac{\Delta t}{2} \left[\gamma + \mu(a_1)\right] &
      \ddots & \vdots
      \\
      \vdots & \ddots & \ddots & 0
      \\
      0 & \cdots & 0 &
      1 + \frac{\Delta t}{2} \left[\gamma + \mu(a_{J - 1})\right]
    \end{bmatrix},
    \\
    \mat{Q}_{II} &=
    \begin{bmatrix}
      0 & \cdots & \cdots & \cdots & 0
      \\
      1 - \frac{\Delta t}{2} \left[\gamma + \mu(a_0)\right] & \ddots &
      & & \vdots
      \\
      0 & \ddots & \ddots & & \vdots
      \\
      \vdots & \ddots & \ddots & \ddots & \vdots
      \\
      0 & \cdots & 0 &
      1 - \frac{\Delta t}{2} \left[\gamma + \mu(a_{J - 2})\right] & 0
    \end{bmatrix},
    \\
    \mat{C}_{RI} &=
    \frac{\Delta t}{2} \gamma \mat{I},
    \\
    \mat{P}_{RR} &=
    \begin{bmatrix}
      1 & 0 & \cdots & 0
      \\
      0 & 1 + \frac{\Delta t}{2} \mu(a_1) &
      \ddots & \vdots
      \\
      \vdots & \ddots & \ddots & 0
      \\
      0 & \cdots & 0 &
      1 + \frac{\Delta t}{2} \mu(a_{J - 1})
    \end{bmatrix},
    \\
    \mat{Q}_{RR} &=
    \begin{bmatrix}
      0 & \cdots & \cdots & \cdots & 0
      \\
      1 - \frac{\Delta t}{2} \mu(a_0) & \ddots &
      & & \vdots
      \\
      0 & \ddots & \ddots & & \vdots
      \\
      \vdots & \ddots & \ddots & \ddots & \vdots
      \\
      0 & \cdots & 0 &
      1 - \frac{\Delta t}{2} \mu(a_{J - 2}) & 0
    \end{bmatrix},
    \\
    \mat{P} &=
    \begin{bmatrix}
      \mat{P}_{MM} & \mat{0} & \mat{0} & \mat{0} & \mat{0}
      \\
      - \mat{C}_{SM} & \mat{P}_{SS} & \mat{0} & \mat{0} & \mat{0}
      \\
      \mat{0} & \mat{0} & \mat{P}_{EE} & \mat{0} & \mat{0}
      \\
      \mat{0} & \mat{0} & - \mat{C}_{IE} & \mat{P}_{II} & \mat{0}
      \\
      \mat{0} & 0 & \mat{0} & - \mat{C}_{RI} & \mat{P}_{RR}
    \end{bmatrix},
    \\
    \mat{Q} &=
    \begin{bmatrix}
      \mat{Q}_{MM} & \mat{0} & \mat{0} & \mat{0} & \mat{0}
      \\
      \mat{C}_{SM} & \mat{Q}_{SS} & \mat{0} & \mat{0} & \mat{0}
      \\
      \mat{0} & \mat{0} & \mat{Q}_{EE} & \mat{0} & \mat{0}
      \\
      \mat{0} & \mat{0} & \mat{C}_{IE} & \mat{Q}_{II} & \mat{0}
      \\
      \mat{0} & \mat{0} & \mat{0} & \mat{C}_{RI} & \mat{Q}_{RR}
    \end{bmatrix},
    \\
    \mat{B}_{MR} &= \mat{B}_{SM} = \mat{B}_{SS} = \mat{B}_{SE} = \mat{B}_{SI}
    =
    \frac{1}{2}
    \begin{bmatrix}
      \vec{v} \circ \vec{\nu} \\ \vec{0} \\ \vdots \\ \vec{0}
    \end{bmatrix},
    \\
    \mat{B} &=
    \begin{bmatrix}
      \mat{0} & \mat{0} & \mat{0} & \mat{0} & \mat{B}_{MR}
      \\
      \mat{B}_{SM} & \mat{B}_{SS} & \mat{B}_{SE} & \mat{B}_{SI} & \mat{0}
      \\
      \mat{0} & \mat{0} & \mat{0} & \mat{0} & \mat{0}
      \\
      \mat{0} & \mat{0} & \mat{0} & \mat{0} & \mat{0}
      \\
      \mat{0} & \mat{0} & \mat{0} & \mat{0} & \mat{0}
    \end{bmatrix},
    \\
    \mat{T}_{SS} &=
    - \frac{\Delta t}{2} \mat{I},
    \\
    \mat{T}_{ES} &=
    \frac{\Delta t}{2} \mat{I},
    \\
    \mat{T} &=
    \begin{bmatrix}
      \mat{0} & \mat{0} & \mat{0} & \mat{0} & \mat{0}
      \\
      \mat{0} & \mat{T}_{SS} & \mat{0} & \mat{0} & \mat{0}
      \\
      \mat{0} & \mat{T}_{ES} & \mat{0} & \mat{0} & \mat{0}
      \\
      \mat{0} & \mat{0} & \mat{0} & \mat{0} & \mat{0}
      \\
      \mat{0} & \mat{0} & \mat{0} & \mat{0} & \mat{0}
    \end{bmatrix},
    \\
    \mat{P}^{\ell} &=
    \mat{P} - b(t^{\ell - 1 / 2}) \mat{B},
    \\
    \vec{d}^{\ell - 1} &=
    \left[
      \mat{Q}
      + b(t^{\ell - 1 / 2}) \mat{B}
      + \vec{\beta} \vec{x}^{\ell - 1} \mat{T}
    \right] \vec{x}^{\ell - 1}.
  \end{align}
\end{subequations}
Then, for each $\ell \in \{1, 2, \ldots, L - 1\}$,
we use a nonlinear solver to find $\vec{x}^{\ell}$ that satisfies
\begin{equation}
  \left[
    \mat{P}^{\ell}
    - \vec{\beta} \vec{x}^{\ell} \mat{T}
  \right] \vec{x}^{\ell}
  - \vec{d}^{\ell - 1}
  = \vec{0}.
\end{equation}


\section{Age- and time-since-entry-structured model}

The model is
\begin{subequations}
  \label{model_age_and_time_since_entry_structured}
  \begin{align}
    M(t, 0) &=
    b(t) \int_0^{+\infty} \nu(a) R(t, a) \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    M(t, a) &=
    - \omega(a) M(t, a) - \mu(a) M(t, a),
    \\
    S(t, 0) &=
    b(t) \int_0^{+\infty} \nu(a) \left[N(t, a) - R(t, a)\right] \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    S(t, a) &=
    \omega(a) M(t, a) - \lambda(t) S(t, a) - \mu(a) S(t, a),
    \\
    e(t, 0, 0) &=
    \lambda(t) S(t, 0),
    \\
    e(t, 0, z) &=
    0,
    \\
    e(t, a, 0) &=
    \lambda(t) S(t, a),
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}
      + \frac{\partial}{\partial z}\right)
    e(t, a, z) &=
    - \rho(z) e(t, a, z) - \mu(a) e(t, a, z),
    \\
    i(t, 0, 0) &=
    0,
    \\
    i(t, 0, z) &=
    0,
    \\
    i(t, a, 0) &=
    \int_0^{+\infty} \rho(z) e(t, a, z) \md z,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}
      + \frac{\partial}{\partial z}\right)
    i(t, a, z) &=
    - \gamma(z) i(t, a, z) - \mu(a) i(t, a, z),
    \\
    R(t, 0) &=
    0,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    R(t, a) &=
    \int_0^{+\infty} \gamma(z) i(t, a, z) \md z
    - \mu(a) R(t, a),
  \end{align}
  with force of infection
  \begin{equation}
    \lambda(t) =
    \beta
    \int_0^{+\infty} \int_0^{+\infty}
    i(t, a, z)
    \md a \md z
  \end{equation}
  and population size
  \begin{equation}
    N(t, a) =
    M(t, a) + S(t, a) + R(t, a)
    + \int_0^{+\infty} e(t, a, z) + i(t, a, z) \md z.
  \end{equation}
\end{subequations}


\subsection{Total population}

The total population follows the linear PDE
\begin{subequations}
  \begin{align}
    N(t, 0) &=
    b(t) \int_0^{+\infty} \nu(a) N(t, a) \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    N(t, a) &=
    - \mu(a) N(t, a).
  \end{align}
\end{subequations}
This is the same PDE for total population as in the age-structured
model: as we did for that model, we used Floquet theory and a
nonlinear solver to find the value of the mean birth rate $\bar{b}$
that gives population growth rate $r = 0$.


\subsection{Numerical method}

To numerically solve the system
\eqref{model_age_and_time_since_entry_structured}, we used the
Crank--Nicolson method on characteristics and the composite trapezoid
rule for the integrals \autocite{milner_1992}.  Given the time step
$\Delta t$, let $a_j = j \Delta t$ for
$j \in \{0, 1, 2, \ldots, J - 1\}$;
$z_k = k \Delta t$
for $k \in \{0, 1, 2, \ldots, J - 1\}$;
$t^{\ell} = t_0 + \ell \Delta t$ for
$\ell \in \{0, 1, \ldots, L - 1\}$;
$X_j^{\ell} \approx X(t^{\ell}, a_j)$
for $X \in \{M, S, R\}$;
and $y_{j, k}^{\ell} \approx y(t^{\ell}, a_j, z_k)$
for $y \in \{E, I\}$.
For each $j$, each $k$, and each $\ell \geq 1$, the Crank--Nicolson
method on characteristics is
\begin{subequations}
  \begin{align}
    \begin{split}
      M_0^{\ell}
      &=
      b(t^{\ell - 1 / 2})
      \frac{1}{2}
      \Bigg[
      \sum_{j = 1}^{J - 1}
      \frac{\nu(a_j) R_j^{\ell} + \nu(a_{j - 1}) R_{j - 1}^{\ell}}{2}
      \Delta t
      \\ & \quad\quad\quad\quad\quad\quad\quad {}
      + \sum_{j = 1}^{J - 1}
      \frac{\nu(a_j) R_j^{\ell - 1} + \nu(a_{j - 1}) R_{j - 1}^{\ell - 1}}{2}
      \Delta t
      \Bigg],
    \end{split}
    \\
    \begin{split}
      \frac{M_j^{\ell} - M_{j - 1}^{\ell - 1}}{\Delta t}
      &=
      - \frac{\omega(a_j) M_j^{\ell}
        + \omega(a_{j - 1}) M_{j - 1}^{\ell - 1}}
      {2}
      \\ & \quad {}
      - \frac{\mu(a_j) M_j^{\ell}
        + \mu(a_{j - 1}) M_{j - 1}^{\ell - 1}}
      {2},
    \end{split}
    \\
    \begin{split}
      S_0^{\ell}
      &=
      b(t^{\ell - 1 / 2})
      \frac{1}{2}
      \Bigg[
      \sum_{j = 1}^{J - 1}
      \frac{\nu(a_j) (N_j^{\ell} - R_j^{\ell})
        + \nu(a_{j - 1}) (N_{j - 1}^{\ell} - R_{j - 1}^{\ell})}
      {2}
      \Delta t
      \\ & \quad\quad\quad\quad\quad\quad\quad {}
      + \sum_{j = 1}^{J - 1}
      \frac{\nu(a_j) (N_j^{\ell - 1} - R_j^{\ell - 1})
        + \nu(a_{j - 1}) (N_{j - 1}^{\ell - 1} - R_{j - 1}^{\ell - 1})}
      {2}
      \Delta t
      \Bigg],
    \end{split}
    \\
    \begin{split}
      \frac{S_j^{\ell} - S_{j - 1}^{\ell - 1}}{\Delta t}
      &=
      \frac{\omega(a_j) M_j^{\ell}
        + \omega(a_{j - 1}) M_{j - 1}^{\ell - 1}}
      {2}
      \\ & \quad {}
      - \frac{\lambda^{\ell} S_j^{\ell}
        + \lambda^{\ell - 1} S_{j - 1}^{\ell - 1}}
      {2}
      \\ & \quad {}
      - \frac{\mu(a_j) S_j^{\ell}
        + \mu(a_{j - 1}) S_{j - 1}^{\ell - 1}}
      {2},
    \end{split}
    \\
    e_{0, 0}^{\ell}
    &=
    \frac{\lambda^{\ell} S_0^{\ell}}
    {2},
    \\
    e_{0, k}^{\ell}
    &= 0,
    \\
    e_{j, 0}^{\ell}
    &=
    \frac{\lambda^{\ell} S_j^{\ell}
      + \lambda^{\ell - 1} S_{j - 1}^{\ell - 1}}
    {2},
    \\
    \begin{split}
      \frac{e_{j, k}^{\ell} - e_{j - 1, k - 1}^{\ell - 1}}{\Delta t}
      &=
      - \frac{\rho(z_k) e_{j, k}^{\ell}
        + \rho(z_{k - 1}) e_{j - 1, k - 1}^{\ell - 1}}
      {2}
      \\ & \quad {}
      - \frac{\mu(a_j) e_{j, k}^{\ell}
        + \mu(a_{j - 1}) e_{j - 1, k - 1}^{\ell - 1}}
      {2},
    \end{split}
    \\
    i_{0, 0}^{\ell}
    &= 0,
    \\
    i_{0, k}^{\ell}
    &= 0,
    \\
    \begin{split}
      i_{j, 0}^{\ell}
      &=
      \frac{1}{2} \sum_{k = 1}^{J - 1}
      \frac{\rho(z_k) e_{j, k}^{\ell}
        + \rho(z_{k - 1}) e_{j, k - 1}^{\ell}}
      {2}
      \Delta t
      \\ & \quad {}
      + \frac{1}{2} \sum_{k = 1}^{J - 1}
      \frac{\rho(z_k) e_{j - 1, k}^{\ell - 1}
        + \rho(z_{k - 1}) e_{j - 1, k - 1}^{\ell - 1}}
      {2}
      \Delta t,
    \end{split}
    \\
    \begin{split}
      \frac{i_{j, k}^{\ell} - i_{j - 1, k - 1}^{\ell - 1}}{\Delta t}
      &=
      - \frac{\gamma(z_k) i_{j, k}^{\ell}
        + \gamma(z_{k - 1}) i_{j - 1, k - 1}^{\ell - 1}}
      {2}
      \\ & \quad {}
      - \frac{\mu(a_j) i_{j, k}^{\ell}
        + \mu(a_{j - 1}) i_{j - 1, k - 1}^{\ell - 1}}
      {2},
    \end{split}
    \\
    R_0^{\ell}
    &= 0,
    \\
    \begin{split}
      \frac{R_j^{\ell} - R_{j - 1}^{\ell - 1}}{\Delta t}
      &=
      \frac{1}{2} \sum_{k = 1}^{J - 1}
      \frac{\gamma(z_k) i_{j, k}^{\ell}
        + \gamma(z_{k - 1}) i_{j, k - 1}^{\ell}}
      {2}
      \Delta t
      \\ & \quad {}
      + \frac{1}{2} \sum_{k = 1}^{J - 1}
      \frac{\gamma(z_k) i_{j - 1, k}^{\ell - 1}
        + \gamma(z_{k - 1}) i_{j - 1, k - 1}^{\ell - 1}}
      {2}
      \Delta t,
      \\ & \quad {}
      - \frac{\mu(a_j) R_j^{\ell}
        + \mu(a_{j - 1})R_{j - 1}^{\ell - 1}}
      {2},
    \end{split}
  \end{align}
  with force of infection
  \begin{equation}
    \lambda^l =
    \beta
    \sum_{j = 1}^{J - 1}
    \sum_{k = 1}^{J - 1}
    \frac{i_{j, k}^{\ell}
      + i_{j, k - 1}^{\ell}
      + i_{j - 1, k}^{\ell}
      + i_{j - 1, k - 1}^{\ell}}
    {4}
    (\Delta t)^2,
  \end{equation}
  and population size
  \begin{equation}
    N_j^{\ell} =
    M_j^{\ell} + S_j^{\ell} + R_j^{\ell}
    + \sum_{k = 1}^{J - 1}
    \frac{e_{j, k}^{\ell} + i_{j, k}^{\ell}
      + e_{j, k - 1}^{\ell} + i_{j, k - 1}^{\ell}}
    {2}
    \Delta t.
  \end{equation}
\end{subequations}


\printbibliography

\end{document}
