\documentclass{jpmarticle}

\usepackage{units}
\usepackage{csquotes}
\usepackage[style=vancouver]{biblatex}
\addbibresource{notes.bib}

\renewcommand{\vec}[1]{\boldsymbol{\mathrm{#1}}}

\title{Crank--Nicolson for some SIR models}
\author{Jan Medlock}

\begin{document}

\maketitle


All of the models will use the periodic birth rate
\begin{equation}
  b(t) = \bar{b} \left[
    1 + \sigma \sqrt{2} \cos\left(2 \pi t / T\right)
  \right],
\end{equation}
with period
\begin{equation}
  T = \unit[1]{y}.
\end{equation}
As we will show for each model, the mean birth rate $\bar{b}$
was chosen so that the total population is periodic in time.


\section{Unstructured model}

The model is
\begin{equation}
  \label{model_unstructured}
  \begin{split}
    \frac{\md}{\md t} M(t) &=
    b(t) R(t) - \omega M(t) - \mu M(t),
    \\
    \frac{\md}{\md t} S(t) &=
    b(t) \left[N(t) - R(t)\right] + \omega M(t) - \lambda(t) S(t) - \mu S(t),
    \\
    \frac{\md}{\md t} E(t) &=
    \lambda(t) S(t) - \rho E(t) - \mu E(t),
    \\
    \frac{\md}{\md t} I(t) &=
    \rho E(t) - \gamma I(t) - \mu I(t),
    \\
    \frac{\md}{\md t} R(t) &=
    \gamma I(t) - \mu R(t),
  \end{split}
\end{equation}
with force of infection
\begin{equation}
  \lambda(t) = \beta I(t)
\end{equation}
and population size
\begin{equation}
  N(t) = M(t) + S(t) + E(t) + I(t) + R(t).
\end{equation}


\subsection{Total population}

The total population follows
\begin{equation}
  \begin{split}
    \frac{\md}{\md t} N(t)
    &= b(t) N(t) - \mu N(t)
    \\
    &= \left[
      \bar{b} - \mu
      + \bar{b} \sigma \sqrt{2} \cos\left(2 \pi t / T\right)
    \right]
    N(t),
  \end{split}
\end{equation}
so that
\begin{equation}
  N(t) = N(0) \exp\left[
    \left(\bar{b} - \mu\right) t
    + \frac{\bar{b} \sigma T}{\pi \sqrt{2}}
    \sin\left(2 \pi t / T\right)
  \right].
\end{equation}
We chose $\bar{b} = \mu$ so that
\begin{equation}
  N(t) = N(0) \exp\left[
    \frac{\mu \sigma T}{\pi \sqrt{2}}
    \sin\left(2 \pi t / T\right)
  \right],
\end{equation}
i.e.~periodic with period $T = \unit[1]{y}$.


\subsection{Numerical method}

For the system of differential equations
\begin{equation}
  \begin{split}
    \frac{\md}{\md t} \vec{X}(t)
    &= \vec{f}\left(t, \vec{X}(t)\right),
    \\
    \vec{X}(0) &= \vec{X}^0,
  \end{split}
\end{equation}
and time step $\Delta t$, let $t^k = k \Delta t$ for
$k \in \{0, 1, \ldots, K - 1\}$ and
\begin{equation}
  \vec{X}^k \approx \vec{X}(t^k).
\end{equation}
The Crank--Nicolson scheme is
\begin{equation}
  \frac{\vec{X}^k - \vec{X}^{k - 1}}{\Delta t}
  = \frac{
    \vec{f}\left(t^k, \vec{X}^k\right)
    + \vec{f}\left(t^{k - 1}, \vec{X}^{k - 1}\right)
  }{2}
\end{equation}
for $k \in \{1, \ldots, K - 1\}$.
That is, we must find $\vec{X}^k$ such that
\begin{equation}
  \label{cn_unstructured}
  \vec{X}^k
  - \frac{\Delta t}{2}
  \vec{f}\left(t^k, \vec{X}^k\right)
  - \vec{X}^{k - 1}
  - \frac{\Delta t}{2}
  \vec{f}\left(t^{k - 1}, \vec{X}^{k - 1}\right)
  = \vec{0}.
\end{equation}
If $\vec{f}\left(t^k, \vec{X}^k\right)$ is linear in $\vec{X}^k$
then equation \eqref{cn_unstructured} may be solved efficiently for
$\vec{X}^k$ using matrix algebra, but generally we must use a
nonlinear solver.

For model \eqref{model_unstructured},
\begin{equation}
  \vec{X}^k =
  \begin{bmatrix}
    M^k \\ S^k \\ E^k \\ I^k \\ R^k
  \end{bmatrix}
\end{equation}
and
\begin{equation}
  \vec{f}\left(t^k, \vec{X}^k\right) =
  \begin{bmatrix}
    b\left(t^k\right) R^k
    - \omega M^k
    - \mu M^k
    \\
    b\left(t^k\right) \left(N^k - R^k\right)
    + \omega M^k
    - \beta I^k S^k
    - \mu S^k
    \\
    \beta I^k S^k
    - \rho E^k
    - \mu E^l
    \\
    \rho E^k
    - \gamma I^k
    - \mu I^k
    \\
    \gamma I^k
    - \mu R^k
  \end{bmatrix},
\end{equation}
where
\begin{equation}
  \label{eq:1}
  N^k = M^k + S^k + E^k + I^k + R^k.
\end{equation}


\section{Time-since-entry-structured model}

The model is
\begin{equation}
  \label{model_time_since_entry_structured}
  \begin{split}
    m(t, 0) &=
    b(t) R(t),
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial z}\right)
    m(t, z) &=
    - \omega(z) m(t, z) - \mu m(t, z),
    \\
    \frac{\md}{\md t} S(t) &=
    b(t) \left[N(t) - R(t)\right]
    + \int_0^{+\infty} \omega(z) m(t, z) \md z
    \\ & \quad {}
    - \lambda(t) S(t) - \mu S(t),
    \\
    e(t, 0) &=
    \lambda(t) S(t),
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial z}\right)
    e(t, z) &=
    - \rho(z) e(t, z) - \mu e(t, z),
    \\
    i(t, 0) &=
    \int_0^{+\infty} \rho(z) e(t, z) \md z,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial z}\right)
    i(t, z) &=
    - \gamma(z) i(t, z) - \mu i(t, z),
    \\
    \frac{\md}{\md t} R(t) &=
    \int_0^{+\infty} \gamma(z) i(t, z) \md z
    - \mu R(t),
  \end{split}
\end{equation}
with force of infection
\begin{equation}
  \lambda(t) = \beta \int_0^{+\infty} i(t, z) \md z
\end{equation}
and population size
\begin{equation}
  N(t) =
  S(t) + R(t)
  + \int_0^{+\infty} m(t, z) + e(t, z) + i(t, z) \md z.
\end{equation}


\subsection{Total population}

\textbf{TODO: Simplify.}

As before, the total population follows
\begin{equation}
  \begin{split}
    \frac{\md}{\md t} N(t)
    &= \frac{\md}{\md t} S(t)
    + \frac{\md}{\md t} R(t)
    + \frac{\md}{\md t} \int_0^{+\infty} m(t, z) + e(t, z) + i(t, z) \md z
    \\
    &= \frac{\md}{\md t} S(t)
    + \frac{\md}{\md t} R(t)
    + \int_0^{+\infty} \frac{\partial}{\partial t} m(t, z)
    + \frac{\partial}{\partial t} e(t, z)
    + \frac{\partial}{\partial t} i(t, z) \md z
    \\
    &=
    b(t) \left[N(t) - R(t)\right]
    + \int_0^{+\infty} \omega(z) m(t, z) \md z
    - \lambda(t) S(t) - \mu S(t)
    \\ & \quad {}
    + \int_0^{+\infty} \gamma(z) i(t, z) \md z
    - \mu R(t)
    \\ & \quad {}
    - \int_0^{+\infty}
    \frac{\partial}{\partial z} m(t, z)
    + \omega(z) m(t, z)
    + \mu m(t, z)
    \md z
    \\ & \quad {}
    - \int_0^{+\infty}
    \frac{\partial}{\partial z} e(t, z)
    + \rho(z) e(t, z)
    + \mu e(t, z)
    \md z
    \\ & \quad {}
    - \int_0^{+\infty}
    \frac{\partial}{\partial z} i(t, z)
    + \gamma(z) i(t, z)
    + \mu i(t, z)
    \md z
    \\
    &=
    b(t) \left[N(t) - R(t)\right]
    \\ & \quad {}
    - \mu \left[
      S(t) + R(t)
      + \int_0^{+\infty}
      m(t, z) + e(t, z) + i(t, z)
      \md z
    \right]
    \\ & \quad {}
    - \lambda(t) S(t)
    - \int_0^{+\infty}
    \rho(z) e(t, z)
    \md z
    \\ & \quad {}
    - m(t, +\infty) - e(t, +\infty) - i(t, +\infty)
    + m(t, 0) + e(t, 0) + i(t, 0)
    \\
    &=
    b(t) \left[N(t) - R(t)\right]
    - \mu N(t)
    \\ & \quad {}
    - \lambda(t) S(t)
    - \int_0^{+\infty}
    \rho(z) e(t, z)
    \md z
    \\ & \quad {}
    + b(t) R(t)
    + \lambda(t) S(t)
    + \int_0^{+\infty} \rho(z) e(t, z) \md z
    \\
    &= b(t) N(t) - \mu N(t)
    \\
    &= \left[
      \bar{b} - \mu
      + \bar{b} \sigma \sqrt{2} \cos\left(2 \pi t / T\right)
    \right] N(t).
  \end{split}
\end{equation}
This is the same ODE for total population as in the unstructured
model: as we did for that model, we chose $\bar{b} = \mu$ so that
$N(t)$ is periodic.


\subsection{Numerical method}

To numerically solve the system
\eqref{model_time_since_entry_structured}, we used the Crank--Nicolson
method on characteristics and the composite trapezoid rule for the birth
integral \autocite{milner_1992}.  Given the time step $\Delta t$,
let $z_j = j \Delta t$ for $j \in \{0, 1, 2, \ldots, J - 1\}$;
$t^k = t_0 + k \Delta t$ for $k \in \{0, 1, \ldots, K - 1\}$;
$X^k \approx X(t^k)$ for $X \in \{S, R\}$;
and $y_j^k \approx y(t^k, z_j)$ for $y \in \{m, e, i\}$.
For each $j$ and each $k \geq 1$, the Crank--Nicolson method on
characteristics is
\begin{equation}
  \begin{split}
    m_0^k &=
    b(t^{k - 1 / 2}) \frac{R^k + R^{k - 1}}{2},
    \\
    \frac{m_j^k - m_{j - 1}^{k - 1}}{\Delta t} &=
    - \frac{\omega(z_j) m_j^k + \omega(z_{j - 1}) m_{j - 1}^{k - 1}}{2}
    - \mu \frac{m_j^k + m_{j - 1}^{k - 1}}{2},
    \\
    \frac{S^k - S^{k - 1}}{\Delta t} &=
    b(t^{k - 1 / 2}) \left(\frac{N^k + N^{k - 1}}{2}
      - \frac{R^k + R^{k - 1}}{2}\right)
    \\ & \quad {}
    + \frac{1}{2} \sum_{j = 1}^{J - 1}
    \frac{\omega(z_j) m_j^k + \omega(z_{j - 1}) m_{j - 1}^k}{2}
    \Delta t
    \\ & \quad {}
    + \frac{1}{2} \sum_{j = 1}^{J - 1}
    \frac{\omega(z_j) m_j^{k - 1} + \omega(z_{j - 1}) m_{j - 1}^{k - 1}}{2}
    \Delta t
    \\ & \quad {}
    - \frac{\lambda^k S^k + \lambda^{k - 1} S^{k - 1}}{2}
    - \mu \frac{S^k + S^{k - 1}}{2},
    \\
    e_0^k &=
    \frac{\lambda^k S^k + \lambda^{k - 1}S^{k - 1}}{2},
    \\
    \frac{e_j^k - e_{j - 1}^{k - 1}}{\Delta t} &=
    - \frac{\rho(z_j) e_j^k + \rho(z_{j - 1}) e_{j - 1}^{k - 1}}{2}
    - \mu \frac{e_j^k + e_{j - 1}^{k - 1}}{2},
    \\
    i_0^k &=
    \frac{1}{2} \sum_{j = 1}^{J - 1}
    \frac{\rho(z_j) e_j^k + \rho(z_{j - 1}) e_{j - 1}^k}{2}
    \Delta t
    \\ & \quad {}
    + \frac{1}{2} \sum_{j = 1}^{J - 1}
    \frac{\rho(z_j) e_j^{k - 1} + \rho(z_{j - 1}) e_{j - 1}^{k - 1}}{2}
    \Delta t,
    \\
    \frac{i_j^k - i_{j - 1}^{k - 1}}{\Delta t} &=
    - \frac{\gamma(z_j) i_j^k + \gamma(z_{j - 1}) i_{j - 1}^{k - 1}}{2}
    - \mu \frac{i_j^k + i_{j - 1}^{k - 1}}{2},
    \\
    \frac{R^k - R^{k - 1}}{\Delta t} &=
    \frac{1}{2} \sum_{j = 1}^{J - 1}
    \frac{\gamma(z_j) i_j^k + \gamma(z_{j - 1}) i_{j - 1}^k}{2}
    \Delta t
    \\ & \quad {}
    + \frac{1}{2} \sum_{j = 1}^{J - 1}
    \frac{\gamma(z_j) i_j^{k - 1} + \gamma(z_{j - 1}) i_{j - 1}^{k - 1}}{2}
    \Delta t,
    \\ & \quad {}
    - \mu \frac{R^k + R^{k - 1}}{2},
  \end{split}
\end{equation}
with force of infection
\begin{equation}
  \lambda^k =
  \beta \sum_{j = 1}^{J - 1}
  \frac{i_j^k + i_{j - 1}^k}{2}
  \Delta t
\end{equation}
and population size
\begin{equation}
  N^k =
  S^k + R^k
  + \sum_{j = 1}^{J - 1}
  \frac{m_j^k + e_j^k + i_j^k + m_{j - 1}^k + e_{j - 1}^k + i_{j - 1}^k}{2}
  \Delta t.
\end{equation}

Let
\begin{align}
  \vec{m}^k &=
  \begin{bmatrix}
    m_0^k \\ \vdots \\ m_{J - 1}^k
  \end{bmatrix},
  &
  \vec{e}^k &=
  \begin{bmatrix}
    e_0^k \\ \vdots \\ e_{J - 1}^k
  \end{bmatrix},
  &
  \vec{i}^k &=
  \begin{bmatrix}
    i_0^k \\ \vdots \\ i_{J - 1}^k
  \end{bmatrix},
\end{align}
\begin{equation}
  \vec{x}^k =
  \begin{bmatrix}
    m_0^k \\ \vdots \\ m_{J - 1}^k \\
    S^k \\
    e_0^k \\ \vdots \\ e_{J - 1}^k \\
    i_0^k \\ \vdots \\ i_{J - 1}^k \\
    R^k
  \end{bmatrix},
\end{equation}
\begin{equation}
  \begin{split}
    \vec{v} &=
    \Delta t
    \begin{bmatrix}
      \frac{1}{2} & 1 & \cdots & 1 & \frac{1}{2}
    \end{bmatrix},
    \\
    \vec{\beta} &=
    \begin{bmatrix}
      \vec{0} & 0 & \vec{0} & \beta \vec{v} & 0
    \end{bmatrix}
    \\
    \lambda^k &=
    \vec{\beta} \vec{x}^k,
    \\
    \vec{\omega} &=
    \begin{bmatrix}
      \omega(z_0) & \cdots & \omega(z_{J - 1})
    \end{bmatrix},
    \\
    \vec{\gamma} &=
    \begin{bmatrix}
      \gamma(z_0) & \cdots & \gamma(z_{J - 1})
    \end{bmatrix},
    \\
    \vec{\rho} &=
    \begin{bmatrix}
      \rho(z_0) & \cdots & \rho(z_{J - 1})
    \end{bmatrix},
  \end{split}
\end{equation}
\begin{equation}
  \begin{split}
    \mat{A}_{mm}^{\text{constant}} &=
    \begin{bmatrix}
      1 & 0 & \cdots & 0
      \\
      0 & 1 + \frac{\Delta t}{2} \left[\omega(z_1) + \mu\right] &
      \ddots & \vdots
      \\
      \vdots & \ddots & \ddots & 0
      \\
      0 & \cdots & 0 &
      1 + \frac{\Delta t}{2} \left[\omega(z_{J - 1}) + \mu\right]
    \end{bmatrix},
    \\
    \mat{B}_{mm}^{\text{constant}} &=
    \begin{bmatrix}
      0 & \cdots & \cdots & \cdots & 0
      \\
      1 - \frac{\Delta t}{2} \left[\omega(z_0) + \mu\right] & \ddots &
      & & \vdots
      \\
      0 & \ddots & \ddots & & \vdots
      \\
      \vdots & \ddots & \ddots & \ddots & \vdots
      \\
      0 & \cdots & 0 &
      1 - \frac{\Delta t}{2} \left[\omega(z_{J - 2}) + \mu\right] & 0
    \end{bmatrix},
  \end{split}
\end{equation}
\begin{equation}
  \begin{split}
    \vec{a}_{Sm}^{\text{constant}} &=
    - \frac{\Delta t}{2} \vec{v} \circ \vec{\omega},
    \\
    \vec{b}_{Sm}^{\text{constant}} &=
    \frac{\Delta t}{2} \vec{v} \circ \vec{\omega},
    \\
    a_{SS}^{\text{constant}} &=
    1 + \frac{\Delta t}{2} \mu,
    \\
    b_{SS}^{\text{constant}} &=
    1 - \frac{\Delta t}{2} \mu,
  \end{split}
\end{equation}
\begin{equation}
  \begin{split}
    \mat{A}_{ee}^{\text{constant}} &=
    \begin{bmatrix}
      1 & 0 & \cdots & 0
      \\
      0 & 1 + \frac{\Delta t}{2} \left[\rho(z_1) + \mu\right] &
      \ddots & \vdots
      \\
      \vdots & \ddots & \ddots & 0
      \\
      0 & \cdots & 0 &
      1 + \frac{\Delta t}{2} \left[\rho(z_{J - 1}) + \mu\right]
    \end{bmatrix},
    \\
    \mat{B}_{ee}^{\text{constant}} &=
    \begin{bmatrix}
      0 & \cdots & \cdots & \cdots & 0
      \\
      1 - \frac{\Delta t}{2} \left[\rho(z_0) + \mu\right] & \ddots &
      & & \vdots
      \\
      0 & \ddots & \ddots & & \vdots
      \\
      \vdots & \ddots & \ddots & \ddots & \vdots
      \\
      0 & \cdots & 0 &
      1 - \frac{\Delta t}{2} \left[\rho(z_{J - 2}) + \mu\right] & 0
    \end{bmatrix},
  \end{split}
\end{equation}
\begin{equation}
  \begin{split}
    \mat{A}_{ie}^{\text{constant}} &=
    \begin{bmatrix}
      - \frac{1}{2} \left(\vec{v} \circ \vec{\rho}\right)
      \\
      \vec{0}
      \\
      \vdots
      \\
      \vec{0}
    \end{bmatrix},
    \\
    \mat{B}_{ie}^{\text{constant}} &=
    \begin{bmatrix}
      \frac{1}{2} \left(\vec{v} \circ \vec{\rho}\right)
      \\
      \vec{0}
      \\
      \vdots
      \\
      \vec{0}
    \end{bmatrix},
    \\
    \mat{A}_{ii}^{\text{constant}} &=
    \begin{bmatrix}
      1 & 0 & \cdots & 0
      \\
      0 & 1 + \frac{\Delta t}{2} \left[\gamma(z_1) + \mu\right] &
      \ddots & \vdots
      \\
      \vdots & \ddots & \ddots & 0
      \\
      0 & \cdots & 0 &
      1 + \frac{\Delta t}{2} \left[\gamma(z_{J - 1}) + \mu\right]
    \end{bmatrix},
    \\
    \mat{B}_{ii}^{\text{constant}} &=
    \begin{bmatrix}
      0 & \cdots & \cdots & \cdots & 0
      \\
      1 - \frac{\Delta t}{2} \left[\gamma(z_0) + \mu\right] & \ddots &
      & & \vdots
      \\
      0 & \ddots & \ddots & & \vdots
      \\
      \vdots & \ddots & \ddots & \ddots & \vdots
      \\
      0 & \cdots & 0 &
      1 - \frac{\Delta t}{2} \left[\gamma(z_{J - 2}) + \mu\right] & 0
    \end{bmatrix},
  \end{split}
\end{equation}
\begin{equation}
  \begin{split}
    \vec{a}_{Ri}^{\text{constant}} &=
    - \frac{\Delta t}{2} \vec{v} \circ \vec{\gamma},
    \\
    \vec{b}_{Ri}^{\text{constant}} &=
    \frac{\Delta t}{2} \vec{v} \circ \vec{\gamma},
    \\
    a_{RR}^{\text{constant}} &=
    1 + \mu \frac{\Delta t}{2},
    \\
    b_{RR}^{\text{constant}} &=
    1 - \mu \frac{\Delta t}{2}.
  \end{split}
\end{equation}
\begin{equation}
  \begin{split}
    \mat{A}^{\text{constant}} &=
    \begin{bmatrix}
      \mat{A}_{mm}^{\text{constant}} & \vec{0} & \mat{0} & \mat{0} & \vec{0}
      \\
      \vec{a}_{Sm}^{\text{constant}} & a_{SS}^{\text{constant}} &
      \vec{0} & \vec{0} & 0
      \\
      \mat{0} & \vec{0} & \mat{A}_{ee}^{\text{constant}} & \mat{0} & \vec{0}
      \\
      \mat{0} & \vec{0} & \mat{A}_{ie}^{\text{constant}} &
      \mat{A}_{ii}^{\text{constant}} & \vec{0}
      \\
      \vec{0} & 0 & \vec{0} & \vec{a}_{Ri}^{\text{constant}} &
      a_{RR}^{\text{constant}}
    \end{bmatrix},
    \\
    \mat{B}^{\text{constant}} &=
    \begin{bmatrix}
      \mat{B}_{mm}^{\text{constant}} & \vec{0} & \mat{0} & \mat{0} & \vec{0}
      \\
      \vec{b}_{Sm}^{\text{constant}} & b_{SS}^{\text{constant}} &
      \vec{0} & \vec{0} & 0
      \\
      \mat{0} & \vec{0} & \mat{B}_{ee}^{\text{constant}} & \mat{0} & \vec{0}
      \\
      \mat{0} & \vec{0} & \mat{B}_{ie}^{\text{constant}} &
      \mat{B}_{ii}^{\text{constant}} & \vec{0}
      \\
      \vec{0} & 0 & \vec{0} & \vec{b}_{Ri}^{\text{constant}} &
      b_{RR}^{\text{constant}}
    \end{bmatrix},
  \end{split}
\end{equation}
\begin{equation}
  \begin{split}
    \vec{a}_{mR}^{\text{birth}} &=
    \begin{bmatrix}
      - \frac{1}{2} \\ 0 \\ \vdots \\ 0
    \end{bmatrix},
    \\
    \vec{b}_{mR}^{\text{birth}} &=
    \begin{bmatrix}
      \frac{1}{2} \\ 0 \\ \vdots \\ 0
    \end{bmatrix},
    \\
    \vec{a}_{Sm}^{\text{birth}} &=
    - \frac{\Delta t}{2} \vec{v},
    \\
    \vec{b}_{Sm}^{\text{birth}} &=
    \frac{\Delta t}{2} \vec{v},
    \\
    a_{SS}^{\text{birth}} &=
    - \frac{\Delta t}{2},
    \\
    b_{SS}^{\text{birth}} &=
    \frac{\Delta t}{2},
    \\
    \vec{a}_{Se}^{\text{birth}} &= - \frac{\Delta t}{2} \vec{v},
    \\
    \vec{b}_{Se}^{\text{birth}} &= \frac{\Delta t}{2} \vec{v},
    \\
    \vec{a}_{Si}^{\text{birth}} &= - \frac{\Delta t}{2} \vec{v},
    \\
    \vec{b}_{Si}^{\text{birth}} &= \frac{\Delta t}{2} \vec{v},
  \end{split}
\end{equation}
\begin{equation}
  \begin{split}
    \mat{A}^{\text{birth}} &=
    \begin{bmatrix}
      \mat{0} & \vec{0} & \mat{0} & \mat{0} & \vec{a}_{mR}^{\text{birth}}
      \\
      \vec{a}_{Sm}^{\text{birth}} & a_{SS}^{\text{birth}} &
      \vec{a}_{Se}^{\text{birth}} & \vec{a}_{Si}^{\text{birth}} & 0
      \\
      \mat{0} & \vec{0} & \mat{0} & \mat{0} & \vec{0}
      \\
      \mat{0} & \vec{0} & \mat{0} & \mat{0} & \vec{0}
      \\
      \vec{0} & 0 & \vec{0} & \vec{0} & 0
    \end{bmatrix},
    \\
    \mat{B}^{\text{birth}} &=
    \begin{bmatrix}
      \mat{0} & \vec{0} & \mat{0} & \mat{0} & \vec{b}_{mR}^{\text{birth}}
      \\
      \vec{b}_{Sm}^{\text{birth}} & b_{SS}^{\text{birth}} &
      \vec{b}_{Se}^{\text{birth}} & \vec{b}_{Si}^{\text{birth}} & 0
      \\
      \mat{0} & \vec{0} & \mat{0} & \mat{0} & \vec{0}
      \\
      \mat{0} & \vec{0} & \mat{0} & \mat{0} & \vec{0}
      \\
      \vec{0} & 0 & \vec{0} & \vec{0} & 0
    \end{bmatrix},
  \end{split}
\end{equation}
\begin{equation}
  \begin{split}
    a_{SS}^{\text{infection}} &=
    \frac{\Delta t}{2},
    \\
    b_{SS}^{\text{infection}} &=
    - \frac{\Delta t}{2},
    \\
    \vec{a}_{eS}^{\text{infection}} &=
    \begin{bmatrix}
      - \frac{1}{2} \\ 0 \\ \vdots \\ 0
    \end{bmatrix},
    \\
    \vec{b}_{eS}^{\text{infection}} &=
    \begin{bmatrix}
      \frac{1}{2} \\ 0 \\ \vdots \\ 0
    \end{bmatrix},
  \end{split}
\end{equation}
\begin{equation}
  \begin{split}
    \mat{A}^{\text{infection}} &=
    \begin{bmatrix}
      \mat{0} & \vec{0} & \mat{0} & \mat{0} & \vec{0}
      \\
      \vec{0} & a_{SS}^{\text{infection}} & \vec{0} & \vec{0} & 0
      \\
      \mat{0} & \vec{a}_{eS}^{\text{infection}} & \mat{0} & \mat{0} & \vec{0}
      \\
      \mat{0} & \vec{0} & \mat{0} & \mat{0} & \vec{0}
      \\
      \vec{0} & 0 & \vec{0} & \vec{0} & 0
    \end{bmatrix},
    \\
    \mat{B}^{\text{infection}} &=
    \begin{bmatrix}
      \mat{0} & \vec{0} & \mat{0} & \mat{0} & \vec{0}
      \\
      \vec{0} & b_{SS}^{\text{infection}} & \vec{0} & \vec{0} & 0
      \\
      \mat{0} & \vec{b}_{eS}^{\text{infection}} & \mat{0} & \mat{0} & \vec{0}
      \\
      \mat{0} & \vec{0} & \mat{0} & \mat{0} & \vec{0}
      \\
      \vec{0} & 0 & \vec{0} & \vec{0} & 0
    \end{bmatrix},
  \end{split}
\end{equation}
\begin{equation}
  \begin{split}
    \mat{A}^k &=
    \mat{A}^{\text{constant}}
    + b(t^{k - 1 / 2}) \mat{A}^{\text{birth}},
    \\
    \vec{c}^k &=
    \left[
      \mat{B}^{\text{constant}}
      + b(t^{k - 1 / 2}) \mat{B}^{\text{birth}}
      + \vec{\beta} \vec{x}^{k - 1} \mat{B}^{\text{infection}}
    \right] \vec{x}^{k - 1}.
  \end{split}
\end{equation}
Then, for each $k \in \{1, 2, \ldots, K - 1\}$,
we use a nonlinear solver to find $\vec{x}^k$ that satisfies
\begin{equation}
  \left[
    \mat{A}^k
    + \vec{\beta} \vec{x}^k \mat{A}^{\text{infection}}
  \right] \vec{x}^k
  - \vec{c}^k
  = \vec{0}.
\end{equation}


\section{Age-structured model}

The model is
\begin{equation}
  \label{model_age_structured}
  \begin{split}
    M(t, 0)
    &= b(t) \int_0^{+\infty} \nu(a) R(t, a) \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    M(t, a)
    &= - \omega M(t, a) - \mu(a) M(t, a),
    \\
    S(t, 0)
    &= b(t) \int_0^{+\infty} \nu(a) \left[N(t, a) - R(t, a)\right] \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    S(t, a)
    &= \omega M(t, a) - \lambda(t) S(t, a) - \mu(a) S(t, a),
    \\
    E(t, 0)
    &= 0,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    E(t, a)
    &= \lambda(t) S(t, a) - \rho E(t, a) - \mu(a) E(t, a),
    \\
    I(t, 0)
    &= 0,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    I(t, a)
    &= \rho E(t, a) - \gamma I(t, a) - \mu(a) I(t, a),
    \\
    R(t, 0)
    &= 0,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    R(t, a)
    &= \gamma I(t, a) - \mu(a) R(t, a),
  \end{split}
\end{equation}
with force of infection
\begin{equation}
  \lambda(t) = \beta \int_0^{+\infty} I(t, a) \md a
\end{equation}
and population size
\begin{equation}
  N(t, a) = M(t, a) + S(t, a) + E(t, a) + I(t, a) + R(t, a).
\end{equation}


\subsection{Total population}

The total population follows the linear PDE
\begin{equation}
  \begin{split}
    N(t, 0)
    &= b(t) \int_0^{+\infty} \nu(a) N(t, a) \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    N(t, a)
    &= - \mu(a) N(t, a).
  \end{split}
\end{equation}

Because $b(t)$ is periodic with period $T = \unit[1]{y}$, we used
Floquet theory \autocite{parker_1992} to find the stable age
distribution and the asymptotic population growth rate. Floquet theory
requires the fundamental solution $\Phi(t, a, a')$ to
\begin{equation}
  \begin{split}
    \Phi(t, 0, a')
    &= b(t) \int_0^{+\infty} \nu(a) \Phi(t, a, a') \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    \Phi(t, a, a')
    &= - \mu(a) \Phi(t, a, a'),
    \\
    \Phi(t_0, a, a')
    &= \delta(a - a'),
  \end{split}
\end{equation}
where $\delta(x)$ is the Dirac delta.

To numerically solve the PDE for the fundamental solution, we used the
Crank--Nicolson method on characteristics and the composite trapezoid
rule for the birth integral \autocite{milner_1992}.  Given the time
step $\Delta t$, let $a_i = i \Delta t$ and $a'_j = j \Delta t$ for
$i, j \in \{0, 1, 2, \ldots, I - 1\}$;
$t^k = t_0 + k \Delta t$ for $k \in \{0, 1, \ldots, K - 1\}$;
and $\Phi_{i, j}^k \approx \Phi(t^k, a_i, a'_j)$.
For each $j$ and each $k \geq 1$, the Crank--Nicolson method on
characteristics is
\begin{equation}
  \label{CN_step}
  \frac{\Phi_{i, j}^k - \Phi_{i - 1, j}^{k - 1}}{\Delta t}
  = - \mu(a_{i - 1 / 2})
  \frac{\Phi_{i, j}^k + \Phi_{i - 1, j}^{k - 1}}{2},
\end{equation}
or
\begin{equation}
  \Phi_{i, j}^k
  = \frac{1 - C_{i - 1 / 2}}{1 + C_{i - 1 / 2}}
  \Phi_{i - 1, j}^{k - 1},
\end{equation}
with
\begin{equation}
  C_{i - 1 / 2}
  = \frac{1}{2} \mu(a_{i - 1 / 2}) \Delta t,
\end{equation}
for $i \in \{1, 2, \ldots, I - 2\}$.  For $i = I - 1$,
a term was added to prevent aging out of this
last age group:
\begin{equation}
  \Phi_{I - 1, j}^k
  = \frac{1 - C_{I - 3 / 2}}{1 + C_{I - 3 / 2}}
  \Phi_{I - 2, j}^{k - 1}
  + \frac{1 - C_{I - 1}}{1 + C_{I - 1}}
  \Phi_{I - 1, j}^{k - 1},
\end{equation}
with
\begin{equation}
  C_{I - 1}
  = \frac{1}{2} \mu(a_{I - 1}) \Delta t.
\end{equation}
For $i = 0$, the birth integral is given by the composite trapezoid rule,
\begin{equation}
  \label{birth_step}
  \Phi_{0, j}^k =
  b(t^k)
  \sum_{i = 1}^{I - 1}
  \frac{m(a_i) \Phi_{i, j}^k
    + m(a_{i - 1}) \Phi_{i - 1, j}^k}{2}
  \Delta t,
\end{equation}
or
\begin{equation}
  \mat{\Phi}_0^k = b(t^k) \vec{v} \mat{\Phi}^k,
\end{equation}
with the vector $\vec{v} = [v_i]$ for
\begin{equation}
  v_i =
  \begin{cases}
    \frac{1}{2} m(a_i) \Delta t
    & \text{if $i = 0$ or $i = I - 1$}, \\
    m(a_i) \Delta t
    & \text{otherwise}.
  \end{cases}
\end{equation}
The initial condition is
\begin{equation}
  \Phi_{i, j}^0 =
  \begin{cases}
    1 & \text{if $i = j$}, \\
    0 & \text{otherwise}.
  \end{cases}
\end{equation}
Considering $\mat{\Phi}^k = [\Phi_{i, j}^k]$ as a matrix that
evolves in time, the method is easily implemented with matrix algebra:
the Crank--Nicolson step \eqref{CN_step} is
\begin{equation}
  \mat{\Phi}^k = \mat{M} \mat{\Phi}^{k - 1},
\end{equation}
with the matrix $\mat{M} = [M_{i, j}]$ where
\begin{equation}
  M_{i, j} =
  \begin{cases}
    \frac{1 - C_{i - 1 / 2}}{1 + C_{i - 1 / 2}}
    & \text{if $i = j + 1$}, \\
    \frac{1 - C_{I - 1}}{1 + C_{I - 1}} & \text{if $i = j = I - 1$}, \\
    0 & \text{otherwise}.
  \end{cases}
\end{equation}
The initial condition is
\begin{equation}
  \mat{\Phi}^0 = \mat{I},
\end{equation}
where $\mat{I}$ is the $I \times I$ identity matrix.

Using this numerical scheme, we solved for the monodromy matrix, the
fundamental solution after one period:
\begin{equation}
  \mat{\Psi} = [\Psi_{i, j}] \approx [\Phi(t_0 + T, a_i, a'_j)].
\end{equation}
The monodromy matrix projects the population forward at by one period,
\begin{equation}
  \vec{n}(t_0 + T) = \mat{\Psi} \vec{n}(t_0),
\end{equation}
where $\vec{n}(t) = [N(t, a_i)]$.
Using the monodromy matrix to repeatedly project the population
forward gives
\begin{equation}
  \vec{n}(t_0 + K T)
  = \mat{\Psi}^K \vec{n}(t_0)
  \to \rho_0^K \vec{w}_0
  = \me^{r K T} \vec{w}_0
\end{equation}
as $K \to +\infty$,
where $\rho_0$ is the dominant eigenvalue, i.e.~the eigenvalue with
largest magnitude, of $\mat{\Psi}$;
the corresponding right eigenvector $\vec{w}_0$ is the stable age
distribution; and
\begin{equation}
  r = \frac{1}{T} \log \rho_0
\end{equation}
is the asymptotic population growth rate.

We used a nonlinear solver to search for the mean birth rate $\bar{b}$
that gives population growth rate $r = 0$.


\subsection{Numerical method}


\section{Age- and time-since-entry-structured model}

The model is
\begin{equation}
  \label{model_age_and_time_since_entry_structured}
  \begin{split}
    M(t, 0) &=
    b(t) \int_0^{+\infty} \nu(a) R(t, a) \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    M(t, a) &=
    - \omega(a) M(t, a) - \mu(a) M(t, a),
    \\
    S(t, 0) &=
    b(t) \int_0^{+\infty} \nu(a) \left[N(t, a) - R(t, a)\right] \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    S(t, a) &=
    \omega(a) M(t, a) - \lambda(t) S(t, a) - \mu(a) S(t, a),
    \\
    e(t, 0, 0) &=
    \lambda(t) S(t, 0)
    \text{ [or $0$?]},
    \\
    e(t, 0, z) &=
    0,
    \\
    e(t, a, 0) &=
    \lambda(t) S(t, a),
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}
      + \frac{\partial}{\partial z}\right)
    e(t, a, z) &=
    - \rho(z) e(t, a, z) - \mu(a) e(t, a, z),
    \\
    i(t, 0, 0) &=
    0,
    \\
    i(t, 0, z) &=
    0,
    \\
    i(t, a, 0) &=
    \int_0^{+\infty} \rho(z) e(t, a, z) \md z,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}
      + \frac{\partial}{\partial z}\right)
    i(t, a, z) &=
    - \gamma(z) i(t, a, z) - \mu(a) i(t, a, z),
    \\
    R(t, 0) &=
    0,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    R(t, a) &=
    \int_0^{+\infty} \gamma(z) i(t, a, z) \md z
    - \mu(a) R(t, a),
  \end{split}
\end{equation}
with force of infection
\begin{equation}
  \lambda(t) =
  \beta
  \int_0^{+\infty} \int_0^{+\infty}
  i(t, a, z)
  \md a \md z
\end{equation}
and population size
\begin{equation}
  N(t, a) =
  M(t, a) + S(t, a) + R(t, a)
  + \int_0^{+\infty} e(t, a, z) + i(t, a, z) \md z.
\end{equation}


\subsection{Total population}

The total population follows the linear PDE
\begin{equation}
  \begin{split}
    N(t, 0) &=
    b(t) \int_0^{+\infty} \nu(a) N(t, a) \md a,
    \\
    \left(\frac{\partial}{\partial t}
      + \frac{\partial}{\partial a}\right)
    N(t, a) &=
    - \mu(a) N(t, a).
  \end{split}
\end{equation}
This is the same PDE for total population as in the age-structured
model: as we did for that model, we used Floquet theory and a
nonlinear solver to find the value of the mean birth rate $\bar{b}$
that gives population growth rate $r = 0$.


\subsection{Numerical method}


\printbibliography

\end{document}
